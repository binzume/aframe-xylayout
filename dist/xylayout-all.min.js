"use strict";if("undefined"==typeof AFRAME)throw"AFRAME is not loaded.";AFRAME.registerComponent("xycontainer",{dependencies:["xyrect"],schema:{spacing:{type:"number",default:.05},padding:{type:"number",default:0},reverse:{type:"boolean",default:!1},wrap:{default:"nowrap",oneOf:["wrap","nowrap"]},direction:{default:"vertical",oneOf:["none","row","column","vertical","horizontal"]},alignItems:{default:"none",oneOf:["none","center","start","end","baseline","stretch"]},justifyItems:{default:"start",oneOf:["center","start","end","space-between","space-around","stretch"]}},init(){this.el.addEventListener("xyresize",t=>{this._doLayout(t.detail.xyrect.width,t.detail.xyrect.height)}),this.requestLayoutUpdate()},_doLayout(t,e){if("none"===this.data.direction)return;let i=this.el.children,s="vertical"===this.data.direction||"column"===this.data.direction,a=this.data.reverse^s?-1:1,l=s?[0,1,a,0]:[a,0,0,-1],n=this.el.components.xyrect,o=[(s?e:t)-2*this.data.padding,(s?t:e)-2*this.data.padding],h=[],r=0,d=0,c=0,u=0,p=0,m=[];for(var g=0;g<i.length;g++){let t=i[g],e=t.components.xyitem;if(e&&e.data.fixed)continue;let a=t.components.xyrect||{width:1*t.getAttribute("width"),height:1*t.getAttribute("height")},l=t.getAttribute("scale")||{x:1,y:1},n=s?{el:t,sizeMain:a.height,sizeCross:a.width,pivotMain:a.data?a.data.pivotY:.5,pivotCross:a.data?a.data.pivotX:.5,scaleMain:l.y,scaleCross:l.x}:{el:t,sizeMain:a.width,sizeCross:a.height,pivotMain:a.data?a.data.pivotX:.5,pivotCross:a.data?a.data.pivotY:.5,scaleMain:l.x,scaleCross:l.y};if(void 0===n.sizeMain||isNaN(n.sizeMain))continue;let y=r+n.sizeMain*n.scaleMain+this.data.spacing*(h.length-1);"wrap"==this.data.wrap&&r>0&&y>o[0]&&(m.push({targets:h,sizeSum:r,growSum:d,shrinkSum:c,crossSize:u}),p+=u,h=[],r=0,d=0,c=0,u=0),h.push(n),r+=n.sizeMain*n.scaleMain,d+=e?e.data.grow:1,c+=e?e.data.shrink:1,u=n.sizeCross>u?n.sizeCross:u}if(h.length>0&&(m.push({targets:h,sizeSum:r,growSum:d,shrinkSum:c,crossSize:u}),p+=u),0==m.length)return;p+=this.data.spacing*(m.length-1);let y=-(s?n.data.pivotX:n.data.pivotY)*o[1],b=0,x=(s?(n.data.pivotY-1)*e:-n.data.pivotX*t)+this.data.padding;"end"==this.data.alignItems?y+=o[1]-p:"center"==this.data.alignItems?y+=(o[1]-p)/2:"stretch"!=this.data.alignItems&&"none"!=this.data.alignItems||(b=(o[1]-p)/m.length),m.forEach(t=>{o[1]=t.crossSize+b,this._layoutLine(t.targets,t.sizeSum,t.growSum,t.shrinkSum,o,x,y,l),y+=o[1]+this.data.spacing})},_layoutLine(t,e,i,s,a,l,n,o){let h=0!=o[1]?"height":"width",r=0!=o[1]?"width":"height",d=this.data.spacing,c=0;"center"===this.data.justifyItems?l+=(a[0]-e-d*t.length)/2:"end"===this.data.justifyItems?l+=a[0]-e-d*t.length:"stretch"===this.data.justifyItems?c=(c=a[0]-e-d*(t.length-1))>0?i>0?c/i:0:s>0?c/s:0:"space-between"===this.data.justifyItems?d=(a[0]-e)/(t.length-1):"space-around"===this.data.justifyItems&&(l+=.5*(d=(a[0]-e)/t.length));for(var u=0;u<t.length;u++){let e=t[u],i=e.el,s=i.components.xyitem,p=s&&s.data.align||this.data.alignItems,m=(s?c>0?s.data.grow:s.data.shrink:1)*c,g=e.sizeMain*e.scaleMain+m,y=e.sizeCross;e.scaleMain>0&&0!=m&&i.setAttribute(h,e.sizeMain+m/e.scaleMain),e.scaleCross>0&&"stretch"===p&&(y=a[1],i.setAttribute(r,y/e.scaleCross));let b=i.getAttribute("position")||{x:0,y:0,z:0},x=l+e.pivotMain*g,w=n+.5*a[1];"start"===p||"stretch"===p?w=n+e.pivotCross*y:"end"===p?w=n+a[1]-(1-e.pivotCross)*y:"center"===p?w+=(e.pivotCross-.5)*y:"none"===p&&(w+=o[1]*b.x+o[3]*b.y),b.x=o[0]*x+o[1]*w,b.y=o[2]*x+o[3]*w,i.setAttribute("position",b),l+=g+d}},requestLayoutUpdate(){let t=this.el.components.xyrect;this.data&&this._doLayout(t.width,t.height)}}),AFRAME.registerComponent("xyitem",{schema:{align:{type:"string",default:"none",oneOf:["none","center","start","end","baseline","stretch"]},grow:{type:"number",default:1},shrink:{type:"number",default:1},fixed:{type:"boolean",default:!1}},update(t){void 0!==t.align&&this.el.parent.components.xycontainer&&this.el.parent.components.xycontainer.requestLayoutUpdate()}}),AFRAME.registerComponent("xyrect",{dependencies:["position"],schema:{width:{type:"number",default:-1},height:{type:"number",default:-1},pivotX:{type:"number",default:.5},pivotY:{type:"number",default:.5}},init(){this.height=0,this.width=0},update(t){(this.el.components.rounded||"A-INPUT"==this.el.tagName)&&(this.data.pivotX=0,this.data.pivotY=1),this.data.width>=0?this.width=this.data.width:this.el.hasAttribute("width")&&(this.width=1*this.el.getAttribute("width")),this.data.height>=0?this.height=this.data.height:this.el.hasAttribute("height")&&(this.height=1*this.el.getAttribute("height")),void 0!==t.width&&this.el.dispatchEvent(new CustomEvent("xyresize",{detail:{xyrect:this}}))}}),AFRAME.registerComponent("xyclipping",{dependencies:["xyrect"],schema:{exclude:{type:"selector",default:null},clipTop:{type:"boolean",default:!0},clipBottom:{type:"boolean",default:!0},clipLeft:{type:"boolean",default:!1},clipRight:{type:"boolean",default:!1}},init(){this.el.sceneEl.renderer.localClippingEnabled=!0,this.clippingPlanesLocal=[],this.clippingPlanes=[],this.exclude=this.data.exclude,this.currentMatrix=null,this.el.classList.add("clickable"),this._filterEvent=this._filterEvent.bind(this),this.filterTargets=["click","mousedown","mouseenter","mouseleave","mousemove"],this.filterTargets.forEach(t=>this.el.addEventListener(t,this._filterEvent,!0))},update(){this.clippingPlanes=[],this.clippingPlanesLocal=[];let t=this.el.components.xyrect;this.data.clipBottom&&this.clippingPlanesLocal.push(new THREE.Plane(new THREE.Vector3(0,1,0),0)),this.data.clipTop&&this.clippingPlanesLocal.push(new THREE.Plane(new THREE.Vector3(0,-1,0),t.height)),this.data.clipLeft&&this.clippingPlanesLocal.push(new THREE.Plane(new THREE.Vector3(1,0,0),0)),this.data.clipRight&&this.clippingPlanesLocal.push(new THREE.Plane(new THREE.Vector3(-1,0,0),t.width)),this.updateMatrix()},remove(){this.filterTargets.forEach(t=>this.el.removeEventListener(t,this._filterEvent,!0)),this.clippingPlanes=[],this.applyClippings()},tick(){this.el.object3D.matrixWorld.equals(this.currentMatrix)||this.updateMatrix()},_filterEvent(t){if(!(t.path||t.composedPath()).includes(this.data.exclude)&&t.detail.intersection&&this.isClipped(t.detail.intersection.point)&&(t.stopPropagation(),t.detail.cursorEl&&t.detail.cursorEl.components.raycaster)){let e=t.detail.cursorEl.components.raycaster.intersectedEls,i=e.lastIndexOf(t.target);i>=0&&i+1<e.length&&e[i+1].dispatchEvent(new CustomEvent(t.type,t))}},updateMatrix(){this.currentMatrix=this.el.object3D.matrixWorld.clone();for(var t=0;t<this.clippingPlanesLocal.length;t++)this.clippingPlanes[t]=this.clippingPlanesLocal[t].clone().applyMatrix4(this.currentMatrix);this.applyClippings()},applyClippings(){let t=this.exclude.object3D,e=i=>{if(i!==t){i.material&&void 0!==i.material.clippingPlanes&&(i.material.clippingPlanes=this.clippingPlanes);for(var s=0;s<i.children.length;s++)e(i.children[s])}};e(this.el.object3D)},isClipped(t){return this.clippingPlanes.some(e=>e.distanceToPoint(t)<0)}}),function(){let t={defaultComponents:{xyrect:{},xycontainer:{}},mappings:{width:"xyrect.width",height:"xyrect.height",direction:"xycontainer.direction",spacing:"xycontainer.spacing",padding:"xycontainer.padding",reverse:"xycontainer.reverse",wrap:"xycontainer.wrap","align-items":"xycontainer.alignItems","justify-items":"xycontainer.justifyItems"}};AFRAME.registerPrimitive("a-xycontainer",t),AFRAME.registerPrimitive("a-xylayout",t)}(),AFRAME.registerGeometry("xy-rounded-rect",{schema:{height:{default:1,min:0},width:{default:1,min:0},radius:{default:.05,min:0}},init(t){let e=new THREE.Shape,i=t.radius,s=t.width||.01,a=t.height||.01,l=-s/2,n=-a/2;e.moveTo(l,n+i),e.lineTo(l,n+a-i),e.quadraticCurveTo(l,n+a,l+i,n+a),e.lineTo(l+s-i,n+a),e.quadraticCurveTo(l+s,n+a,l+s,n+a-i),e.lineTo(l+s,n+i),e.quadraticCurveTo(l+s,n,l+s-i,n),e.lineTo(l+i,n),e.quadraticCurveTo(l,n,l,n+i),this.geometry=new THREE.ShapeGeometry(e)}}),AFRAME.registerComponent("xylabel",{schema:{width:{type:"number",default:0},height:{type:"number",default:0},resolution:{type:"number",default:32},renderingMode:{default:"auto",oneOf:["auto","canvas"]},wrapCount:{type:"number",default:0},zOffset:{type:"number",default:0},value:{default:""},color:{default:"white"},align:{default:"left"}},update(){let t=this.data.wrapCount;if(0==t){let e=this.data.height||(this.el.components.geometry?this.el.components.geometry.data.height:1),i=this.data.width||(this.el.components.geometry?this.el.components.geometry.data.width:1);e>0&&(t=Math.max(i/e/.65,this.data.value.length)+1)}if("auto"==this.data.renderingMode&&!/[\u0100-\uDFFF]/.test(this.data.value)){let e=Object.assign({},this.data);delete e.resolution,delete e.renderingMode,e.wrapCount=t,this.el.setAttribute("text",e);let i=this.el.getObject3D("text");return i&&(i.raycast=function(){}),void this.remove()}this.el.hasAttribute("text")&&this.el.removeAttribute("text");let e=Math.floor(this.data.resolution*(.65*t)),i=Math.floor(this.data.resolution);if(!this.canvas||this.canvas.width!==e||this.canvas.height!==i){null==this.canvas&&(this.canvas=document.createElement("canvas")),this.canvas.height=i,this.canvas.width=e;let s=this.data.width||(this.el.components.geometry?this.el.components.geometry.data.width:1),a=this.data.height||s/(.65*t),l=new THREE.CanvasTexture(this.canvas);l.anisotropy=4;let n=new THREE.MeshBasicMaterial({map:l,transparent:!0});this._removeObject3d(),this.el.setObject3D("xylabel",new THREE.Mesh(new THREE.PlaneGeometry(s,a),n)),this.el.object3DMap.xylabel.position.copy(new THREE.Vector3(0,0,this.data.zOffset))}let s=this.canvas.getContext("2d");s.clearRect(0,0,e,i),s.font=.9*this.data.resolution+"px bold sans-serif",s.textBaseline="top",s.textAlign=this.data.align,s.fillStyle=this.data.color;let a="center"===this.data.align?e/2:0;s.fillText(this.data.value,a,.05*this.data.resolution),this.el.object3DMap.xylabel.material.map.needsUpdate=!0},remove(){this.canvas=null,this._removeObject3d()},_removeObject3d(){this.el.object3DMap.xylabel&&(this.el.object3DMap.xylabel.material.map.dispose(),this.el.object3DMap.xylabel.material.dispose(),this.el.object3DMap.xylabel.geometry.dispose(),this.el.removeObject3D("xylabel"))}}),AFRAME.registerComponent("xy-draggable",{schema:{dragThreshold:{default:.02},preventClick:{default:!0},base:{type:"selector",default:null}},init(){this.el.classList.add(this.el.sceneEl.systems.xywindow.theme.collidableClass),this._onmousedown=this._onmousedown.bind(this),this.el.addEventListener("mousedown",this._onmousedown),this.dragFun=null},remove(){this.el.removeEventListener("mousedown",this._onmousedown)},tick(){null!==this.dragFun?this.dragFun("xy-drag"):this.pause()},_onmousedown(t){if(!t.detail.cursorEl||!t.detail.cursorEl.components.raycaster)return;let e=this.data.base||this.el,i=t.detail.cursorEl,s=i.components.raycaster.raycaster,a=new THREE.Plane(new THREE.Vector3(0,0,-1),0).applyMatrix4(e.object3D.matrixWorld),l=s.ray.direction.clone(),n=!1,o=new THREE.Vector3;null===s.ray.intersectPlane(a,o)&&e.object3D.worldToLocal(o);let h=s.ray.clone(),r=t=>{if(!n){if(l.manhattanDistanceTo(s.ray.direction)<this.data.dragThreshold)return;t="xy-dragstart",n=!0}let r=o.clone();null!==s.ray.intersectPlane(a,o)&&e.object3D.worldToLocal(o),this.el.emit(t,{raycaster:s,point:o,prevPoint:r,prevRay:h,cursorEl:i}),h.copy(s.ray)},d=this;this.dragFun=r,d.play();let c=e=>e.target!=t.target&&e.stopPropagation();window.addEventListener("mouseenter",c,!0),window.addEventListener("mouseleave",c,!0),window.addEventListener("mouseup",function t(e){if(e.detail.cursorEl==i&&(window.removeEventListener("mouseup",t),window.removeEventListener("mouseenter",c,!0),window.removeEventListener("mouseleave",c,!0),d.dragFun=null,n)){if(d.data.preventClick){let t=t=>t.stopPropagation();window.addEventListener("click",t,!0),setTimeout(()=>window.removeEventListener("click",t,!0),0)}setTimeout(()=>r("xy-dragend"),15)}})}}),AFRAME.registerComponent("xy-drag-control",{schema:{target:{type:"selector",default:null},draggable:{type:"string",default:""},autoRotate:{default:!1},mode:{type:"string",default:"grab"}},init(){this._ondrag=this._ondrag.bind(this),this.draggable=[]},update(t){this.target=this.data.target||this.el,this.data.draggable!==t.draggable&&(this.remove(),this.draggable=Array.isArray(this.data.draggable)?this.data.draggable:""!=this.data.draggable?this.el.querySelectorAll(this.data.draggable):[this.el],this.draggable.forEach(t=>{t.setAttribute("xy-draggable",{}),t.addEventListener("xy-dragstart",this._ondrag),t.addEventListener("xy-drag",this._ondrag)}))},remove(){this.draggable.forEach(t=>{t.removeAttribute("xy-draggable"),t.removeEventListener("xy-dragstart",this._ondrag),t.removeEventListener("xy-drag",this._ondrag)})},_ondrag(t){let e,i=t.detail.raycaster.ray.direction,s=t.detail.prevRay.direction;t.detail.cursorEl.components["tracked-controls"]?(e="xy-dragstart"==t.type?new THREE.Quaternion:this.prevQ.inverse().premultiply(t.detail.cursorEl.object3D.quaternion),this.prevQ=t.detail.cursorEl.object3D.quaternion.clone()):e=(new THREE.Quaternion).setFromUnitVectors(s,i);let a=(new THREE.Matrix4).makeRotationFromQuaternion(e),l=t.detail.prevRay.origin,n=t.detail.raycaster.ray.origin,o=new THREE.Matrix4;if(a.multiply(o.makeTranslation(-l.x,-l.y,-l.z)),a.premultiply(o.makeTranslation(n.x,n.y,n.z)),this.target.object3D.applyMatrix(a),"pull"==this.data.mode){let e=this.target.object3D.getWorldPosition(new THREE.Vector3),a=i.clone().sub(s),l=2*e.distanceTo(t.detail.raycaster.ray.origin);this.target.object3D.position.add(i.clone().multiplyScalar(-a.y*l))}if(this.data.autoRotate){let e=this.el.sceneEl.camera.getWorldPosition(new THREE.Vector3),i=this.target.object3D.getWorldPosition(new THREE.Vector3),s=e.clone().sub(i).normalize(),a=.8-s.y*s.y;if(a>0){let s=(new THREE.Matrix4).lookAt(e,i,new THREE.Vector3(0,1,0)),l=(new THREE.Quaternion).setFromRotationMatrix(s),n=t.detail.cursorEl.components.raycaster.getIntersection(t.target),o=n?n.point:i,h=this.target.object3D.parent.worldToLocal(o),r=this.target.object3D.quaternion.clone();THREE.Quaternion.slerp(this.target.object3D.quaternion,l,this.target.object3D.quaternion,.1*a),this.target.object3D.position.sub(h).applyQuaternion(r.inverse().premultiply(this.target.object3D.quaternion)).add(h)}}}}),AFRAME.registerComponent("xywindow",{dependencies:["xycontainer"],schema:{title:{type:"string",default:""},closable:{type:"bool",default:!0}},init(){this.theme=this.system.theme,this.controls=document.createElement("a-entity"),this.controls.setAttribute("position",{x:0,y:0,z:.05}),this.el.appendChild(this.controls);let t=this.system.createSimpleButton({width:1,height:.5,color:this.theme.windowTitleBarColor},this.controls);if(t.setAttribute("xy-drag-control",{target:this.el,autoRotate:!0}),this.dragButton=t,this.data.closable){let t=this.system.createSimpleButton({width:.5,height:.5,color:this.theme.windowTitleBarColor,hoverColor:this.theme.windowCloseButtonColor,text:" X"},this.controls);t.addEventListener("click",t=>{this.data.closable&&this.el.parentNode.removeChild(this.el)}),this.closeButton=t}this.titleText=document.createElement("a-entity"),this.controls.appendChild(this.titleText),this.el.addEventListener("xyresize",t=>{this.update({})}),this.system.registerWindow(this)},remove(){this.system.unregisterWindow(this)},update(t){let e=0;if(this.closeButton&&(this.closeButton.setAttribute("position",{x:this.el.components.xyrect.width/2-.25,y:.3,z:0}),e+=.52),this.data.title!=t.title){let t=this.el.components.xyrect.width-e-.2;this.titleText.setAttribute("xylabel",{value:this.data.title,wrapCount:Math.max(10,t/.2),width:t,color:this.theme.windowTitleColor})}this.controls.setAttribute("position","y",.5*this.el.components.xyrect.height),this.dragButton.setAttribute("geometry","width",this.el.components.xyrect.width-e),this.dragButton.setAttribute("position",{x:-e/2,y:.3,z:0}),this.titleText.setAttribute("position",{x:-e/2+.1,y:.3,z:.02})},setTitle(t){this.titleText.setAttribute("xylabel","value",t)}}),AFRAME.registerSystem("xywindow",{theme:{buttonColor:"#222",buttonHoverColor:"#333",buttonLabelColor:"#fff",buttonHoverHaptic:.3,buttonHoverHapticMs:10,buttonGeometry:"xy-rounded-rect",windowCloseButtonColor:"#f00",windowTitleBarColor:"#111",windowTitleColor:"#fff",collidableClass:"collidable"},windows:[],createSimpleButton(t,e,i){t.color=t.color||this.theme.buttonColor,t.hoverColor=t.hoverColor||this.theme.buttonHoverColor,t.labelColor=t.labelColor||this.theme.buttonLabelColor;let s=t.geometry||this.theme.buttonGeometry,a=i||document.createElement("a-entity");return a.classList.add(this.theme.collidableClass),a.addEventListener("mouseenter",e=>{if(a.setAttribute("material",{color:t.hoverColor}),this.theme.buttonHoverHaptic&&e.detail.cursorEl.components["tracked-controls"]){let t=e.detail.cursorEl.components["tracked-controls"].controller;t&&t.hapticActuators&&t.hapticActuators.length>0&&t.hapticActuators[0].pulse(this.theme.buttonHoverHaptic,this.theme.buttonHoverHapticMs)}}),a.addEventListener("mouseleave",e=>{a.setAttribute("material",{color:t.color})}),a.setAttribute("geometry",{primitive:s,width:t.width,height:t.height}),a.setAttribute("material",{color:t.color}),null!=t.text&&a.setAttribute("xylabel",{value:t.text,zOffset:.01,align:"center",color:t.labelColor}),e&&e.appendChild(a),a},registerWindow(t){this.windows.push(t)},unregisterWindow(t){let e=this.windows.indexOf(t);e>=0&&this.windows.splice(e,1)}}),AFRAME.registerComponent("xybutton",{dependencies:["xyrect"],schema:{label:{type:"string",default:""},labelColor:{type:"string",default:""},color:{type:"string",default:""},hoverColor:{type:"string",default:""}},init(){this.el.sceneEl.systems.xywindow.createSimpleButton({width:this.el.components.xyrect.width,height:this.el.components.xyrect.height,color:this.data.color,hoverColor:this.data.hoverColor,labelColor:this.data.labelColor,text:this.data.label},null,this.el),this.el.addEventListener("xyresize",t=>{this.el.setAttribute("geometry",{width:t.detail.xyrect.width,height:t.detail.xyrect.height}),this.el.setAttribute("xylabel",{width:t.detail.xyrect.width,height:t.detail.xyrect.height})})},update(t){void 0!==t.label&&this.el.setAttribute("xylabel",{value:this.data.label,color:this.data.labelColor})}}),AFRAME.registerComponent("xyrange",{dependencies:["xyrect"],schema:{min:{type:"number",default:0},max:{type:"number",default:100},step:{type:"number",default:0},value:{type:"number",default:0},thumbSize:{type:"number",default:.4}},init(){this.value=this.data.value,this.bar=document.createElement("a-entity"),this.bar.setAttribute("geometry",{primitive:"plane",width:this.el.components.xyrect.width-this.data.thumbSize,height:.05}),this.bar.setAttribute("material",{color:"#fff"}),this.el.appendChild(this.bar),this.dragging=!1,this.thumb=this.el.sceneEl.systems.xywindow.createSimpleButton({width:this.data.thumbSize,height:this.data.thumbSize},this.el),this.thumb.setAttribute("xy-draggable",{base:this.el}),this.thumb.addEventListener("xy-drag",t=>{this.dragging=!0;let e=this.el.components.xyrect.width-this.data.thumbSize,i=(t.detail.point.x+.5*e)/e*(this.data.max-this.data.min);this.data.step>0&&(i=Math.round(i/this.data.step)*this.data.step),this.setValue(i+this.data.min,!0),this.el.dispatchEvent(new CustomEvent("change",{detail:{value:this.value}}))}),this.thumb.addEventListener("xy-dragend",t=>{this.dragging=!1})},update(){if(this.data.max<=this.data.min)return;let t=this.el.components.xyrect.width-this.data.thumbSize;this.thumb.setAttribute("position",{x:t*(this.data.value-this.data.min)/(this.data.max-this.data.min)-.5*t,y:0,z:.01})},setValue(t,e){this.dragging&&!e||(this.value=Math.max(Math.min(t,this.data.max),this.data.min),this.el.setAttribute("xyrange","value",this.value))}}),AFRAME.registerComponent("xyselect",{dependencies:["xyrect","xybutton"],schema:{values:{default:[]},label:{default:""},toggle:{default:!1},select:{type:"number",default:0}},init(){this.el.addEventListener("click",t=>{if(this.data.toggle){let t=(this.data.select+1)%this.data.values.length;this.el.setAttribute("xyselect","select",t),this.el.dispatchEvent(new CustomEvent("change",{detail:{value:this.data.values[t],index:t}}))}else this.listEl?this.hide():this.show()})},update(){this.el.setAttribute("xybutton",{label:this.data.label||this.data.values[this.data.select]})},show(){if(this.listEl)return;let t=(this.el.components.xyrect.height+.5*this.data.values.length)/2+.1;this.listEl=document.createElement("a-entity"),this.listEl.setAttribute("xycontainer",{spacing:0}),this.listEl.setAttribute("position",{x:0,y:t,z:.05}),this.el.appendChild(this.listEl),this.data.values.forEach((t,e)=>{let i=document.createElement("a-xybutton");i.setAttribute("xybutton",{label:t}),i.addEventListener("click",i=>{i.stopPropagation(),this.el.setAttribute("xybutton",{label:this.data.label||t}),this.el.dispatchEvent(new CustomEvent("change",{detail:{value:t,index:e}})),this.hide()}),this.listEl.appendChild(i)}),setTimeout(()=>this.listEl&&this.listEl.setAttribute("xyrect",{width:2,height:.5*this.data.values.length}),0)},hide(){this.listEl&&(this.el.removeChild(this.listEl),this.listEl.destroy(),this.listEl=null)}}),AFRAME.registerComponent("xyscroll",{schema:{width:{type:"number",default:-1},height:{type:"number",default:-1},scrollbar:{type:"boolean",default:!0}},init(){this.scrollX=0,this.scrollY=0,this.speedY=0,this.contentHeight=0,this.scrollDelta=Math.max(this.data.height/2,.5),this.control=document.createElement("a-entity"),this.thumbLen=.2,this.el.appendChild(this.control),this._initScrollBar(this.control,.3),this.el.setAttribute("xy-draggable",{}),this.el.addEventListener("xy-drag",t=>{this.speedY=0,this.setScroll(this.scrollX,this.scrollY+t.detail.point.y-t.detail.prevPoint.y)}),this.el.addEventListener("xy-dragend",t=>{this.speedY=t.detail.point.y-t.detail.prevPoint.y,this.play()})},_initScrollBar(t,e){this.upButton=this.el.sceneEl.systems.xywindow.createSimpleButton({width:e,height:.3},t),this.upButton.addEventListener("click",t=>{this.speedY=.3*-this.scrollDelta,this.play()}),this.downButton=this.el.sceneEl.systems.xywindow.createSimpleButton({width:e,height:.3},t),this.downButton.addEventListener("click",t=>{this.speedY=.3*this.scrollDelta,this.play()}),this.scrollThumb=this.el.sceneEl.systems.xywindow.createSimpleButton({width:.7*e,height:this.thumbLen},t),this.scrollThumb.setAttribute("xy-draggable",{base:this.el}),this.scrollThumb.addEventListener("xy-drag",t=>{let e=this.thumbLen,i=(this.scrollStart-e/2-t.detail.point.y)*Math.max(.01,this.contentHeight-this.data.height)/(this.scrollLength-e);this.setScroll(this.scrollX,i)})},update(){this.el.setAttribute("xyrect",{width:this.data.width,height:this.data.height}),this.el.setAttribute("xyclipping",{exclude:this.control}),this.upButton.setAttribute("visible",this.data.scrollbar),this.upButton.setAttribute("position",{x:this.data.width+.1,y:this.data.height-.15,z:.05}),this.downButton.setAttribute("visible",this.data.scrollbar),this.downButton.setAttribute("position",{x:this.data.width+.1,y:.15,z:.05}),this.scrollThumb.setAttribute("visible",this.data.scrollbar),this.scrollStart=this.data.height-.3,this.scrollLength=this.data.height-.6,this.setScroll(0,0)},tick(){Math.abs(this.speedY)>.001?(this.setScroll(this.scrollX,this.scrollY+this.speedY),this.speedY*=.8):this.pause()},contentChanged(){this.update(),this.setScroll(this.scrollX,this.scrollY)},setScroll(t,e){let i=this.el.children,s=.001;for(var a=0;a<i.length;a++){let t=i[a];t!==this.control&&(t.components.xyrect||t.setAttribute("xyrect",{}),s=Math.max(s,t.components.xyrect.height))}this.contentHeight=s,this.scrollX=Math.max(0,t),this.scrollY=Math.max(0,Math.min(e,this.contentHeight-this.data.height));let l=Math.max(.2,Math.min(this.scrollLength*this.data.height/this.contentHeight,this.scrollLength)),n=this.scrollStart-l/2-(this.scrollLength-l)*this.scrollY/Math.max(.01,this.contentHeight-this.data.height);this.thumbLen=l,this.scrollThumb.hasAttribute("geometry")&&this.scrollThumb.setAttribute("geometry","height",l),this.scrollThumb.setAttribute("position",{x:this.data.width+.1,y:n,z:.05});for(a=0;a<i.length;a++){let t=i[a];if(t===this.control)continue;if(t.components.xyitem&&t.components.xyitem.data.fixed)continue;let e=t.getAttribute("position");if(e.x=-this.scrollX+t.components.xyrect.data.pivotX*t.components.xyrect.width,e.y=this.scrollY-(1-t.components.xyrect.data.pivotY)*t.components.xyrect.height+this.data.height,t.setAttribute("position",e),t.components.xylist){let e=t.components.xyrect.height-this.scrollY;t.components.xylist.setRect(e,e-this.data.height,this.scrollX,this.scrollX+this.data.width)}}this.el.components.xyclipping&&this.el.components.xyclipping.applyClippings()}}),AFRAME.registerComponent("xylist",{schema:{width:{type:"number",default:-1},itemHeight:{type:"number",default:-1},vertical:{type:"boolean",default:!0}},init(){this.elementFactory=null,this.elementUpdator=null,this.elements=[],this.userData=null,this.itemCount=0,this.itemClicked=null,this.el.setAttribute("xyrect",{width:this.data.width,height:this.data.itemHeight,pivotX:0,pivotY:0}),this.setRect(0,0,0,0),this.el.classList.add(this.el.sceneEl.systems.xywindow.theme.collidableClass),this.el.addEventListener("click",t=>{let e=t.path||t.composedPath();for(var i=0;i<e.length;i++)if(e[i].parentNode==this.el&&null!=e[i].dataset.listPosition&&-1!=e[i].dataset.listPosition){this.itemClicked&&this.itemClicked(e[i].dataset.listPosition,t);break}})},setCallback(t,e){if(this.elementFactory=t||this.elementFactory,this.elementUpdator=e||this.elementUpdator,this.data.itemHeight<0){let t=this.elementFactory(this.el,this.userData);this.data.itemHeight=1*t.getAttribute("height")}},setContents(t,e){this.userData=t,this.itemCount=null!=e?e:t.length;let i=this.data.itemHeight*this.itemCount;this.el.setAttribute("xyrect",{width:this.data.width,height:i});for(var s=0;s<this.elements.length;s++)this.elements[s].setAttribute("visible",!1),this.elements[s].dataset.listPosition=-1;let a=this.el.parentNode.components.xyscroll;a&&a.contentChanged(),this.refresh()},setRect(t,e,i,s){this.top=t,this.bottom=e,this.refresh()},refresh(){if(!this.elementFactory)return;let t=this.data.itemHeight*this.itemCount,e=Math.max(Math.floor((t-this.top)/this.data.itemHeight),0),i=Math.min(Math.ceil((t-this.bottom)/this.data.itemHeight),this.itemCount),s=i-e+1;if(s>this.elements.length)for(;s>this.elements.length;){let t=this.elementFactory(this.el,this.userData);t.dataset.listPosition=-1,t.classList.add(this.el.sceneEl.systems.xywindow.theme.collidableClass),this.el.appendChild(t),this.elements.push(t)}let a=!1;for(var l=e;l<i;l++)a|=!this.updateElement(l);a&&setTimeout(this.refresh.bind(this),100);for(var n=0;n<this.elements.length;n++){let t=this.elements[n].dataset.listPosition;this.elements[n].setAttribute("visible",t>=e&&t<i)}},updateElement(t){let e=this.elements[t%this.elements.length];if(!e.hasLoaded)return!1;if(e.dataset.listPosition==t)return!0;e.dataset.listPosition=t;let i=0,s=(this.itemCount-t-1)*this.data.itemHeight;return e.components.xyrect&&(i+=e.components.xyrect.data.pivotX*e.components.xyrect.width,s+=e.components.xyrect.data.pivotY*e.components.xyrect.height),e.setAttribute("position",{x:i,y:s,z:0}),this.elementUpdator&&this.elementUpdator(t,e,this.userData),!0}}),AFRAME.registerComponent("xycanvas",{schema:{width:{type:"number",default:100},height:{type:"number",default:100}},init(){this.canvas=document.createElement("canvas"),this.canvas.id="_CANVAS"+Math.random();let t=new THREE.CanvasTexture(this.canvas);this.updateTexture=function(){t.needsUpdate=!0},this.el.setAttribute("material",{shader:"flat",npot:!0,src:t,transparent:!0})},update(){this.canvas.width=this.data.width,this.canvas.height=this.data.height}}),AFRAME.registerPrimitive("a-xywindow",{defaultComponents:{xycontainer:{alignItems:"stretch"},xywindow:{}},mappings:{width:"xyrect.width",height:"xyrect.height",direction:"xycontainer.direction",title:"xywindow.title"}}),AFRAME.registerPrimitive("a-xyscroll",{defaultComponents:{xyrect:{pivotX:0,pivotY:1},xyscroll:{}},mappings:{width:"xyscroll.width",height:"xyscroll.height",scrollbar:"xyscroll.scrollbar"}}),AFRAME.registerPrimitive("a-xylabel",{defaultComponents:{xylabel:{}},mappings:{width:"xylabel.width",height:"xylabel.height",value:"xylabel.value",color:"xylabel.color",align:"xylabel.align","wrap-count":"xylabel.wrapCount"}}),AFRAME.registerPrimitive("a-xybutton",{defaultComponents:{xyrect:{width:2,height:.5},xybutton:{}},mappings:{width:"xyrect.width",height:"xyrect.height",label:"xybutton.label"}}),AFRAME.registerPrimitive("a-xyrange",{defaultComponents:{xyrect:{},xyrange:{}},mappings:{min:"xyrange.min",max:"xyrange.max",step:"xyrange.step",value:"xyrange.value",width:"xyrect.width",height:"xyrect.height"}}),AFRAME.registerPrimitive("a-xyselect",{defaultComponents:{xyrect:{width:2,height:.5},xyselect:{}},mappings:{width:"xyrect.width",height:"xyrect.height",values:"xyselect.values",label:"xyselect.label",toggle:"xyselect.toggle",select:"xyselect.select"}});