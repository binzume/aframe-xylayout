"use strict";AFRAME.registerComponent("xyinput",{dependencies:["xylabel"],schema:{value:{default:""},type:{default:""},placeholder:{default:""},caretColor:{default:"#0088ff"},bgColor:{default:"white"},virtualKeyboard:{default:"[xykeyboard]"}},init(){let t=this.data,e=this.el,i=e.components.xyrect,s=t=>{let i=this.cursor,s=e.value;this.cursor+=t.length,e.value=s.slice(0,i)+t+s.slice(i)};Object.defineProperty(e,"value",{get:()=>t.value,set:t=>e.setAttribute("xyinput","value",""+t)}),this.t=new THREE.Mesh(new THREE.PlaneGeometry(.04,.9*i.height),new THREE.MeshBasicMaterial({color:t.caretColor})),e.setObject3D("caret",this.t),this.t.position.z=.02,e.classList.add("collidable");let h=()=>{e.setAttribute("geometry",{primitive:"xy-rounded-rect",width:i.width,height:i.height})};h(),e.setAttribute("material",{color:t.bgColor}),e.setAttribute("tabindex",0),e.addEventListener("xyresize",h),e.addEventListener("click",i=>{e.focus();let s=document.querySelector(t.virtualKeyboard);s&&s.components.xykeyboard.show(t.type);let h=i.detail.intersection;if(h){let t=h.uv.x,e=0,i=this.el.value.length,s=0;for(;i>e;)this.s(s=e+((i-e+1)/2|0))<t?e=s:i=s-1;this.h(e)}});let l=t=>{t.clipboardData.setData("text/plain",e.value),t.preventDefault()},o=t=>{s(t.clipboardData.getData("text/plain")),t.preventDefault()};e.addEventListener("focus",t=>{this.h(this.cursor),window.addEventListener("copy",l),window.addEventListener("paste",o)}),e.addEventListener("blur",t=>{this.h(this.cursor),window.removeEventListener("copy",l),window.removeEventListener("paste",o)}),e.addEventListener("keypress",t=>{"Enter"!=t.code&&s(t.key)}),e.addEventListener("keydown",t=>{let i=this.cursor,s=e.value;"ArrowLeft"==t.code?i>0&&this.h(i-1):"ArrowRight"==t.code?i<s.length&&this.h(i+1):"Backspace"==t.code&&i>0&&(this.cursor--,e.value=s.slice(0,i-1)+s.slice(i))})},update(t){let e=this.el,i=this.data,s=e.value,h=this.cursor;(h>s.length||null==t.value)&&(h=s.length),"password"==i.type&&(s=s.replace(/./g,"*")),e.setAttribute("xylabel",{color:s?"black":"#aaa",value:s||i.placeholder}),this.h(h)},h(t){let e=this.t;this.cursor=t,e.visible=!1,document.activeElement==this.el&&setTimeout(()=>{e.position.x=this.s(t),e.visible=!0},0)},s(t){let e=this.el,{xylabel:i,xyrect:s,text:h}=e.components,l=e.value,o=0;if(0==t);else if(i.canvas){o=i.canvas.getContext("2d").measureText(l.slice(0,t)).width/i.textWidth}else if(h){let e=h.geometry.layout,i=e.glyphs,s=Math.max(0,t-(l.length-i.length)),a=i[Math.min(s,i.length-1)];o=a?(a.position[0]+a.data.width*(s>=i.length?1:.1))/e.width:0}return(o-.5)*s.width+.04}}),AFRAME.registerComponent("xyime",{schema:{label:{default:null,type:"selector"}},table:{a:"ã‚",i:"ã„",u:"ã†",e:"ãˆ",o:"ãŠ",ka:"ã‹",ki:"ã",ku:"ã",ke:"ã‘",ko:"ã“",ga:"ãŒ",gi:"ãŽ",gu:"ã",ge:"ã’",go:"ã”",sa:"ã•",si:"ã—",su:"ã™",se:"ã›",so:"ã",za:"ã–",zi:"ã˜",zu:"ãš",ze:"ãœ",zo:"ãž",ta:"ãŸ",ti:"ã¡",tu:"ã¤",te:"ã¦",to:"ã¨",da:"ã ",di:"ã¢",du:"ã¥",de:"ã§",do:"ã©",na:"ãª",ni:"ã«",nu:"ã¬",ne:"ã­",no:"ã®",ha:"ã¯",hi:"ã²",hu:"ãµ",he:"ã¸",ho:"ã»",pa:"ã±",pi:"ã´",pu:"ã·",pe:"ãº",po:"ã½",ba:"ã°",bi:"ã³",bu:"ã¶",be:"ã¹",bo:"ã¼",ma:"ã¾",mi:"ã¿",mu:"ã‚€",me:"ã‚",mo:"ã‚‚",ya:"ã‚„",yi:"ã„",yu:"ã‚†",ye:"ã„ã‡",yo:"ã‚ˆ",ra:"ã‚‰",ri:"ã‚Š",ru:"ã‚‹",re:"ã‚Œ",ro:"ã‚",wa:"ã‚",wi:"ã†ãƒ",wu:"ã†",we:"ã†ã‡",wo:"ã‚’",xa:"ã",xi:"ãƒ",xu:"ã…",xe:"ã‡",xo:"ã‰",xya:"ã‚ƒ",xyi:"ãƒ",xyu:"ã‚…",xye:"ã‡",xyo:"ã‚‡",xtu:"ã£",xka:"ãƒµ",xke:"ãƒ¶",nn:"ã‚“",wyi:"ã‚",wye:"ã‚‘",fu:"ãµ",vu:"ãƒ´",tsu:"ã¤",chi:"ã¡",ji:"ã˜",shi:"ã—","-":"ãƒ¼"},init(){this.enable=!1,this.l="",this.p=[],this.g=0,this.m=this.m.bind(this),document.body.addEventListener("keydown",this.m,!0),document.body.addEventListener("keypress",this.m,!0)},remove(){document.body.removeEventListener("keydown",this.m,!0),document.body.removeEventListener("keypress",this.m,!0)},async convert(t,e){let i=await fetch(`https://www.google.com/transliterate?langpair=ja-Hira|ja&text=${t},`);e((await i.json())[0][1])},m(t){if("CapsLock"==t.code&&t.shiftKey||"HiraganaKatakana"==t.key)return this.enable=!this.enable,void this.v(t.target);if(this.enable&&t.code){if("keypress"==t.type){if(this.p.length>0){if("Space"==t.code)return this.g=(this.g+1)%this.p.length,this.k(this.p[this.g]),void t.stopPropagation();this.v(t.target)}if(t.key.match(/^[^\s]$/)){let e=[[/n([^aiueoyn])/g,"nn$1"],[/([ksthmyrwgzbpdjfv])\1/g,"xtu$1"],[/([kstnhmrgzbpdj])(y[aiueo])/g,"$1ix$2"],[/(j|ch|sh)([aueo])/g,"$1ixy$2"],[/(f|v|ts)(y?[aieo])/g,"$1ux$2"],[/(t|d)h([aiueo])/g,"$1exy$2"]].reduce((t,[e,i])=>t.replace(e,i),this.l+t.key);for(let t=0;t<e.length;t++)for(let i=3;i>=0;i--){let s=this.table[e.slice(t,t+i)];if(s){e=e.slice(0,t)+s+e.slice(t+i);break}}this.k(e)}else if("Space"==t.code&&this.l)this.convert(this.l,t=>{this.p=t,this.g=0,this.k(t[0])}),this.k("");else{if(!this.l)return;this.k(this.l+t.key)}}else{if(!this.l)return;"Enter"==t.code?this.v(t.target):"Backspace"==t.code&&this.k(this.l.slice(0,-1))}t.stopPropagation()}},k(t){this.l=t,(this.data.label||this.el).setAttribute("value",t)},v(t){this.l&&(t.dispatchEvent(new KeyboardEvent("keypress",{key:this.l})),this.k("")),this.p=[]}}),AFRAME.registerComponent("xykeyboard",{schema:{keySize:{default:.2},ime:{default:!1}},blocks:{main:{size:[11,4],rows:[{pos:[0,3],keys:["qQ!","wW@","eE#","rR$","tT%","yY^","uU&","iI*","oO(","pP)","-_="]},{pos:[0,2],keys:["aA1","sS2","dD3","fF4","gG5","hH`","jJ~","kK+","lL[",":;]"]},{pos:[0,1],keys:[{code:"Shift",symbols:"â‡§â¬†"},"zZ6","xX7","cC8","vV9","bB0","nN{","mM}",",'<",'.">',"/?\\"]},{pos:[0,0],keys:[{code:"Space",key:" ",label:"_",size:4}]},{pos:[-4.5,0],keys:[{code:"_Fn",label:"#!"},{code:"HiraganaKatakana",label:"ðŸŒ"}]}]},num:{size:[4,4],rows:[{pos:[0,3],keys:["7","8","9","/"]},{pos:[0,2],keys:["4","5","6","*"]},{pos:[0,1],keys:["1","2","3","-"]},{pos:[0,0],keys:["0",":",".","+"]}]},ctrl:{size:[2,4],rows:[{pos:[0,3],keys:[{code:"Backspace",label:"âŒ«",size:2}]},{pos:[0,2],keys:[{code:"Space",key:" ",label:"SP",size:2}]},{pos:[0,1],keys:[{code:"Enter",label:"âŽ",size:2}]},{pos:[1.3,3.5],keys:[{code:"_Close",label:"x",size:.8}]},{pos:[0,0],keys:[{code:"ArrowLeft",label:"â‡¦"},{code:"ArrowRight",label:"â‡¨"}]}]}},show(t){this.hide();let e=this.el,i=this.data,s=i.keySize,h=i.ime?[]:["HiraganaKatakana"],l=this.blocks,o=(t,i=[])=>{let h=document.createElement("a-entity"),l=.3*s,o=t.size;h.setAttribute("geometry",{primitive:"xy-rounded-rect",width:o[0]*s+l,height:o[1]*s+l}),h.setAttribute("material",{color:"#222233"});for(let e of t.rows){let t=h.appendChild(document.createElement("a-xycontainer"));t.setAttribute("xycontainer",{direction:"row"}),t.setAttribute("position",{x:e.pos[0]*s,y:e.pos[1]*s-(o[1]-1)*s/2,z:.02});for(let h of e.keys){if(i.includes(h.code))continue;let e=t.appendChild(document.createElement("a-xybutton"));e.setAttribute("material","visible",!1),e.setAttribute("xylabel",{value:h.label||"",align:"center"}),e.setAttribute("xyrect",{width:(h.size||1)*s,height:s}),e.addEventListener("mouseenter",t=>e.setAttribute("material","visible",!0)),e.addEventListener("mouseleave",t=>e.setAttribute("material","visible",!1)),(h.symbols||"string"==typeof h)&&(e.classList.add("xyinput-key"),e.dataset.keySymbols=h.symbols||h),"_Close"==h.code&&(e.classList.add("xyinput-close"),e.addEventListener("click",t=>this.hide())),e.addEventListener("mousedown",t=>{if(document.activeElement==document.body&&this.R&&this.R.focus(),this.R=document.activeElement,setTimeout(()=>this.R.focus(),0),t.preventDefault(),"_Fn"!=h.code){if("Shift"==h.code&&this.A((this.M+1)%2),document.activeElement!=document.body){let t=h.code?h.key:h,e={key:t?t[this.M]||t[0]:h.code,code:h.code||h[0].toUpperCase()};document.activeElement.dispatchEvent(new KeyboardEvent("keydown",e)),t&&document.activeElement.dispatchEvent(new KeyboardEvent("keypress",e))}}else this.A(2==this.M?0:2)})}}return e.appendChild(h)};if("number"==t){let t=l.num.size[0]+l.ctrl.size[0];o(l.num),o(l.ctrl).setAttribute("position","x",(t/2+.4)*s)}else if("full"==t){let t=l.main.size[0]+l.ctrl.size[0];o(l.main,h),o(l.ctrl,["Space"]).setAttribute("position","x",(t/2+.4)*s),t+=l.ctrl.size[0]+l.num.size[0],o(l.num).setAttribute("position","x",(t/2+.8)*s)}else{let t=l.main.size[0]+l.ctrl.size[0];o(l.main,h),o(l.ctrl,["Space"]).setAttribute("position","x",(t/2+.4)*s)}if(i.ime){let t=e.appendChild(document.createElement("a-xylabel"));t.setAttribute("xylabel",{color:"yellow",renderingMode:"canvas"}),t.setAttribute("position",{x:0,y:2*s*.95,z:.03}),t.setAttribute("xyrect",{width:8*s,height:.6*s}),t.setAttribute("xyime","")}e.setAttribute("xy-drag-control","draggable",".xyinput-close"),this.A(0);let a=e.object3D,n=a.position,r=(new THREE.Matrix4).getInverse(a.parent.matrixWorld).multiply(e.sceneEl.camera.matrixWorld),d=n.y;n.set(0,0,-.7).applyMatrix4(r),n.y=d,a.rotation.y=(new THREE.Euler).setFromRotationMatrix(r.extractRotation(r),"YXZ").y},hide(){let t=this.el;for(this.R=null,t.removeAttribute("xy-drag-control");t.firstChild;)t.removeChild(t.firstChild)},A(t){this.M=t;for(let e of this.el.querySelectorAll(".xyinput-key")){let i=e.dataset.keySymbols;e.setAttribute("xylabel","value",i[t]||i[0])}}}),AFRAME.registerPrimitive("a-xykeyboard",{defaultComponents:{xykeyboard:{}},mappings:{ime:"xykeyboard.ime","key-size":"xykeyboard.keySize"}}),AFRAME.registerPrimitive("a-xyinput",{defaultComponents:{xyrect:{width:2,height:.5},xyinput:{}},mappings:{width:"xyrect.width",height:"xyrect.height",value:"xyinput.value",type:"xyinput.type",placeholder:"xyinput.placeholder","caret-color":"xyinput.caretColor","background-color":"xyinput.bgColor"}}),AFRAME.registerComponent("xycontainer",{dependencies:["xyrect"],schema:{spacing:{default:0},padding:{default:0},reverse:{default:!1},wrap:{default:"nowrap",oneOf:["wrap","nowrap"]},direction:{default:"column",oneOf:["none","row","column","vertical","horizontal"]},alignItems:{default:"none",oneOf:["none","center","start","end","baseline","stretch"]},justifyItems:{default:"start",oneOf:["center","start","end","space-between","space-around","stretch"]},alignContent:{default:"",oneOf:["","none","start","end","center","stretch"]}},init(){this.el.addEventListener("xyresize",t=>this.layout()),this.layout()},layout(){let t=this.data,e=t&&t.direction;if(!e||"none"==e)return;let i=this.el.components.xyrect,s=this.el.children,h="vertical"==e||"column"==e,l=t.padding,o=t.spacing,a=t.reverse!=h?-1:1,n=h?[0,1,a,0]:[a,0,0,-1],r=h?(t,e)=>[e,t]:(t,e)=>[t,e],d=r(i.width-2*l,i.height-2*l),c=r("width","height"),u=0,y=0,x=[],p=[],f=0,g=0,m=0,w=0,b=()=>{u=Math.max(u,f+o*(p.length-1)),y+=w,x.push([p,f,g,m,w]),p=[],f=0,g=0,m=0,w=0};for(let e of s){let i=e.getAttribute("xyitem");if(i&&i.fixed)continue;let s=e.components.xyrect||e.getAttribute("geometry")||{width:1*(e.getAttribute("width")||void 0),height:1*(e.getAttribute("height")||void 0)},h=e.getAttribute("scale")||{x:1,y:1},l=s.data?s.data.pivot:{x:.5,y:.5},a={el:e,xyitem:i,size:r(s.width,s.height),pivot:r(l.x,l.y),scale:r(h.x,h.y)};if(null==a.size[0]||isNaN(a.size[0]))continue;let n=a.size[0]*a.scale[0];"wrap"==t.wrap&&f>0&&f+n+o*p.length>d[0]&&b(),p.push(a),f+=n,g+=i?i.grow:1,m+=i?i.shrink:1,w=a.size[1]>w?a.size[1]:w}p.length>0&&b(),y+=o*(x.length-1),-1==i.data[c[0]]&&(d[0]=u,i[c[0]]=u+2*l),-1==i.data[c[1]]&&(d[1]=y,i[c[1]]=y+2*l);let E=-d[1]/2,v=-d[0]/2,k=0,R=t.alignContent||t.alignItems;"end"==R?E+=d[1]-y:"center"==R?E+=(d[1]-y)/2:"stretch"!=R&&"none"!=R||(k=(d[1]-y)/x.length);for(let[t,e,i,s,h]of x)this.T(t,e,i,s,v,E,d[0],h+k,n,c),E+=h+k+o},T(t,e,i,s,h,l,o,a,n,r){let{justifyItems:d,alignItems:c,spacing:u,wrap:y}=this.data,x=0,p=t.length;"center"===d?h+=(o-e-u*p)/2:"end"===d?h+=o-e-u*p:"stretch"===d?x=(x=o-e-u*(p-1))>0?i>0?x/i:0:s>0?x/s:0:"space-between"===d?u=(o-e)/(p-1):"space-around"===d&&(h+=(u=(o-e)/p)/2);for(let e of t){let t=e.el,i=e.xyitem,[s,o]=e.pivot,[d,p]=e.scale,[f,g]=e.size,m=i&&i.align||c,w=(i?x>0?i.grow:i.shrink:1)*x,b=f*d+w,E=h+s*b,v=l+a/2,k=t.getAttribute("position")||{x:0,y:0,z:0};d>0&&0!=w&&t.setAttribute(r[0],f+w/d),p>0&&"stretch"===m&&t.setAttribute(r[1],(g=a)/p),"start"===m||"stretch"===m?v=l+o*g:"end"===m?v=l+a-(1-o)*g:"center"===m?v+=(o-.5)*g:"none"===m&&"wrap"!=y&&(v+=n[1]*k.x+n[3]*k.y),k.x=n[0]*E+n[1]*v,k.y=n[2]*E+n[3]*v,t.setAttribute("position",k),h+=b+u}}}),AFRAME.registerComponent("xyitem",{schema:{align:{default:"none",oneOf:["none","center","start","end","baseline","stretch"]},grow:{default:1},shrink:{default:1},fixed:{default:!1}},update(t){if(void 0!==t.align){let t=this.el.parentNode.components.xycontainer;t&&t.layout()}}}),AFRAME.registerComponent("xyrect",{schema:{width:{default:-1},height:{default:-1},pivot:{type:"vec2",default:{x:.5,y:.5}},updateGeometry:{default:!1}},update(t){let e=this.el,{width:i,height:s,updateGeometry:h}=this.data,l=e.getAttribute("geometry")||{};this.width=i<0?1*(e.getAttribute("width")||l.width||0):i,this.height=s<0?1*(e.getAttribute("height")||l.height||0):s,void 0!==t.width&&(h&&e.setAttribute("geometry",{width:i,height:s}),e.emit("xyresize",{xyrect:this},!1))}}),AFRAME.registerPrimitive("a-xycontainer",{defaultComponents:{xyrect:{},xycontainer:{}},mappings:{width:"xyrect.width",height:"xyrect.height",direction:"xycontainer.direction",spacing:"xycontainer.spacing",padding:"xycontainer.padding",reverse:"xycontainer.reverse",wrap:"xycontainer.wrap","align-items":"xycontainer.alignItems","justify-items":"xycontainer.justifyItems","align-content":"xycontainer.alignContent"}});const XYTheme={get(t){return this.defaultTheme},defaultTheme:{button:{color:"#222",labelColor:"#fff",hoverColor:"#333",geometry:"xy-rounded-rect",hoverHaptic:.3,hoverHapticMs:10},window:{closeButton:{color:"#111",hoverColor:"#f00"},titleBar:{color:"#111"},background:{color:"#111"}},collidableClass:"collidable",createButton(t,e,i,s,h,l){let o=t=>s&&s[t]||this.button[t];return(l=l||document.createElement("a-entity")).hasAttribute("geometry")||l.setAttribute("geometry",{primitive:o("geometry"),width:t,height:e}),l.classList.add(this.collidableClass),l.addEventListener("mouseenter",t=>{l.setAttribute("material",{color:o("hoverColor")});let e=o("hoverHaptic");if(e){let i=t.detail.cursorEl.components["tracked-controls"],s=i&&i.controller,h=s&&s.hapticActuators;h&&h[0]&&h[0].pulse(e,o("hoverHapticMs"))}}),l.addEventListener("mouseleave",t=>{l.setAttribute("material",{color:o("color")})}),l.setAttribute("material",{color:o("color")}),h&&l.setAttribute("xylabel",{color:o("labelColor")}),i?i.appendChild(l):l}}};AFRAME.registerGeometry("xy-rounded-rect",{schema:{height:{default:1,min:0},width:{default:1,min:0},radius:{default:.05,min:0}},init(t){let e=new THREE.Shape,i=t.radius,s=(t.width||.01)/2,h=(t.height||.01)/2;e.moveTo(-s,-h+i),e.lineTo(-s,h-i),e.quadraticCurveTo(-s,h,-s+i,h),e.lineTo(s-i,h),e.quadraticCurveTo(s,h,s,h-i),e.lineTo(s,-h+i),e.quadraticCurveTo(s,-h,s-i,-h),e.lineTo(-s+i,-h),e.quadraticCurveTo(-s,-h,-s,-h+i),this.geometry=new THREE.ShapeGeometry(e)}}),AFRAME.registerComponent("xylabel",{dependencies:["xyrect"],schema:{value:{default:""},color:{default:"white"},align:{default:"left"},wrapCount:{default:0},xOffset:{default:0},zOffset:{default:.01},resolution:{default:32},renderingMode:{default:"auto",oneOf:["auto","canvas"]}},init(){this.el.addEventListener("xyresize",t=>this.update())},update(){let t=this.data,e=this.el,i=t.value,{width:s,height:h}=e.components.xyrect,l=t.wrapCount;if(0==l&&h>0&&(l=Math.max(s/h/.65,i.length)+1),""==i)return void this.remove();if("auto"==t.renderingMode&&!/[\u0100-\uDFFF]/.test(i)){let i=Object.assign({},t);delete i.resolution,delete i.renderingMode,i.wrapCount=l,i.width=s,i.height=h,e.setAttribute("text",i);let o=e.getObject3D("text");return o&&(o.raycast=(()=>{})),void this.H()}let o=t.resolution,a=Math.floor(o*l*.65),n=this.canvas||document.createElement("canvas"),r=.9*o+"px bold sans-serif",d=n.getContext("2d");d.font=r;let c=[""],u=0;for(let t of i)("\n"==t||d.measureText(c[u]+t).width>a)&&(c.push(""),u++),"\n"!=t&&(c[u]+=t);let y=o*c.length;if(!this.canvas||this.textWidth!=a||n.height!=y){let i=8;for(;i<a;)i*=2;this.remove(),this.canvas=n,n.height=y,n.width=i,this.textWidth=a;let l=this.C=new THREE.CanvasTexture(n);l.anisotropy=4,l.alphaTest=.2,l.repeat.x=a/i;let o=Math.min(s/a*y,h),r=new THREE.Mesh(new THREE.PlaneGeometry(s,o),new THREE.MeshBasicMaterial({map:l,transparent:!0}));r.position.set(t.xOffset,0,t.zOffset),r.raycast=(()=>{}),e.setObject3D("xylabel",r)}d.clearRect(0,0,a,y),d.font=r,d.textBaseline="top",d.textAlign=t.align,d.fillStyle=t.color;let x="center"===t.align?a/2:0,p=.1*o;for(let t of c)d.fillText(t,x,p),p+=o;this.C.needsUpdate=!0},remove(){this.H(),this.el.hasAttribute("text")&&this.el.removeAttribute("text")},H(){let t=this.el,e=t.getObject3D("xylabel");e&&(e.material.map.dispose(),e.material.dispose(),e.geometry.dispose(),t.removeObject3D("xylabel"),this.canvas=null)}}),AFRAME.registerComponent("xybutton",{dependencies:["xyrect"],schema:{color:{default:""},hoverColor:{default:""},labelColor:{default:""}},init(){let t=this.el,e=t.components.xyrect;XYTheme.get(t).createButton(e.width,e.height,null,this.data,!0,t)}}),AFRAME.registerComponent("xytoggle",{dependencies:["xyrect"],schema:{value:{default:!1}},init(){let t=this.el;Object.defineProperty(t,"value",{get:()=>this.data.value,set:e=>t.setAttribute("xytoggle","value",e)}),this.F=t.appendChild(document.createElement("a-circle")),t.addEventListener("click",e=>{t.value=!t.value,t.emit("change",{value:t.value},!1)}),t.addEventListener("xyresize",t=>this.update())},update(){let t=this.el,e=t.components.xyrect,i=e.height/2,s=t.value,h={color:s?"#0066ff":XYTheme.get(t).button.color,hoverColor:s?"#4499ff":""};t.setAttribute("xybutton",h),t.setAttribute("material","color",h.color),this.F.setAttribute("geometry","radius",.8*i),this.F.object3D.position.set((e.width/2-i)*(s?1:-1),0,.05),t.setAttribute("geometry",{primitive:"xy-rounded-rect",width:e.width,height:2*i,radius:i})}}),AFRAME.registerComponent("xyselect",{dependencies:["xyrect","xybutton"],schema:{values:{default:[]},label:{default:""},toggle:{default:!1},select:{default:0}},init(){let t=this.el;if(t.addEventListener("click",t=>{let e=this.data;e.toggle?this.select((e.select+1)%e.values.length):this._?this.hide():this.show()}),this.data.toggle)t.setAttribute("xylabel","align","center");else{(this.j=t.appendChild(document.createElement("a-triangle"))).setAttribute("geometry",{vertexA:{x:.1,y:.03,z:0},vertexB:{x:-.1,y:.03,z:0},vertexC:{x:0,y:-.12,z:0}}),t.addEventListener("xyresize",t=>this.update())}},update(){let t=this.data;this.el.setAttribute("xylabel",{value:t.label||t.values[t.select]}),this.j&&this.j.object3D.position.set(this.el.components.xyrect.width/2-.2,0,.05)},show(){if(this._)return;let t=this.data.values,e=this.el.components.xyrect.height,i=(e+t.length*e)/2,s=this._=document.createElement("a-xycontainer");t.forEach((t,i)=>{let h=s.appendChild(document.createElement("a-xybutton"));h.setAttribute("height",e),h.setAttribute("label",t),h.addEventListener("click",t=>{t.stopPropagation(),this.select(i),this.hide()})}),s.object3D.position.set(0,i,.1),this.el.appendChild(s)},select(t){this.el.setAttribute("xyselect","select",t),this.el.emit("change",{value:this.data.values[t],index:t},!1)},hide(){this._&&(this.el.removeChild(this._),this._.destroy(),this._=null)}}),AFRAME.registerComponent("xydraggable",{schema:{dragThreshold:{default:.02},base:{type:"selector",default:null}},init(){let t=this.el;t.classList.add(XYTheme.get(t).collidableClass),this.O=this.O.bind(this),t.addEventListener("mousedown",this.O),this.S=null},remove(){this.el.removeEventListener("mousedown",this.O)},tick(){this.S?this.S("xy-drag"):this.pause()},O(t){if(!t.detail.cursorEl||!t.detail.cursorEl.components.raycaster)return;let e=this.data.base||this.el,i=t.detail.cursorEl,s=i.components.raycaster.raycaster,h=new THREE.Plane(new THREE.Vector3(0,0,-1),0).applyMatrix4(e.object3D.matrixWorld),l=s.ray.direction.clone(),o=new THREE.Vector3,a=o.clone();null===s.ray.intersectPlane(h,o)&&e.object3D.worldToLocal(o);let n=s.ray.clone(),r=this,d=!1;t.stopPropagation();let c=r.S=(t=>{if(!d){if(l.manhattanDistanceTo(s.ray.direction)<r.data.dragThreshold)return;t="xy-dragstart",r.dragging=d=!0}a.copy(o),null!==s.ray.intersectPlane(h,o)&&e.object3D.worldToLocal(o),r.el.emit(t,{raycaster:s,point:o,pointDelta:a.sub(o),prevRay:n,cursorEl:i},!1),n.copy(s.ray)});r.play();let u=e=>e.target!=t.target&&e.stopPropagation();window.addEventListener("mouseenter",u,!0),window.addEventListener("mouseleave",u,!0);let y=t=>{if(t.detail.cursorEl==i&&(window.removeEventListener("mouseup",y),window.removeEventListener("mouseenter",u,!0),window.removeEventListener("mouseleave",u,!0),r.S=null,d)){r.dragging=!1;let t=t=>t.stopPropagation();window.addEventListener("click",t,!0),setTimeout(()=>window.removeEventListener("click",t,!0),0),c("xy-dragend")}};window.addEventListener("mouseup",y)}}),AFRAME.registerComponent("xy-drag-control",{schema:{target:{type:"selector",default:null},draggable:{default:""},autoRotate:{default:!1}},init(){this.$=this.$.bind(this),this.X=[],this.B=new THREE.Quaternion},update(t){let e=this.data.draggable;e!==t.draggable&&(this.remove(),this.X=Array.isArray(e)?e:e?this.el.querySelectorAll(e):[this.el],this.X.forEach(t=>{t.setAttribute("xydraggable",{}),t.addEventListener("xy-dragstart",this.$),t.addEventListener("xy-drag",this.$)}))},remove(){this.X.forEach(t=>{t.removeAttribute("xydraggable"),t.removeEventListener("xy-dragstart",this.$),t.removeEventListener("xy-drag",this.$)})},$(t){let e=this.el,i=this.data,s=t.detail,{origin:h,direction:l}=s.raycaster.ray,{origin:o,direction:a}=s.prevRay,n=s.cursorEl,r=(i.target||e).object3D,d=new THREE.Quaternion;n.components["tracked-controls"]?"xy-dragstart"!=t.type?d.copy(this.B).inverse().premultiply(n.object3D.getWorldQuaternion(this.B)):n.object3D.getWorldQuaternion(this.B):d.setFromUnitVectors(a,l);let c=r.parent.matrixWorld,u=new THREE.Matrix4,y=(new THREE.Matrix4).makeRotationFromQuaternion(d).multiply(u.setPosition(o.clone().negate())).premultiply(u.setPosition(h)).premultiply(u.getInverse(c)).multiply(c);if(r.applyMatrix4?r.applyMatrix4(y):r.applyMatrix(y),this.postProcess&&this.postProcess(r,t),i.autoRotate){let i=e.sceneEl.camera.getWorldPosition(new THREE.Vector3),s=r.getWorldPosition(new THREE.Vector3),h=i.clone().sub(s).normalize(),l=.8-h.y*h.y;if(l>0){y.lookAt(i,s,new THREE.Vector3(0,1,0));let e=n.components.raycaster.getIntersection(t.target),h=r.parent.worldToLocal(e?e.point:s),o=r.quaternion.clone();r.quaternion.slerp(d.setFromRotationMatrix(y.premultiply(u.getInverse(c))),.1*l),r.position.sub(h).applyQuaternion(o.inverse().premultiply(r.quaternion)).add(h)}}}}),AFRAME.registerComponent("xywindow",{dependencies:["xycontainer"],schema:{title:{default:""},closable:{default:!0},background:{default:!1}},init(){let t=this.el,e=XYTheme.get(t),i=e.window,s=this.controls=t.appendChild(document.createElement("a-entity"));if(s.setAttribute("xyitem",{fixed:!0}),s.object3D.position.set(0,0,.02),this.data.background){let e=this.Y=s.appendChild(document.createElement("a-plane"));e.setAttribute("material",{color:i.background.color,side:"double",transparent:!0,opacity:.8}),e.object3D.position.set(0,.25,-.04),t.addEventListener("object3dset",i=>{i.detail.object.el==e&&t.object3D.children.unshift(t.object3D.children.pop())})}if((this.I=e.createButton(1,.5,s,i.titleBar,!0)).setAttribute("xy-drag-control",{target:t,autoRotate:!0}),this.K=[],this.data.closable){let h=e.createButton(.5,.5,s,i.closeButton,!0);h.setAttribute("xylabel",{value:"X",align:"center"}),h.addEventListener("click",e=>t.parentNode.removeChild(t)),this.K.push(h)}t.addEventListener("xyresize",t=>{this.update({})}),this.system.registerWindow(this)},remove(){this.system.unregisterWindow(this)},update(t){let e=this.el,i=this.data,{width:s,height:h}=e.components.xyrect,l=this.I,o=this.Y,a=0,n=h/2+.3;for(let t of this.K)t.object3D.position.set(s/2-.25-a,n,0),a+=.52;if(i.title!=t.title){let t=s-a-.1;l.setAttribute("xyrect",{width:t,height:.45}),l.setAttribute("xylabel",{value:i.title,wrapCount:Math.max(10,t/.2),xOffset:.1})}l.setAttribute("geometry",{width:s-a}),l.object3D.position.set(-a/2,n,0),o&&o.object3D.scale.set(s+.1,h+.7,1)}}),AFRAME.registerSystem("xywindow",{windows:[],registerWindow(t){this.windows.push(t)},unregisterWindow(t){this.windows=this.windows.filter(e=>e!=t)}}),AFRAME.registerComponent("xyrange",{dependencies:["xyrect"],schema:{min:{default:0},max:{default:100},step:{default:0},value:{default:0},color0:{default:"white"},color1:{default:"#06f"},thumbSize:{default:.4}},init(){let t=this.data,e=this.el,i=this.F=XYTheme.get(e).createButton(t.thumbSize,t.thumbSize,e),s=new THREE.PlaneGeometry(1,.08),h=this.L=new THREE.Mesh(s,new THREE.MeshBasicMaterial({color:t.color0})),l=this.G=new THREE.Mesh(s,new THREE.MeshBasicMaterial({color:t.color1}));l.position.z=.02,e.setObject3D("xyrange",(new THREE.Group).add(h,l)),i.setAttribute("xydraggable",{base:e}),i.addEventListener("xy-drag",i=>{let s=e.components.xyrect.width-t.thumbSize,h=(i.detail.point.x+s/2)/s*(t.max-t.min);t.step>0&&(h=Math.round(h/t.step)*t.step),this.setValue(h+t.min,!0)}),Object.defineProperty(e,"value",{get:()=>t.value,set:t=>this.setValue(t,!1)})},update(){let t=this.data;if(t.max==t.min)return;let e=this.el.components.xyrect.width-t.thumbSize,i=e*(t.value-t.min)/(t.max-t.min);this.F.setAttribute("geometry","radius",t.thumbSize/2),this.F.object3D.position.set(i-e/2,0,.04),this.L.scale.x=e,this.G.scale.x=i||.01,this.G.position.x=(i-e)/2},setValue(t,e){if(!this.F.components.xydraggable.dragging||e){let i=this.data,s=Math.max(Math.min(t,i.max),i.min);s!=i.value&&e&&this.el.emit("change",{value:s},!1),this.el.setAttribute("xyrange","value",s)}}}),AFRAME.registerComponent("xyclipping",{dependencies:["xyrect"],schema:{exclude:{type:"selector",default:null},clipTop:{default:!0},clipBottom:{default:!0},clipLeft:{default:!1},clipRight:{default:!1}},init(){this.el.sceneEl.renderer.localClippingEnabled=!0,this.W=[],this.D=[],this.N=null,this.V=this.V.bind(this),this.P=["click","mousedown","mouseenter","mouseleave","mousemove"],this.P.forEach(t=>this.el.addEventListener(t,this.V,!0))},update(){let t=this.data,e=this.el.components.xyrect,i=this.W=[];t.clipBottom&&i.push(new THREE.Plane(new THREE.Vector3(0,1,0),0)),t.clipTop&&i.push(new THREE.Plane(new THREE.Vector3(0,-1,0),e.height)),t.clipLeft&&i.push(new THREE.Plane(new THREE.Vector3(1,0,0),0)),t.clipRight&&i.push(new THREE.Plane(new THREE.Vector3(-1,0,0),e.width)),this.D=i.map(t=>t.clone()),this.Z()},remove(){this.P.forEach(t=>this.el.removeEventListener(t,this.V,!0)),this.D=[],this.applyClippings()},tick(){this.el.object3D.matrixWorld.equals(this.N)||this.Z()},V(t){if(!(t.path||t.composedPath()).includes(this.data.exclude)&&t.detail.intersection&&this.isClipped(t.detail.intersection.point)){t.stopPropagation();let e=t.detail.cursorEl&&t.detail.cursorEl.components.raycaster;if(e){let i=e.intersectedEls,s=i.lastIndexOf(t.target);s>=0&&s+1<i.length&&i[s+1].dispatchEvent(new CustomEvent(t.type,t))}}},Z(){this.N=this.el.object3D.matrixWorld.clone(),this.W.forEach((t,e)=>{this.D[e].copy(t).applyMatrix4(this.N)}),this.applyClippings()},applyClippings(){let t=this.data.exclude&&this.data.exclude.object3D,e=i=>{if(i!==t){i.material&&void 0!==i.material.clippingPlanes&&(i.material.clippingPlanes=this.D);for(let t of i.children)e(t)}};e(this.el.object3D)},isClipped(t){return this.D.some(e=>e.distanceToPoint(t)<0)}}),AFRAME.registerComponent("xyscroll",{dependencies:["xyrect"],schema:{scrollbar:{default:!0}},init(){this.q=this.J=this.U=0,this.tt=0,this.et=0;let t=this.el,e=this.it=this.st(t,.3);t.setAttribute("xyclipping",{exclude:e}),t.setAttribute("xydraggable",{}),t.addEventListener("xy-drag",t=>{let e=t.detail.pointDelta;this.U=-e.y,this.ht(e.x,-e.y)}),t.addEventListener("xy-dragstart",t=>this.play()),t.addEventListener("xy-dragend",t=>this.play()),t.addEventListener("xyresize",t=>this.update());for(let i of t.children)i!=e&&i.addEventListener("xyresize",t=>this.update())},st(t,e){let i=XYTheme.get(t),s=this.lt=t.appendChild(document.createElement("a-entity"));return this.ot=i.createButton(e,e,s),this.ot.addEventListener("click",t=>{this.U=-this.at,this.play()}),this.nt=i.createButton(e,e,s),this.nt.addEventListener("click",t=>{this.U=this.at,this.play()}),this.rt=i.createButton(.7*e,1,s),this.rt.setAttribute("xydraggable",{base:s}),this.rt.addEventListener("xy-drag",t=>{this.ht(0,t.detail.pointDelta.y*(this.tt-this.el.components.xyrect.height)/(this.dt-this.et||1))}),s},update(){let t=this.el.components.xyrect,e=t.height;this.lt.setAttribute("visible",this.data.scrollbar),this.lt.setAttribute("position",{x:t.width+.1,y:0,z:.05}),this.ot.setAttribute("position",{x:0,y:e-.15,z:0}),this.nt.setAttribute("position",{x:0,y:.15,z:0}),this.at=.3*Math.max(e/2,.5),this.ct=e-.3,this.dt=e-.6,this.setScroll(0,0)},tick(){Math.abs(this.U)>.001?(this.U*=.8,this.ht(0,this.U)):this.pause()},ht(t,e){this.setScroll(this.q+t,this.J+e)},setScroll(t,e){let i=this.el,s=i.components.xyrect,h=i.children,l=0,o=0;for(let t of h)t!==this.it&&(t.components.xyrec||t.setAttribute("xyrect",{}),o=Math.max(o,t.components.xyrect.width),l=Math.max(l,t.components.xyrect.height));this.tt=l,this.q=Math.max(0,Math.min(t,o-s.width)),this.J=Math.max(0,Math.min(e,l-s.height));let a=this.et=Math.max(.2,Math.min(this.dt*s.height/l,this.dt));this.rt.setAttribute("geometry","height",a),this.rt.setAttribute("position","y",this.ct-a/2-(this.dt-a)*this.J/(l-s.height||1));for(let t of h){if(t===this.it||(t.getAttribute("xyitem")||{}).fixed)continue;let e=t.components.xyrect,i=e.data.pivot,h=(1-i.y)*e.height-this.J,l=-i.x*e.width+this.q,o=t.getAttribute("position");o.x=-l,o.y=-h+s.height,t.setAttribute("position",o),t.emit("xyviewport",[h,h-s.height,l,l+s.width],!1)}let n=i.components.xyclipping;n&&n.applyClippings()}}),AFRAME.registerComponent("xylist",{dependencies:["xyrect"],schema:{itemWidth:{default:-1},itemHeight:{default:-1}},init(){let t=this.el,e=this.data;this.ut=null,this.yt={},this.xt=[],this.pt=null,this.ft=0,this.gt={size(t,i){if(e.itemHeight<=0){let t=i.ut.create();e.itemHeight=1*t.getAttribute("height"),e.itemWidth=1*t.getAttribute("width")}return{width:e.itemWidth,height:e.itemHeight*t}},*targets(t){let i=e.itemHeight,s=Math.floor(-t[0]/i),h=Math.ceil(-t[1]/i);for(;s<h;)yield s++},layout(t,i){let s=t.components.xyrect,h=s?s.data.pivot:{x:.5,y:.5};t.setAttribute("position",{x:0+h.x*s.width,y:-i*e.itemHeight-h.y*s.height,z:0})}},t.setAttribute("xyrect","pivot",{x:0,y:1}),t.addEventListener("xyviewport",t=>this.setViewport(t.detail)),t.addEventListener("click",e=>{for(let i of e.path||e.composedPath()){let s=i.dataset.listPosition;if(null!=s&&s>=0){t.emit("clickitem",{index:s,ev:e},!1);break}}}),this.setViewport([0,0])},setLayout(t){this.gt=t},setAdapter(t){this.ut=t},setContents(t,e){this.pt=t,this.ft=null!=e?e:t.length,this.el.setAttribute("xyrect",this.gt.size(this.ft,this));for(let t of Object.values(this.yt))t.dataset.listPosition=-1;this.wt()},setViewport(t){this.bt=t,this.wt()},wt(){let t=this.ut,e=this.el,i=this.yt,s={},h=!1;if(t){for(let l of this.gt.targets(this.bt))if(l>=0&&l<this.ft){s[l]=!0;let o=i[l];o||(o=i[l]=this.xt.pop()||e.appendChild(t.create(e))).classList.add(XYTheme.get(e).collidableClass),h|=!o.hasLoaded,o.hasLoaded&&o.dataset.listPosition!=l&&(o.dataset.listPosition=l,this.gt.layout(o,l),t.bind(l,o,this.pt))}for(let[t,e]of Object.entries(i))e.setAttribute("visible",1==s[t]),s[t]||(this.xt.push(e),delete i[t]);h&&setTimeout(()=>this.wt(),1)}}}),AFRAME.registerPrimitive("a-xylabel",{defaultComponents:{xylabel:{}},mappings:{width:"xyrect.width",height:"xyrect.height",value:"xylabel.value",color:"xylabel.color",align:"xylabel.align","wrap-count":"xylabel.wrapCount"}}),AFRAME.registerPrimitive("a-xybutton",{defaultComponents:{xyrect:{width:2,height:.5,updateGeometry:!0},xylabel:{align:"center"},xybutton:{}},mappings:{width:"xyrect.width",height:"xyrect.height",label:"xylabel.value",align:"xylabel.align",color:"xybutton.color","hover-color":"xybutton.hoverColor","label-color":"xybutton.labelColor"}}),AFRAME.registerPrimitive("a-xytoggle",{defaultComponents:{xyrect:{width:.8,height:.4},xytoggle:{}},mappings:{width:"xyrect.width",height:"xyrect.height",value:"xytoggle.value"}}),AFRAME.registerPrimitive("a-xyselect",{defaultComponents:{xyrect:{width:2,height:.5,updateGeometry:!0},xyselect:{}},mappings:{width:"xyrect.width",height:"xyrect.height",values:"xyselect.values",label:"xyselect.label",toggle:"xyselect.toggle",select:"xyselect.select",color:"xybutton.color","hover-color":"xybutton.hoverColor","label-color":"xybutton.labelColor"}}),AFRAME.registerPrimitive("a-xywindow",{defaultComponents:{xycontainer:{alignItems:"center"},xywindow:{}},mappings:{width:"xyrect.width",height:"xyrect.height",title:"xywindow.title"}}),AFRAME.registerPrimitive("a-xyscroll",{defaultComponents:{xyrect:{pivot:{x:0,y:1}},xyscroll:{}},mappings:{width:"xyrect.width",height:"xyrect.height",scrollbar:"xyscroll.scrollbar"}}),AFRAME.registerPrimitive("a-xyrange",{defaultComponents:{xyrange:{}},mappings:{width:"xyrect.width",height:"xyrect.height",min:"xyrange.min",max:"xyrange.max",step:"xyrange.step",value:"xyrange.value"}});