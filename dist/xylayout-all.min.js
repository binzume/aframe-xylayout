"use strict";if("undefined"==typeof AFRAME)throw"AFRAME is not loaded.";AFRAME.registerComponent("xycontainer",{dependencies:["xyrect"],schema:{spacing:{default:.05},padding:{default:0},reverse:{default:!1},wrap:{default:"nowrap",oneOf:["wrap","nowrap"]},direction:{default:"column",oneOf:["none","row","column","vertical","horizontal"]},alignItems:{default:"none",oneOf:["none","center","start","end","baseline","stretch"]},justifyItems:{default:"start",oneOf:["center","start","end","space-between","space-around","stretch"]},alignContent:{default:"",oneOf:["","none","start","end","center","stretch"]}},init(){this.el.addEventListener("xyresize",t=>this.requestLayoutUpdate()),this.requestLayoutUpdate()},_doLayout(t,e){let i=this.data;if("none"===i.direction)return;let s=this.el.children,l="vertical"===i.direction||"column"===i.direction,a=i.reverse^l?-1:1,n=l?[0,1,a,0]:[a,0,0,-1],r=l?(t,e)=>[e,t]:(t,e)=>[t,e],o=this.el.components.xyrect,h=r(t-2*i.padding,e-2*i.padding),d=[],c=0,u=0,p=0,m=0,g=0,y=[];for(let t=0;t<s.length;t++){let e=s[t],l=e.components.xyitem;if(l&&l.data.fixed)continue;let a=e.components.xyrect||e.getAttribute("geometry")||{width:1*e.getAttribute("width"),height:1*e.getAttribute("height")},n=e.getAttribute("scale")||{x:1,y:1},o={el:e,size:r(a.width,a.height),pivot:r(a.data?a.data.pivotX:.5,a.data?a.data.pivotY:.5),scale:r(n.x,n.y)};if(void 0===o.size[0]||isNaN(o.size[0]))continue;let x=c+o.size[0]*o.scale[0]+i.spacing*(d.length-1);"wrap"==i.wrap&&c>0&&x>h[0]&&(y.push({targets:d,sizeSum:c,growSum:u,shrinkSum:p,crossSize:m}),g+=m,d=[],c=0,u=0,p=0,m=0),d.push(o),c+=o.size[0]*o.scale[0],u+=l?l.data.grow:1,p+=l?l.data.shrink:1,m=o.size[1]>m?o.size[1]:m}if(d.length>0&&(y.push({targets:d,sizeSum:c,growSum:u,shrinkSum:p,crossSize:m}),g+=m),0==y.length)return;g+=i.spacing*(y.length-1);let x=r(o.data.pivotX,o.data.pivotY),b=-x[1]*h[1],v=0,w=(l?(x[0]-1)*e:-x[0]*t)+i.padding,E=i.alignContent||i.alignItems;"end"==E?b+=h[1]-g:"center"==E?b+=(h[1]-g)/2:"stretch"!=E&&"none"!=E||(v=(h[1]-g)/y.length),y.forEach(t=>{h[1]=t.crossSize+v,this._layoutLine(t.targets,t.sizeSum,t.growSum,t.shrinkSum,h,w,b,n,r),b+=h[1]+i.spacing})},_layoutLine(t,e,i,s,l,a,n,r,o){let h=o("width","height"),d=this.data.spacing,c=0,u=this.data.justifyItems;"center"===u?a+=(l[0]-e-d*t.length)/2:"end"===u?a+=l[0]-e-d*t.length:"stretch"===u?c=(c=l[0]-e-d*(t.length-1))>0?i>0?c/i:0:s>0?c/s:0:"space-between"===u?d=(l[0]-e)/(t.length-1):"space-around"===u&&(a+=.5*(d=(l[0]-e)/t.length));for(let e=0;e<t.length;e++){let i=t[e],s=i.el,o=s.components.xyitem,u=o&&o.data.align||this.data.alignItems,p=(o?c>0?o.data.grow:o.data.shrink:1)*c,m=i.size[0]*i.scale[0]+p,g=i.size[1],y=s.getAttribute("position")||{x:0,y:0,z:0},x=a+i.pivot[0]*m,b=n+.5*l[1];i.scale[0]>0&&0!=p&&s.setAttribute(h[0],i.size[0]+p/i.scale[0]),i.scale[1]>0&&"stretch"===u&&(g=l[1],s.setAttribute(h[1],g/i.scale[1])),"start"===u||"stretch"===u?b=n+i.pivot[1]*g:"end"===u?b=n+l[1]-(1-i.pivot[1])*g:"center"===u?b+=(i.pivot[1]-.5)*g:"none"===u&&(b+=r[1]*y.x+r[3]*y.y),y.x=r[0]*x+r[1]*b,y.y=r[2]*x+r[3]*b,s.setAttribute("position",y),a+=m+d}},requestLayoutUpdate(){let t=this.el.components.xyrect;this.data&&this._doLayout(t.width,t.height)}}),AFRAME.registerComponent("xyitem",{schema:{align:{default:"none",oneOf:["none","center","start","end","baseline","stretch"]},grow:{default:1},shrink:{default:1},fixed:{default:!1}},update(t){void 0!==t.align&&this.el.parent.components.xycontainer&&this.el.parent.components.xycontainer.requestLayoutUpdate()}}),AFRAME.registerComponent("xyrect",{schema:{width:{default:-1},height:{default:-1},pivotX:{default:.5},pivotY:{default:.5}},update(t){let e=this.data,i=this.el.getAttribute("geometry")||{},s=e.width,l=e.height;s<0&&(s=this.el.hasAttribute("width")?1*this.el.getAttribute("width"):i.width||0),l<0&&(l=this.el.hasAttribute("height")?1*this.el.getAttribute("height"):i.height||0),this.width=s,this.height=l,(this.el.components.rounded||"A-INPUT"==this.el.tagName)&&(e.pivotX=0,e.pivotY=1),void 0!==t.width&&this.el.emit("xyresize",{xyrect:this},!1)}}),AFRAME.registerComponent("xyclipping",{dependencies:["xyrect"],schema:{exclude:{type:"selector",default:null},clipTop:{default:!0},clipBottom:{default:!0},clipLeft:{default:!1},clipRight:{default:!1}},init(){this.el.sceneEl.renderer.localClippingEnabled=!0,this.clippingPlanesLocal=[],this.clippingPlanes=[],this.currentMatrix=null,this._filterEvent=this._filterEvent.bind(this),this.filterTargets=["click","mousedown","mouseenter","mouseleave","mousemove"],this.filterTargets.forEach(t=>this.el.addEventListener(t,this._filterEvent,!0))},update(){let t=this.el.components.xyrect,e=[];this.data.clipBottom&&e.push(new THREE.Plane(new THREE.Vector3(0,1,0),0)),this.data.clipTop&&e.push(new THREE.Plane(new THREE.Vector3(0,-1,0),t.height)),this.data.clipLeft&&e.push(new THREE.Plane(new THREE.Vector3(1,0,0),0)),this.data.clipRight&&e.push(new THREE.Plane(new THREE.Vector3(-1,0,0),t.width)),this.clippingPlanesLocal=e,this.clippingPlanes=[],this.updateMatrix()},remove(){this.filterTargets.forEach(t=>this.el.removeEventListener(t,this._filterEvent,!0)),this.clippingPlanes=[],this.applyClippings()},tick(){this.el.object3D.matrixWorld.equals(this.currentMatrix)||this.updateMatrix()},_filterEvent(t){if(!(t.path||t.composedPath()).includes(this.data.exclude)&&t.detail.intersection&&this.isClipped(t.detail.intersection.point)&&(t.stopPropagation(),t.detail.cursorEl&&t.detail.cursorEl.components.raycaster)){let e=t.detail.cursorEl.components.raycaster.intersectedEls,i=e.lastIndexOf(t.target);i>=0&&i+1<e.length&&e[i+1].dispatchEvent(new CustomEvent(t.type,t))}},updateMatrix(){this.currentMatrix=this.el.object3D.matrixWorld.clone();for(let t=0;t<this.clippingPlanesLocal.length;t++)this.clippingPlanes[t]=this.clippingPlanesLocal[t].clone().applyMatrix4(this.currentMatrix);this.applyClippings()},applyClippings(){let t=this.data.exclude&&this.data.exclude.object3D,e=i=>{if(i!==t){i.material&&void 0!==i.material.clippingPlanes&&(i.material.clippingPlanes=this.clippingPlanes);for(let t=0;t<i.children.length;t++)e(i.children[t])}};e(this.el.object3D)},isClipped(t){return this.clippingPlanes.some(e=>e.distanceToPoint(t)<0)}}),function(){let t={defaultComponents:{xyrect:{},xycontainer:{}},mappings:{width:"xyrect.width",height:"xyrect.height",direction:"xycontainer.direction",spacing:"xycontainer.spacing",padding:"xycontainer.padding",reverse:"xycontainer.reverse",wrap:"xycontainer.wrap","align-items":"xycontainer.alignItems","justify-items":"xycontainer.justifyItems"}};AFRAME.registerPrimitive("a-xycontainer",t),AFRAME.registerPrimitive("a-xylayout",t)}(),AFRAME.registerGeometry("xy-rounded-rect",{schema:{height:{default:1,min:0},width:{default:1,min:0},radius:{default:.05,min:0}},init(t){let e=new THREE.Shape,i=t.radius,s=t.width||.01,l=t.height||.01,a=-s/2,n=-l/2;e.moveTo(a,n+i),e.lineTo(a,n+l-i),e.quadraticCurveTo(a,n+l,a+i,n+l),e.lineTo(a+s-i,n+l),e.quadraticCurveTo(a+s,n+l,a+s,n+l-i),e.lineTo(a+s,n+i),e.quadraticCurveTo(a+s,n,a+s-i,n),e.lineTo(a+i,n),e.quadraticCurveTo(a,n,a,n+i),this.geometry=new THREE.ShapeGeometry(e)}}),AFRAME.registerComponent("xylabel",{dependencies:["xyrect"],schema:{resolution:{default:32},renderingMode:{default:"auto",oneOf:["auto","canvas"]},wrapCount:{default:0},xOffset:{default:0},zOffset:{default:.01},value:{default:""},color:{default:"white"},align:{default:"left"}},init(){this.el.addEventListener("xyresize",t=>this.update())},update(){let t=this.data,e=t.wrapCount,i=this.el.components.xyrect;if(""==t.value)return void this.remove();if(0==e){let s=i.height;if(s>0){let l=i.width;e=Math.max(l/s/.65,t.value.length)+1}}if("auto"==t.renderingMode&&!/[\u0100-\uDFFF]/.test(t.value)){let s=Object.assign({},t);delete s.resolution,delete s.renderingMode,s.wrapCount=e,s.width=i.width,s.height=i.height,this.el.setAttribute("text",s);let l=this.el.getObject3D("text");return l&&(l.raycast=function(){}),this.canvas=null,void this._removeObject3d()}this._removeText();let s=Math.floor(t.resolution*(.65*e)),l=Math.floor(t.resolution);if(!this.canvas||this.canvas.width!==s||this.canvas.height!==l){null==this.canvas&&(this.canvas=document.createElement("canvas")),this.canvas.height=l,this.canvas.width=s;let a=i.width||1,n=i.data.height>0?i.height:a/(.65*e),r=new THREE.CanvasTexture(this.canvas);r.anisotropy=4;let o=new THREE.MeshBasicMaterial({map:r,transparent:!0}),h=new THREE.Mesh(new THREE.PlaneGeometry(a,n),o);h.position.copy(new THREE.Vector3(t.xOffset,0,t.zOffset)),this._removeObject3d(),this.el.setObject3D("xylabel",h)}let a=this.canvas.getContext("2d");a.clearRect(0,0,s,l),a.font=.9*t.resolution+"px bold sans-serif",a.textBaseline="top",a.textAlign=t.align,a.fillStyle=t.color;let n="center"===t.align?s/2:0;a.fillText(t.value,n,.1*t.resolution),this.el.object3DMap.xylabel.material.map.needsUpdate=!0},remove(){this.canvas=null,this._removeObject3d(),this._removeText()},_removeText(){this.el.hasAttribute("text")&&this.el.removeAttribute("text")},_removeObject3d(){let t=this.el.getObject3D("xylabel");t&&(t.material.map.dispose(),t.material.dispose(),t.geometry.dispose(),this.el.removeObject3D("xylabel"))}}),AFRAME.registerComponent("xybutton",{dependencies:["xyrect"],schema:{color:{default:""},hoverColor:{default:""}},init(){let t=this.el.components.xyrect;this.el.sceneEl.systems.xywindow.createSimpleButton({width:t.width,height:t.height,color:this.data.color,hoverColor:this.data.hoverColor},null,this.el),this.el.addEventListener("xyresize",t=>{this.el.setAttribute("geometry",{width:t.detail.xyrect.width,height:t.detail.xyrect.height})})}}),AFRAME.registerComponent("xytoggle",{dependencies:["xyrect"],schema:{value:{default:!1}},init(){this.buttonParams={width:1,height:1},this.el.sceneEl.systems.xywindow.createSimpleButton(this.buttonParams,null,this.el),this.thumb=document.createElement("a-circle"),this.el.appendChild(this.thumb),this.el.addEventListener("click",t=>{this.el.setAttribute("xytoggle","value",!this.data.value),this.el.emit("change",{value:!this.data.value},!1)}),this.el.addEventListener("xyresize",t=>this.update())},update(){let t=this.el.sceneEl.systems.xywindow.theme,e=this.el.components.xyrect,i=this.buttonParams,s=this.data.value;i.color=s?"#0066ff":t.buttonColor,i.hoverColor=s?"#4499ff":"",this.el.setAttribute("material","color",i.color);let l=e.height/2;this.thumb.setAttribute("geometry","radius",.8*l),this.thumb.setAttribute("position",{x:(e.width/2-l)*(s?1:-1),y:0,z:.05}),this.el.setAttribute("geometry",{primitive:"xy-rounded-rect",width:e.width,height:2*l,radius:l})}}),AFRAME.registerComponent("xyselect",{dependencies:["xyrect","xybutton"],schema:{values:{default:[]},label:{default:""},toggle:{default:!1},select:{default:0}},init(){if(this.el.addEventListener("click",t=>{this.data.toggle?this.select((this.data.select+1)%this.data.values.length):this.listEl?this.hide():this.show()}),this.data.toggle)this.el.setAttribute("xylabel","align","center");else{let t=this.triangle=document.createElement("a-triangle");t.setAttribute("geometry",{vertexA:{x:.1,y:.03,z:0},vertexB:{x:-.1,y:.03,z:0},vertexC:{x:0,y:-.12,z:0}}),this.el.appendChild(t),this.el.addEventListener("xyresize",t=>this.update())}},update(){let t=this.data;this.el.setAttribute("xylabel",{value:t.label||t.values[t.select]}),this.triangle&&this.triangle.setAttribute("position",{x:this.el.components.xyrect.width/2-.3,y:0,z:.05})},show(){if(this.listEl)return;let t=(this.el.components.xyrect.height+.5*this.data.values.length)/2+.1;this.listEl=document.createElement("a-entity"),this.listEl.setAttribute("xycontainer",{spacing:0}),this.listEl.setAttribute("position",{x:0,y:t,z:.05}),this.el.appendChild(this.listEl),this.data.values.forEach((t,e)=>{let i=document.createElement("a-xybutton");i.setAttribute("label",t),i.addEventListener("click",t=>{t.stopPropagation(),this.select(e),this.hide()}),this.listEl.appendChild(i)}),setTimeout(()=>this.listEl&&this.listEl.setAttribute("xyrect",{width:2,height:.5*this.data.values.length}),0)},select(t){this.el.setAttribute("xyselect","select",t),this.el.emit("change",{value:this.data.values[t],index:t},!1)},hide(){this.listEl&&(this.el.removeChild(this.listEl),this.listEl.destroy(),this.listEl=null)}}),AFRAME.registerComponent("xy-draggable",{schema:{dragThreshold:{default:.02},preventClick:{default:!0},base:{type:"selector",default:null}},init(){this.el.classList.add(this.el.sceneEl.systems.xywindow.theme.collidableClass),this._onmousedown=this._onmousedown.bind(this),this.el.addEventListener("mousedown",this._onmousedown),this.dragFun=null},remove(){this.el.removeEventListener("mousedown",this._onmousedown)},tick(){null!==this.dragFun?this.dragFun("xy-drag"):this.pause()},_onmousedown(t){if(!t.detail.cursorEl||!t.detail.cursorEl.components.raycaster)return;let e=this.data.base||this.el,i=t.detail.cursorEl,s=i.components.raycaster.raycaster,l=new THREE.Plane(new THREE.Vector3(0,0,-1),0).applyMatrix4(e.object3D.matrixWorld),a=s.ray.direction.clone(),n=!1,r=new THREE.Vector3;null===s.ray.intersectPlane(l,r)&&e.object3D.worldToLocal(r);let o=s.ray.clone(),h=t=>{if(!n){if(a.manhattanDistanceTo(s.ray.direction)<this.data.dragThreshold)return;t="xy-dragstart",n=!0}let h=r.clone();null!==s.ray.intersectPlane(l,r)&&e.object3D.worldToLocal(r),this.el.emit(t,{raycaster:s,point:r,prevPoint:h,prevRay:o,cursorEl:i}),o.copy(s.ray)},d=this;this.dragFun=h,d.play();let c=e=>e.target!=t.target&&e.stopPropagation();window.addEventListener("mouseenter",c,!0),window.addEventListener("mouseleave",c,!0),window.addEventListener("mouseup",function t(e){if(e.detail.cursorEl==i&&(window.removeEventListener("mouseup",t),window.removeEventListener("mouseenter",c,!0),window.removeEventListener("mouseleave",c,!0),d.dragFun=null,n)){if(d.data.preventClick){let t=t=>t.stopPropagation();window.addEventListener("click",t,!0),setTimeout(()=>window.removeEventListener("click",t,!0),0)}setTimeout(()=>h("xy-dragend"),15)}})}}),AFRAME.registerComponent("xy-drag-control",{schema:{target:{type:"selector",default:null},draggable:{default:""},autoRotate:{default:!1},mode:{default:"grab"}},init(){this._ondrag=this._ondrag.bind(this),this.draggable=[]},update(t){let e=this.data.draggable;e!==t.draggable&&(this.remove(),this.draggable=Array.isArray(e)?e:""!=e?this.el.querySelectorAll(e):[this.el],this.draggable.forEach(t=>{t.setAttribute("xy-draggable",{}),t.addEventListener("xy-dragstart",this._ondrag),t.addEventListener("xy-drag",this._ondrag)}))},remove(){this.draggable.forEach(t=>{t.removeAttribute("xy-draggable"),t.removeEventListener("xy-dragstart",this._ondrag),t.removeEventListener("xy-drag",this._ondrag)})},_ondrag(t){let e,i=t.detail.raycaster.ray.direction,s=t.detail.prevRay.direction,l=this.data.target||this.el;t.detail.cursorEl.components["tracked-controls"]?(e="xy-dragstart"==t.type?new THREE.Quaternion:this.prevQ.inverse().premultiply(t.detail.cursorEl.object3D.quaternion),this.prevQ=t.detail.cursorEl.object3D.quaternion.clone()):e=(new THREE.Quaternion).setFromUnitVectors(s,i);let a=(new THREE.Matrix4).makeRotationFromQuaternion(e),n=t.detail.prevRay.origin,r=t.detail.raycaster.ray.origin,o=new THREE.Matrix4;if(a.multiply(o.makeTranslation(-n.x,-n.y,-n.z)),a.premultiply(o.makeTranslation(r.x,r.y,r.z)),l.object3D.applyMatrix(a),"pull"==this.data.mode){let e=l.object3D.getWorldPosition(new THREE.Vector3),a=i.clone().sub(s),n=2*e.distanceTo(t.detail.raycaster.ray.origin);l.object3D.position.add(i.clone().multiplyScalar(-a.y*n))}if(this.data.autoRotate){let e=this.el.sceneEl.camera.getWorldPosition(new THREE.Vector3),i=l.object3D.getWorldPosition(new THREE.Vector3),s=e.clone().sub(i).normalize(),a=.8-s.y*s.y;if(a>0){let s=(new THREE.Matrix4).lookAt(e,i,new THREE.Vector3(0,1,0)),n=(new THREE.Quaternion).setFromRotationMatrix(s),r=t.detail.cursorEl.components.raycaster.getIntersection(t.target),o=r?r.point:i,h=l.object3D.parent.worldToLocal(o),d=l.object3D.quaternion.clone();THREE.Quaternion.slerp(l.object3D.quaternion,n,l.object3D.quaternion,.1*a),l.object3D.position.sub(h).applyQuaternion(d.inverse().premultiply(l.object3D.quaternion)).add(h)}}}}),AFRAME.registerComponent("xywindow",{dependencies:["xycontainer"],schema:{title:{default:""},closable:{default:!0}},init(){this.theme=this.system.theme,this.controls=document.createElement("a-entity"),this.controls.setAttribute("position",{x:0,y:0,z:.05}),this.el.appendChild(this.controls);let t=this.system.createSimpleButton({width:1,height:.5,color:this.theme.windowTitleBarColor},this.controls);if(t.setAttribute("xy-drag-control",{target:this.el,autoRotate:!0}),this.dragButton=t,this.data.closable){let t=this.system.createSimpleButton({width:.5,height:.5,color:this.theme.windowTitleBarColor,hoverColor:this.theme.windowCloseButtonColor},this.controls);t.setAttribute("xylabel",{value:"X",align:"center",color:this.theme.buttonLabelColor}),t.addEventListener("click",t=>this.el.parentNode.removeChild(this.el)),this.closeButton=t}this.titleText=document.createElement("a-entity"),this.dragButton.appendChild(this.titleText),this.el.addEventListener("xyresize",t=>{this.update({})}),this.system.registerWindow(this)},remove(){this.system.unregisterWindow(this)},update(t){let e=this.el.components.xyrect,i=0;if(this.closeButton&&(this.closeButton.setAttribute("position",{x:e.width/2-.25,y:.3,z:0}),i+=.52),this.data.title!=t.title){let t=e.width-i-.2;this.titleText.setAttribute("xyrect",{width:t,height:.45}),this.titleText.setAttribute("xylabel",{value:this.data.title,wrapCount:Math.max(10,t/.2),color:this.theme.windowTitleColor,xOffset:.1})}this.controls.setAttribute("position","y",.5*e.height),this.dragButton.setAttribute("geometry","width",e.width-i),this.dragButton.setAttribute("position",{x:-i/2,y:.3,z:0})},setTitle(t){this.el.setAttribute("xywindow","title",t)}}),AFRAME.registerSystem("xywindow",{theme:{buttonColor:"#222",buttonHoverColor:"#333",buttonLabelColor:"#fff",buttonHoverHaptic:.3,buttonHoverHapticMs:10,buttonGeometry:"xy-rounded-rect",windowCloseButtonColor:"#f00",windowTitleBarColor:"#111",windowTitleColor:"#fff",collidableClass:"collidable"},windows:[],createSimpleButton(t,e,i){let s=i||document.createElement("a-entity");return s.hasAttribute("geometry")||s.setAttribute("geometry",{primitive:this.theme.buttonGeometry,width:t.width,height:t.height}),s.classList.add(this.theme.collidableClass),s.addEventListener("mouseenter",e=>{let i=this.theme;if(s.setAttribute("material",{color:t.hoverColor||this.theme.buttonHoverColor}),i.buttonHoverHaptic&&e.detail.cursorEl.components["tracked-controls"]){let t=e.detail.cursorEl.components["tracked-controls"].controller;t&&t.hapticActuators&&t.hapticActuators.length>0&&t.hapticActuators[0].pulse(i.buttonHoverHaptic,i.buttonHoverHapticMs)}}),s.addEventListener("mouseleave",e=>{s.setAttribute("material",{color:t.color||this.theme.buttonColor})}),s.setAttribute("material",{color:t.color||this.theme.buttonColor}),e&&e.appendChild(s),s},registerWindow(t){this.windows.push(t)},unregisterWindow(t){let e=this.windows.indexOf(t);e>=0&&this.windows.splice(e,1)}}),AFRAME.registerComponent("xyrange",{dependencies:["xyrect"],schema:{min:{default:0},max:{default:100},step:{default:0},value:{default:0},thumbSize:{default:.4}},init(){let t=this.data;this.value=t.value,this.bar=document.createElement("a-entity"),this.bar.setAttribute("geometry",{primitive:"plane",width:this.el.components.xyrect.width-t.thumbSize,height:.05}),this.bar.setAttribute("material",{color:"#fff"}),this.el.appendChild(this.bar),this.dragging=!1,this.thumb=this.el.sceneEl.systems.xywindow.createSimpleButton({width:t.thumbSize,height:t.thumbSize},this.el),this.thumb.setAttribute("xy-draggable",{base:this.el}),this.thumb.addEventListener("xy-drag",e=>{this.dragging=!0;let i=this.el.components.xyrect.width-t.thumbSize,s=(e.detail.point.x+.5*i)/i*(t.max-t.min);t.step>0&&(s=Math.round(s/t.step)*t.step),this.setValue(s+t.min,!0),this.el.emit("change",{value:this.value},!1)}),this.thumb.addEventListener("xy-dragend",t=>this.dragging=!1)},update(){let t=this.data;if(t.max<=t.min)return;let e=this.el.components.xyrect.width-t.thumbSize;this.thumb.setAttribute("position",{x:e*(t.value-t.min)/(t.max-t.min)-.5*e,y:0,z:.01})},setValue(t,e){this.dragging&&!e||(this.value=Math.max(Math.min(t,this.data.max),this.data.min),this.el.setAttribute("xyrange","value",this.value))}}),AFRAME.registerComponent("xyscroll",{dependencies:["xyrect"],schema:{scrollbar:{default:!0}},init(){this.scrollX=0,this.scrollY=0,this.speedY=0,this.contentHeight=0,this.thumbLen=.2,this.control=this._initScrollBar(this.el,.3),this.el.setAttribute("xyclipping",{exclude:this.control}),this.el.setAttribute("xy-draggable",{}),this.el.addEventListener("xy-drag",t=>{this.speedY=0,this.setScroll(this.scrollX,this.scrollY+t.detail.point.y-t.detail.prevPoint.y)}),this.el.addEventListener("xy-dragend",t=>{this.speedY=t.detail.point.y-t.detail.prevPoint.y,this.play()}),this.el.addEventListener("xyresize",t=>this.update());let t=this.el.children;for(let e=0;e<t.length;e++)t[e]!=this.control&&t[e].addEventListener("xyresize",t=>this.update())},_initScrollBar(t,e){let i=document.createElement("a-entity");return t.appendChild(i),this.scrollBar=i,this.upButton=this.el.sceneEl.systems.xywindow.createSimpleButton({width:e,height:.3},i),this.upButton.addEventListener("click",t=>{this.speedY=.3*-this.scrollDelta,this.play()}),this.downButton=this.el.sceneEl.systems.xywindow.createSimpleButton({width:e,height:.3},i),this.downButton.addEventListener("click",t=>{this.speedY=.3*this.scrollDelta,this.play()}),this.scrollThumb=this.el.sceneEl.systems.xywindow.createSimpleButton({width:.7*e,height:this.thumbLen},i),this.scrollThumb.setAttribute("xy-draggable",{base:i}),this.scrollThumb.addEventListener("xy-drag",t=>{let e=this.el.components.xyrect,i=this.thumbLen,s=(this.scrollStart-i/2-t.detail.point.y)*Math.max(.01,this.contentHeight-e.height)/(this.scrollLength-i);this.setScroll(this.scrollX,s)}),i},update(){let t=this.el.components.xyrect,e=t.height;this.scrollBar.setAttribute("visible",this.data.scrollbar),this.scrollBar.setAttribute("position",{x:t.width+.1,y:0,z:.05}),this.upButton.setAttribute("position",{x:0,y:e-.15,z:0}),this.downButton.setAttribute("position",{x:0,y:.15,z:0}),this.scrollDelta=Math.max(e/2,.5),this.scrollStart=e-.3,this.scrollLength=e-.6,this.setScroll(0,0)},tick(){Math.abs(this.speedY)>.001?(this.setScroll(this.scrollX,this.scrollY+this.speedY),this.speedY*=.8):this.pause()},setScroll(t,e){let i=this.el.children,s=0;for(let t=0;t<i.length;t++){let e=i[t];e!==this.control&&(e.components.xyrect||e.setAttribute("xyrect",{}),s=Math.max(s,e.components.xyrect.height))}this.contentHeight=s;let l=this.el.components.xyrect;this.scrollX=Math.max(0,t),this.scrollY=Math.max(0,Math.min(e,s-l.height));let a=Math.max(.2,Math.min(this.scrollLength*l.height/s,this.scrollLength)),n=this.scrollStart-a/2-(this.scrollLength-a)*this.scrollY/Math.max(.01,s-l.height);this.thumbLen=a,this.scrollThumb.hasAttribute("geometry")&&this.scrollThumb.setAttribute("geometry","height",a),this.scrollThumb.setAttribute("position","y",n);for(let t=0;t<i.length;t++){let e=i[t];if(e===this.control)continue;if(e.components.xyitem&&e.components.xyitem.data.fixed)continue;let s=e.getAttribute("position"),a=e.components.xyrect;s.x=-this.scrollX+a.data.pivotX*a.width,s.y=this.scrollY-(1-a.data.pivotY)*a.height+l.height,e.setAttribute("position",s);let n=a.height-this.scrollY;e.emit("xyviewport",[n,n-l.height,this.scrollX,this.scrollX+l.width],!1)}this.el.components.xyclipping&&this.el.components.xyclipping.applyClippings()}}),AFRAME.registerComponent("xylist",{dependencies:["xyrect"],schema:{itemWidth:{default:-1},itemHeight:{default:-1},vertical:{default:!0}},init(){this.elementFactory=null,this.elementUpdator=null,this.elements=[],this.userData=null,this.itemCount=0,this.el.setAttribute("xyrect",{pivotX:0,pivotY:0}),this.setViewPort([0,0]),this.el.addEventListener("xyviewport",t=>this.setViewPort(t.detail)),this.el.classList.add(this.el.sceneEl.systems.xywindow.theme.collidableClass),this.el.addEventListener("click",t=>{let e=t.path||t.composedPath();for(let i=0;i<e.length;i++){let s=e[i].dataset.listPosition;if(null!=s&&-1!=s){this.el.emit("clickitem",{index:s,ev:t},!1);break}}})},setCallback(t,e){if(this.elementFactory=t,this.elementUpdator=e,this.data.itemHeight<=0){let t=this.elementFactory(this.el,this.userData);this.data.itemHeight=1*t.getAttribute("height"),this.data.itemWidth=1*t.getAttribute("width")}},setContents(t,e){this.userData=t,this.itemCount=void 0!==e?e:t.length;let i=this.data.itemHeight*this.itemCount;this.el.setAttribute("xyrect",{width:this.data.itemWidth,height:i});for(let t of this.elements)t.setAttribute("visible",!1),t.dataset.listPosition=-1;this.refresh()},setViewPort(t){this.top=t[0],this.bottom=t[1],this.refresh()},refresh(){if(!this.elementFactory)return;let t=this.data.itemHeight,e=t*this.itemCount,i=Math.max(Math.floor((e-this.top)/t),0),s=Math.min(Math.ceil((e-this.bottom)/t),this.itemCount),l=s-i+1;for(;l>this.elements.length;){let t=this.elementFactory(this.el,this.userData);t.classList.add(this.el.sceneEl.systems.xywindow.theme.collidableClass),this.el.appendChild(t),this.elements.push(t)}let a=!1;for(let e=i;e<s;e++){let i=this.elements[e%this.elements.length];if(i.hasLoaded){if(i.dataset.listPosition!=e){i.dataset.listPosition=e;let s=0,l=(this.itemCount-e-1)*t,a=i.components.xyrect;a&&(s+=a.data.pivotX*a.width,l+=a.data.pivotY*a.height),i.setAttribute("position",{x:s,y:l,z:0}),this.elementUpdator&&this.elementUpdator(e,i,this.userData)}}else a=!0}a&&setTimeout(()=>this.refresh(),100);for(let t of this.elements){let e=t.dataset.listPosition;t.setAttribute("visible",e>=i&&e<s)}}}),AFRAME.registerComponent("xycanvas",{schema:{width:{default:100},height:{default:100}},init(){this.canvas=document.createElement("canvas"),this.canvas.id="_CANVAS"+Math.random();let t=new THREE.CanvasTexture(this.canvas);this.updateTexture=function(){t.needsUpdate=!0},this.el.setAttribute("material",{shader:"flat",npot:!0,src:t,transparent:!0})},update(){this.canvas.width=this.data.width,this.canvas.height=this.data.height}}),AFRAME.registerPrimitive("a-xylabel",{defaultComponents:{xyrect:{},xylabel:{}},mappings:{width:"xyrect.width",height:"xyrect.height",value:"xylabel.value",color:"xylabel.color",align:"xylabel.align","wrap-count":"xylabel.wrapCount"}}),AFRAME.registerPrimitive("a-xybutton",{defaultComponents:{xyrect:{width:2,height:.5},xylabel:{align:"center"},xybutton:{}},mappings:{width:"xyrect.width",height:"xyrect.height",label:"xylabel.value",align:"xylabel.align"}}),AFRAME.registerPrimitive("a-xytoggle",{defaultComponents:{xyrect:{width:.8,height:.4},xytoggle:{}},mappings:{width:"xyrect.width",height:"xyrect.height",value:"xytoggle.value"}}),AFRAME.registerPrimitive("a-xyselect",{defaultComponents:{xyrect:{width:2,height:.5},xyselect:{}},mappings:{width:"xyrect.width",height:"xyrect.height",values:"xyselect.values",label:"xyselect.label",toggle:"xyselect.toggle",select:"xyselect.select"}}),AFRAME.registerPrimitive("a-xywindow",{defaultComponents:{xycontainer:{alignItems:"stretch"},xywindow:{}},mappings:{width:"xyrect.width",height:"xyrect.height",direction:"xycontainer.direction",title:"xywindow.title"}}),AFRAME.registerPrimitive("a-xyscroll",{defaultComponents:{xyrect:{pivotX:0,pivotY:1},xyscroll:{}},mappings:{width:"xyrect.width",height:"xyrect.height",scrollbar:"xyscroll.scrollbar"}}),AFRAME.registerPrimitive("a-xyrange",{defaultComponents:{xyrect:{},xyrange:{}},mappings:{min:"xyrange.min",max:"xyrange.max",step:"xyrange.step",value:"xyrange.value",width:"xyrect.width",height:"xyrect.height"}});