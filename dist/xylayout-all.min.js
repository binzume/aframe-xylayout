"use strict";if("undefined"==typeof AFRAME)throw"AFRAME is not loaded.";AFRAME.registerComponent("xycontainer",{dependencies:["xyrect"],schema:{spacing:{default:.05},padding:{default:0},reverse:{default:!1},wrap:{default:"nowrap",oneOf:["wrap","nowrap"]},direction:{default:"vertical",oneOf:["none","row","column","vertical","horizontal"]},alignItems:{default:"none",oneOf:["none","center","start","end","baseline","stretch"]},justifyItems:{default:"start",oneOf:["center","start","end","space-between","space-around","stretch"]},alignContent:{default:"",oneOf:["","none","start","end","center","stretch"]}},init(){this.el.addEventListener("xyresize",t=>{this._doLayout(t.detail.xyrect.width,t.detail.xyrect.height)}),this.requestLayoutUpdate()},_doLayout(t,e){let i=this.data;if("none"===i.direction)return;let s=this.el.children,a="vertical"===i.direction||"column"===i.direction,l=i.reverse^a?-1:1,n=a?[0,1,l,0]:[l,0,0,-1],o=this.el.components.xyrect,r=[(a?e:t)-2*i.padding,(a?t:e)-2*i.padding],h=[],d=0,c=0,u=0,p=0,m=0,g=[];for(var y=0;y<s.length;y++){let t=s[y],e=t.components.xyitem;if(e&&e.data.fixed)continue;let l=t.components.xyrect||{width:1*t.getAttribute("width"),height:1*t.getAttribute("height")},n=t.getAttribute("scale")||{x:1,y:1},o=a?{el:t,sizeMain:l.height,sizeCross:l.width,pivotMain:l.data?l.data.pivotY:.5,pivotCross:l.data?l.data.pivotX:.5,scaleMain:n.y,scaleCross:n.x}:{el:t,sizeMain:l.width,sizeCross:l.height,pivotMain:l.data?l.data.pivotX:.5,pivotCross:l.data?l.data.pivotY:.5,scaleMain:n.x,scaleCross:n.y};if(void 0===o.sizeMain||isNaN(o.sizeMain))continue;let x=d+o.sizeMain*o.scaleMain+i.spacing*(h.length-1);"wrap"==i.wrap&&d>0&&x>r[0]&&(g.push({targets:h,sizeSum:d,growSum:c,shrinkSum:u,crossSize:p}),m+=p,h=[],d=0,c=0,u=0,p=0),h.push(o),d+=o.sizeMain*o.scaleMain,c+=e?e.data.grow:1,u+=e?e.data.shrink:1,p=o.sizeCross>p?o.sizeCross:p}if(h.length>0&&(g.push({targets:h,sizeSum:d,growSum:c,shrinkSum:u,crossSize:p}),m+=p),0==g.length)return;m+=i.spacing*(g.length-1);let x=-(a?o.data.pivotX:o.data.pivotY)*r[1],b=0,v=(a?(o.data.pivotY-1)*e:-o.data.pivotX*t)+i.padding,w=i.alignContent||i.alignItems;"end"==w?x+=r[1]-m:"center"==w?x+=(r[1]-m)/2:"stretch"!=w&&"none"!=w||(b=(r[1]-m)/g.length),g.forEach(t=>{r[1]=t.crossSize+b,this._layoutLine(t.targets,t.sizeSum,t.growSum,t.shrinkSum,r,v,x,n),x+=r[1]+i.spacing})},_layoutLine(t,e,i,s,a,l,n,o){let r=0!=o[1]?"height":"width",h=0!=o[1]?"width":"height",d=this.data.spacing,c=0,u=this.data.justifyItems;"center"===u?l+=(a[0]-e-d*t.length)/2:"end"===u?l+=a[0]-e-d*t.length:"stretch"===u?c=(c=a[0]-e-d*(t.length-1))>0?i>0?c/i:0:s>0?c/s:0:"space-between"===u?d=(a[0]-e)/(t.length-1):"space-around"===u&&(l+=.5*(d=(a[0]-e)/t.length));for(var p=0;p<t.length;p++){let e=t[p],i=e.el,s=i.components.xyitem,u=s&&s.data.align||this.data.alignItems,m=(s?c>0?s.data.grow:s.data.shrink:1)*c,g=e.sizeMain*e.scaleMain+m,y=e.sizeCross;e.scaleMain>0&&0!=m&&i.setAttribute(r,e.sizeMain+m/e.scaleMain),e.scaleCross>0&&"stretch"===u&&(y=a[1],i.setAttribute(h,y/e.scaleCross));let x=i.getAttribute("position")||{x:0,y:0,z:0},b=l+e.pivotMain*g,v=n+.5*a[1];"start"===u||"stretch"===u?v=n+e.pivotCross*y:"end"===u?v=n+a[1]-(1-e.pivotCross)*y:"center"===u?v+=(e.pivotCross-.5)*y:"none"===u&&(v+=o[1]*x.x+o[3]*x.y),x.x=o[0]*b+o[1]*v,x.y=o[2]*b+o[3]*v,i.setAttribute("position",x),l+=g+d}},requestLayoutUpdate(){let t=this.el.components.xyrect;this.data&&this._doLayout(t.width,t.height)}}),AFRAME.registerComponent("xyitem",{schema:{align:{default:"none",oneOf:["none","center","start","end","baseline","stretch"]},grow:{default:1},shrink:{default:1},fixed:{default:!1}},update(t){void 0!==t.align&&this.el.parent.components.xycontainer&&this.el.parent.components.xycontainer.requestLayoutUpdate()}}),AFRAME.registerComponent("xyrect",{dependencies:["position"],schema:{width:{default:-1},height:{default:-1},pivotX:{default:.5},pivotY:{default:.5}},init(){this.height=0,this.width=0},update(t){let e=this.data;(this.el.components.rounded||"A-INPUT"==this.el.tagName)&&(e.pivotX=0,e.pivotY=1);let i=this.el.components.geometry;e.width>=0?this.width=e.width:this.el.hasAttribute("width")?this.width=1*this.el.getAttribute("width"):i&&(this.width=i.data.width||0),e.height>=0?this.height=e.height:this.el.hasAttribute("height")?this.height=1*this.el.getAttribute("height"):i&&(this.height=i.data.height||0),void 0!==t.width&&this.el.dispatchEvent(new CustomEvent("xyresize",{detail:{xyrect:this}}))}}),AFRAME.registerComponent("xyclipping",{dependencies:["xyrect"],schema:{exclude:{type:"selector",default:null},clipTop:{default:!0},clipBottom:{default:!0},clipLeft:{default:!1},clipRight:{default:!1}},init(){this.el.sceneEl.renderer.localClippingEnabled=!0,this.clippingPlanesLocal=[],this.clippingPlanes=[],this.currentMatrix=null,this.el.classList.add("clickable"),this._filterEvent=this._filterEvent.bind(this),this.filterTargets=["click","mousedown","mouseenter","mouseleave","mousemove"],this.filterTargets.forEach(t=>this.el.addEventListener(t,this._filterEvent,!0))},update(){this.clippingPlanes=[],this.clippingPlanesLocal=[];let t=this.el.components.xyrect;this.data.clipBottom&&this.clippingPlanesLocal.push(new THREE.Plane(new THREE.Vector3(0,1,0),0)),this.data.clipTop&&this.clippingPlanesLocal.push(new THREE.Plane(new THREE.Vector3(0,-1,0),t.height)),this.data.clipLeft&&this.clippingPlanesLocal.push(new THREE.Plane(new THREE.Vector3(1,0,0),0)),this.data.clipRight&&this.clippingPlanesLocal.push(new THREE.Plane(new THREE.Vector3(-1,0,0),t.width)),this.updateMatrix()},remove(){this.filterTargets.forEach(t=>this.el.removeEventListener(t,this._filterEvent,!0)),this.clippingPlanes=[],this.applyClippings()},tick(){this.el.object3D.matrixWorld.equals(this.currentMatrix)||this.updateMatrix()},_filterEvent(t){if(!(t.path||t.composedPath()).includes(this.data.exclude)&&t.detail.intersection&&this.isClipped(t.detail.intersection.point)&&(t.stopPropagation(),t.detail.cursorEl&&t.detail.cursorEl.components.raycaster)){let e=t.detail.cursorEl.components.raycaster.intersectedEls,i=e.lastIndexOf(t.target);i>=0&&i+1<e.length&&e[i+1].dispatchEvent(new CustomEvent(t.type,t))}},updateMatrix(){this.currentMatrix=this.el.object3D.matrixWorld.clone();for(var t=0;t<this.clippingPlanesLocal.length;t++)this.clippingPlanes[t]=this.clippingPlanesLocal[t].clone().applyMatrix4(this.currentMatrix);this.applyClippings()},applyClippings(){let t=this.data.exclude&&this.data.exclude.object3D,e=i=>{if(i!==t){i.material&&void 0!==i.material.clippingPlanes&&(i.material.clippingPlanes=this.clippingPlanes);for(var s=0;s<i.children.length;s++)e(i.children[s])}};e(this.el.object3D)},isClipped(t){return this.clippingPlanes.some(e=>e.distanceToPoint(t)<0)}}),function(){let t={defaultComponents:{xyrect:{},xycontainer:{}},mappings:{width:"xyrect.width",height:"xyrect.height",direction:"xycontainer.direction",spacing:"xycontainer.spacing",padding:"xycontainer.padding",reverse:"xycontainer.reverse",wrap:"xycontainer.wrap","align-items":"xycontainer.alignItems","justify-items":"xycontainer.justifyItems"}};AFRAME.registerPrimitive("a-xycontainer",t),AFRAME.registerPrimitive("a-xylayout",t)}(),AFRAME.registerGeometry("xy-rounded-rect",{schema:{height:{default:1,min:0},width:{default:1,min:0},radius:{default:.05,min:0}},init(t){let e=new THREE.Shape,i=t.radius,s=t.width||.01,a=t.height||.01,l=-s/2,n=-a/2;e.moveTo(l,n+i),e.lineTo(l,n+a-i),e.quadraticCurveTo(l,n+a,l+i,n+a),e.lineTo(l+s-i,n+a),e.quadraticCurveTo(l+s,n+a,l+s,n+a-i),e.lineTo(l+s,n+i),e.quadraticCurveTo(l+s,n,l+s-i,n),e.lineTo(l+i,n),e.quadraticCurveTo(l,n,l,n+i),this.geometry=new THREE.ShapeGeometry(e)}}),AFRAME.registerComponent("xylabel",{dependencies:["xyrect"],schema:{resolution:{default:32},renderingMode:{default:"auto",oneOf:["auto","canvas"]},wrapCount:{default:0},zOffset:{default:.01},value:{default:""},color:{default:"white"},align:{default:"left"}},init(){this.el.addEventListener("xyresize",t=>this.update())},update(){let t=this.data,e=t.wrapCount,i=this.el.components.xyrect;if(""==t.value)return void this.remove();if(0==e){let s=i.height;if(s>0){let a=i.width;e=Math.max(a/s/.65,t.value.length)+1}}if("auto"==t.renderingMode&&!/[\u0100-\uDFFF]/.test(t.value)){let s=Object.assign({},t);delete s.resolution,delete s.renderingMode,s.wrapCount=e,s.width=i.width,s.height=i.height,this.el.setAttribute("text",s);let a=this.el.getObject3D("text");return a&&(a.raycast=function(){}),this.canvas=null,void this._removeObject3d()}this._removeText();let s=Math.floor(t.resolution*(.65*e)),a=Math.floor(t.resolution);if(!this.canvas||this.canvas.width!==s||this.canvas.height!==a){null==this.canvas&&(this.canvas=document.createElement("canvas")),this.canvas.height=a,this.canvas.width=s;let l=i.width||1,n=i.data.height>0?i.height:l/(.65*e),o=new THREE.CanvasTexture(this.canvas);o.anisotropy=4;let r=new THREE.MeshBasicMaterial({map:o,transparent:!0});this._removeObject3d(),this.el.setObject3D("xylabel",new THREE.Mesh(new THREE.PlaneGeometry(l,n),r)),this.el.object3DMap.xylabel.position.copy(new THREE.Vector3(0,0,t.zOffset))}let l=this.canvas.getContext("2d");l.clearRect(0,0,s,a),l.font=.9*t.resolution+"px bold sans-serif",l.textBaseline="top",l.textAlign=t.align,l.fillStyle=t.color;let n="center"===t.align?s/2:0;l.fillText(t.value,n,.1*t.resolution),this.el.object3DMap.xylabel.material.map.needsUpdate=!0},remove(){this.canvas=null,this._removeObject3d(),this._removeText()},_removeText(){this.el.hasAttribute("text")&&this.el.removeAttribute("text")},_removeObject3d(){let t=this.el.getObject3D("xylabel");t&&(t.material.map.dispose(),t.material.dispose(),t.geometry.dispose(),this.el.removeObject3D("xylabel"))}}),AFRAME.registerComponent("xybutton",{dependencies:["xyrect"],schema:{label:{default:""},labelColor:{default:""},color:{default:""},hoverColor:{default:""}},init(){this.el.sceneEl.systems.xywindow.createSimpleButton({width:this.el.components.xyrect.width,height:this.el.components.xyrect.height,color:this.data.color,hoverColor:this.data.hoverColor},null,this.el),this.el.addEventListener("xyresize",t=>{this.el.setAttribute("geometry",{width:t.detail.xyrect.width,height:t.detail.xyrect.height})})},update(t){this.data.label!==t.label&&this.el.setAttribute("xylabel",{value:this.data.label,color:this.data.labelColor,align:"center"})}}),AFRAME.registerComponent("xyselect",{dependencies:["xyrect","xybutton"],schema:{values:{default:[]},label:{default:""},toggle:{default:!1},select:{default:0}},init(){this.el.addEventListener("click",t=>{if(this.data.toggle){let t=(this.data.select+1)%this.data.values.length;this.el.setAttribute("xyselect","select",t),this.el.dispatchEvent(new CustomEvent("change",{detail:{value:this.data.values[t],index:t}}))}else this.listEl?this.hide():this.show()})},update(){this.el.setAttribute("xybutton",{label:this.data.label||this.data.values[this.data.select]})},show(){if(this.listEl)return;let t=(this.el.components.xyrect.height+.5*this.data.values.length)/2+.1;this.listEl=document.createElement("a-entity"),this.listEl.setAttribute("xycontainer",{spacing:0}),this.listEl.setAttribute("position",{x:0,y:t,z:.05}),this.el.appendChild(this.listEl),this.data.values.forEach((t,e)=>{let i=document.createElement("a-xybutton");i.setAttribute("xybutton",{label:t}),i.addEventListener("click",i=>{i.stopPropagation(),this.el.setAttribute("xybutton",{label:this.data.label||t}),this.el.dispatchEvent(new CustomEvent("change",{detail:{value:t,index:e}})),this.hide()}),this.listEl.appendChild(i)}),setTimeout(()=>this.listEl&&this.listEl.setAttribute("xyrect",{width:2,height:.5*this.data.values.length}),0)},hide(){this.listEl&&(this.el.removeChild(this.listEl),this.listEl.destroy(),this.listEl=null)}}),AFRAME.registerComponent("xy-draggable",{schema:{dragThreshold:{default:.02},preventClick:{default:!0},base:{type:"selector",default:null}},init(){this.el.classList.add(this.el.sceneEl.systems.xywindow.theme.collidableClass),this._onmousedown=this._onmousedown.bind(this),this.el.addEventListener("mousedown",this._onmousedown),this.dragFun=null},remove(){this.el.removeEventListener("mousedown",this._onmousedown)},tick(){null!==this.dragFun?this.dragFun("xy-drag"):this.pause()},_onmousedown(t){if(!t.detail.cursorEl||!t.detail.cursorEl.components.raycaster)return;let e=this.data.base||this.el,i=t.detail.cursorEl,s=i.components.raycaster.raycaster,a=new THREE.Plane(new THREE.Vector3(0,0,-1),0).applyMatrix4(e.object3D.matrixWorld),l=s.ray.direction.clone(),n=!1,o=new THREE.Vector3;null===s.ray.intersectPlane(a,o)&&e.object3D.worldToLocal(o);let r=s.ray.clone(),h=t=>{if(!n){if(l.manhattanDistanceTo(s.ray.direction)<this.data.dragThreshold)return;t="xy-dragstart",n=!0}let h=o.clone();null!==s.ray.intersectPlane(a,o)&&e.object3D.worldToLocal(o),this.el.emit(t,{raycaster:s,point:o,prevPoint:h,prevRay:r,cursorEl:i}),r.copy(s.ray)},d=this;this.dragFun=h,d.play();let c=e=>e.target!=t.target&&e.stopPropagation();window.addEventListener("mouseenter",c,!0),window.addEventListener("mouseleave",c,!0),window.addEventListener("mouseup",function t(e){if(e.detail.cursorEl==i&&(window.removeEventListener("mouseup",t),window.removeEventListener("mouseenter",c,!0),window.removeEventListener("mouseleave",c,!0),d.dragFun=null,n)){if(d.data.preventClick){let t=t=>t.stopPropagation();window.addEventListener("click",t,!0),setTimeout(()=>window.removeEventListener("click",t,!0),0)}setTimeout(()=>h("xy-dragend"),15)}})}}),AFRAME.registerComponent("xy-drag-control",{schema:{target:{type:"selector",default:null},draggable:{default:""},autoRotate:{default:!1},mode:{default:"grab"}},init(){this._ondrag=this._ondrag.bind(this),this.draggable=[]},update(t){let e=this.data.draggable;e!==t.draggable&&(this.remove(),this.draggable=Array.isArray(e)?e:""!=e?this.el.querySelectorAll(e):[this.el],this.draggable.forEach(t=>{t.setAttribute("xy-draggable",{}),t.addEventListener("xy-dragstart",this._ondrag),t.addEventListener("xy-drag",this._ondrag)}))},remove(){this.draggable.forEach(t=>{t.removeAttribute("xy-draggable"),t.removeEventListener("xy-dragstart",this._ondrag),t.removeEventListener("xy-drag",this._ondrag)})},_ondrag(t){let e,i=t.detail.raycaster.ray.direction,s=t.detail.prevRay.direction,a=this.data.target||this.el;t.detail.cursorEl.components["tracked-controls"]?(e="xy-dragstart"==t.type?new THREE.Quaternion:this.prevQ.inverse().premultiply(t.detail.cursorEl.object3D.quaternion),this.prevQ=t.detail.cursorEl.object3D.quaternion.clone()):e=(new THREE.Quaternion).setFromUnitVectors(s,i);let l=(new THREE.Matrix4).makeRotationFromQuaternion(e),n=t.detail.prevRay.origin,o=t.detail.raycaster.ray.origin,r=new THREE.Matrix4;if(l.multiply(r.makeTranslation(-n.x,-n.y,-n.z)),l.premultiply(r.makeTranslation(o.x,o.y,o.z)),a.object3D.applyMatrix(l),"pull"==this.data.mode){let e=a.object3D.getWorldPosition(new THREE.Vector3),l=i.clone().sub(s),n=2*e.distanceTo(t.detail.raycaster.ray.origin);a.object3D.position.add(i.clone().multiplyScalar(-l.y*n))}if(this.data.autoRotate){let e=this.el.sceneEl.camera.getWorldPosition(new THREE.Vector3),i=a.object3D.getWorldPosition(new THREE.Vector3),s=e.clone().sub(i).normalize(),l=.8-s.y*s.y;if(l>0){let s=(new THREE.Matrix4).lookAt(e,i,new THREE.Vector3(0,1,0)),n=(new THREE.Quaternion).setFromRotationMatrix(s),o=t.detail.cursorEl.components.raycaster.getIntersection(t.target),r=o?o.point:i,h=a.object3D.parent.worldToLocal(r),d=a.object3D.quaternion.clone();THREE.Quaternion.slerp(a.object3D.quaternion,n,a.object3D.quaternion,.1*l),a.object3D.position.sub(h).applyQuaternion(d.inverse().premultiply(a.object3D.quaternion)).add(h)}}}}),AFRAME.registerComponent("xywindow",{dependencies:["xycontainer"],schema:{title:{default:""},closable:{default:!0}},init(){this.theme=this.system.theme,this.controls=document.createElement("a-entity"),this.controls.setAttribute("position",{x:0,y:0,z:.05}),this.el.appendChild(this.controls);let t=this.system.createSimpleButton({width:1,height:.5,color:this.theme.windowTitleBarColor},this.controls);if(t.setAttribute("xy-drag-control",{target:this.el,autoRotate:!0}),this.dragButton=t,this.data.closable){let t=this.system.createSimpleButton({width:.5,height:.5,color:this.theme.windowTitleBarColor,hoverColor:this.theme.windowCloseButtonColor},this.controls);t.setAttribute("xylabel",{value:"X",align:"center",color:this.theme.buttonLabelColor}),t.addEventListener("click",t=>this.el.parentNode.removeChild(this.el)),this.closeButton=t}this.titleText=document.createElement("a-entity"),this.controls.appendChild(this.titleText),this.el.addEventListener("xyresize",t=>{this.update({})}),this.system.registerWindow(this)},remove(){this.system.unregisterWindow(this)},update(t){let e=this.el.components.xyrect,i=0;if(this.closeButton&&(this.closeButton.setAttribute("position",{x:e.width/2-.25,y:.3,z:0}),i+=.52),this.data.title!=t.title){let t=e.width-i-.2;this.titleText.setAttribute("xyrect",{width:t,height:.45}),this.titleText.setAttribute("xylabel",{value:this.data.title,wrapCount:Math.max(10,t/.2),color:this.theme.windowTitleColor})}this.controls.setAttribute("position","y",.5*e.height),this.dragButton.setAttribute("geometry","width",e.width-i),this.dragButton.setAttribute("position",{x:-i/2,y:.3,z:0}),this.titleText.setAttribute("position",{x:-i/2+.1,y:.3,z:.02})},setTitle(t){this.el.setAttribute("xywindow","title",t)}}),AFRAME.registerSystem("xywindow",{theme:{buttonColor:"#222",buttonHoverColor:"#333",buttonLabelColor:"#fff",buttonHoverHaptic:.3,buttonHoverHapticMs:10,buttonGeometry:"xy-rounded-rect",windowCloseButtonColor:"#f00",windowTitleBarColor:"#111",windowTitleColor:"#fff",collidableClass:"collidable"},windows:[],createSimpleButton(t,e,i){t.color=t.color||this.theme.buttonColor,t.hoverColor=t.hoverColor||this.theme.buttonHoverColor;let s=t.geometry||this.theme.buttonGeometry,a=i||document.createElement("a-entity");return a.classList.add(this.theme.collidableClass),a.addEventListener("mouseenter",e=>{if(a.setAttribute("material",{color:t.hoverColor}),this.theme.buttonHoverHaptic&&e.detail.cursorEl.components["tracked-controls"]){let t=e.detail.cursorEl.components["tracked-controls"].controller;t&&t.hapticActuators&&t.hapticActuators.length>0&&t.hapticActuators[0].pulse(this.theme.buttonHoverHaptic,this.theme.buttonHoverHapticMs)}}),a.addEventListener("mouseleave",e=>{a.setAttribute("material",{color:t.color})}),a.setAttribute("geometry",{primitive:s,width:t.width,height:t.height}),a.setAttribute("material",{color:t.color}),e&&e.appendChild(a),a},registerWindow(t){this.windows.push(t)},unregisterWindow(t){let e=this.windows.indexOf(t);e>=0&&this.windows.splice(e,1)}}),AFRAME.registerComponent("xyrange",{dependencies:["xyrect"],schema:{min:{default:0},max:{default:100},step:{default:0},value:{default:0},thumbSize:{default:.4}},init(){let t=this.data;this.value=t.value,this.bar=document.createElement("a-entity"),this.bar.setAttribute("geometry",{primitive:"plane",width:this.el.components.xyrect.width-t.thumbSize,height:.05}),this.bar.setAttribute("material",{color:"#fff"}),this.el.appendChild(this.bar),this.dragging=!1,this.thumb=this.el.sceneEl.systems.xywindow.createSimpleButton({width:t.thumbSize,height:t.thumbSize},this.el),this.thumb.setAttribute("xy-draggable",{base:this.el}),this.thumb.addEventListener("xy-drag",e=>{this.dragging=!0;let i=this.el.components.xyrect.width-t.thumbSize,s=(e.detail.point.x+.5*i)/i*(t.max-t.min);t.step>0&&(s=Math.round(s/t.step)*t.step),this.setValue(s+t.min,!0),this.el.dispatchEvent(new CustomEvent("change",{detail:{value:this.value}}))}),this.thumb.addEventListener("xy-dragend",t=>this.dragging=!1)},update(){let t=this.data;if(t.max<=t.min)return;let e=this.el.components.xyrect.width-t.thumbSize;this.thumb.setAttribute("position",{x:e*(t.value-t.min)/(t.max-t.min)-.5*e,y:0,z:.01})},setValue(t,e){this.dragging&&!e||(this.value=Math.max(Math.min(t,this.data.max),this.data.min),this.el.setAttribute("xyrange","value",this.value))}}),AFRAME.registerComponent("xyscroll",{dependencies:["xyrect"],schema:{scrollbar:{default:!0}},init(){this.scrollX=0,this.scrollY=0,this.speedY=0,this.contentHeight=0,this.control=document.createElement("a-entity"),this.thumbLen=.2,this.el.appendChild(this.control),this._initScrollBar(this.control,.3),this.el.setAttribute("xy-draggable",{}),this.el.addEventListener("xy-drag",t=>{this.speedY=0,this.setScroll(this.scrollX,this.scrollY+t.detail.point.y-t.detail.prevPoint.y)}),this.el.addEventListener("xy-dragend",t=>{this.speedY=t.detail.point.y-t.detail.prevPoint.y,this.play()}),this.el.addEventListener("xyresize",t=>this.update());let t=this.el.children;for(let e=0;e<t.length;e++)t[e]!=this.control&&t[e].addEventListener("xyresize",t=>this.update())},_initScrollBar(t,e){this.upButton=this.el.sceneEl.systems.xywindow.createSimpleButton({width:e,height:.3},t),this.upButton.addEventListener("click",t=>{this.speedY=.3*-this.scrollDelta,this.play()}),this.downButton=this.el.sceneEl.systems.xywindow.createSimpleButton({width:e,height:.3},t),this.downButton.addEventListener("click",t=>{this.speedY=.3*this.scrollDelta,this.play()}),this.scrollThumb=this.el.sceneEl.systems.xywindow.createSimpleButton({width:.7*e,height:this.thumbLen},t),this.scrollThumb.setAttribute("xy-draggable",{base:this.el}),this.scrollThumb.addEventListener("xy-drag",t=>{let e=this.el.components.xyrect,i=this.thumbLen,s=(this.scrollStart-i/2-t.detail.point.y)*Math.max(.01,this.contentHeight-e.height)/(this.scrollLength-i);this.setScroll(this.scrollX,s)})},update(){let t=this.el.components.xyrect;this.scrollDelta=Math.max(t.height/2,.5),this.el.setAttribute("xyclipping",{exclude:this.control});let e=this.data.scrollbar;this.upButton.setAttribute("visible",e),this.upButton.setAttribute("position",{x:t.width+.1,y:t.height-.15,z:.05}),this.downButton.setAttribute("visible",e),this.downButton.setAttribute("position",{x:t.width+.1,y:.15,z:.05}),this.scrollThumb.setAttribute("visible",e),this.scrollStart=t.height-.3,this.scrollLength=t.height-.6,this.setScroll(0,0)},tick(){Math.abs(this.speedY)>.001?(this.setScroll(this.scrollX,this.scrollY+this.speedY),this.speedY*=.8):this.pause()},setScroll(t,e){let i=this.el.children,s=.001;for(let t=0;t<i.length;t++){let e=i[t];e!==this.control&&(e.components.xyrect||e.setAttribute("xyrect",{}),s=Math.max(s,e.components.xyrect.height))}this.contentHeight=s;let a=this.el.components.xyrect;this.scrollX=Math.max(0,t),this.scrollY=Math.max(0,Math.min(e,this.contentHeight-a.height));let l=Math.max(.2,Math.min(this.scrollLength*a.height/this.contentHeight,this.scrollLength)),n=this.scrollStart-l/2-(this.scrollLength-l)*this.scrollY/Math.max(.01,this.contentHeight-a.height);this.thumbLen=l,this.scrollThumb.hasAttribute("geometry")&&this.scrollThumb.setAttribute("geometry","height",l),this.scrollThumb.setAttribute("position",{x:a.width+.1,y:n,z:.05});for(let t=0;t<i.length;t++){let e=i[t];if(e===this.control)continue;if(e.components.xyitem&&e.components.xyitem.data.fixed)continue;let s=e.getAttribute("position");if(s.x=-this.scrollX+e.components.xyrect.data.pivotX*e.components.xyrect.width,s.y=this.scrollY-(1-e.components.xyrect.data.pivotY)*e.components.xyrect.height+a.height,e.setAttribute("position",s),e.components.xylist){let t=e.components.xyrect.height-this.scrollY;e.components.xylist.setViewPort(t,t-a.height,this.scrollX,this.scrollX+a.width)}}this.el.components.xyclipping&&this.el.components.xyclipping.applyClippings()}}),AFRAME.registerComponent("xylist",{dependencies:["xyrect"],schema:{width:{default:-1},itemHeight:{default:-1},vertical:{default:!0}},init(){this.elementFactory=null,this.elementUpdator=null,this.elements=[],this.userData=null,this.itemCount=0,this.el.setAttribute("xyrect",{width:this.data.width,height:this.data.itemHeight,pivotX:0,pivotY:0}),this.setViewPort(0,0,0,0),this.el.classList.add(this.el.sceneEl.systems.xywindow.theme.collidableClass),this.el.addEventListener("click",t=>{let e=t.path||t.composedPath();for(let i=0;i<e.length;i++){let s=e[i].dataset.listPosition;if(null!=s&&-1!=s){this.el.emit("clickitem",{index:s,ev:t});break}}})},setCallback(t,e){if(this.elementFactory=t,this.elementUpdator=e,this.data.itemHeight<0){let t=this.elementFactory(this.el,this.userData);this.data.itemHeight=1*t.getAttribute("height")}},setContents(t,e){this.userData=t,this.itemCount=null!=e?e:t.length;let i=this.data.itemHeight*this.itemCount;this.el.setAttribute("xyrect",{width:this.data.width,height:i});for(let t=0;t<this.elements.length;t++)this.elements[t].setAttribute("visible",!1),this.elements[t].dataset.listPosition=-1;this.refresh()},setViewPort(t,e,i,s){this.top=t,this.bottom=e,this.refresh()},refresh(){if(!this.elementFactory)return;let t=this.data.itemHeight*this.itemCount,e=Math.max(Math.floor((t-this.top)/this.data.itemHeight),0),i=Math.min(Math.ceil((t-this.bottom)/this.data.itemHeight),this.itemCount),s=i-e+1;if(s>this.elements.length)for(;s>this.elements.length;){let t=this.elementFactory(this.el,this.userData);t.dataset.listPosition=-1,t.classList.add(this.el.sceneEl.systems.xywindow.theme.collidableClass),this.el.appendChild(t),this.elements.push(t)}let a=!1;for(let t=e;t<i;t++)a|=!this._updateElement(t);a&&setTimeout(this.refresh.bind(this),100);for(let t=0;t<this.elements.length;t++){let s=this.elements[t].dataset.listPosition;this.elements[t].setAttribute("visible",s>=e&&s<i)}},_updateElement(t){let e=this.elements[t%this.elements.length];if(!e.hasLoaded)return!1;if(e.dataset.listPosition==t)return!0;e.dataset.listPosition=t;let i=0,s=(this.itemCount-t-1)*this.data.itemHeight;return e.components.xyrect&&(i+=e.components.xyrect.data.pivotX*e.components.xyrect.width,s+=e.components.xyrect.data.pivotY*e.components.xyrect.height),e.setAttribute("position",{x:i,y:s,z:0}),this.elementUpdator&&this.elementUpdator(t,e,this.userData),!0}}),AFRAME.registerComponent("xycanvas",{schema:{width:{default:100},height:{default:100}},init(){this.canvas=document.createElement("canvas"),this.canvas.id="_CANVAS"+Math.random();let t=new THREE.CanvasTexture(this.canvas);this.updateTexture=function(){t.needsUpdate=!0},this.el.setAttribute("material",{shader:"flat",npot:!0,src:t,transparent:!0})},update(){this.canvas.width=this.data.width,this.canvas.height=this.data.height}}),AFRAME.registerPrimitive("a-xylabel",{defaultComponents:{xyrect:{},xylabel:{}},mappings:{width:"xyrect.width",height:"xyrect.height",value:"xylabel.value",color:"xylabel.color",align:"xylabel.align","wrap-count":"xylabel.wrapCount"}}),AFRAME.registerPrimitive("a-xybutton",{defaultComponents:{xyrect:{width:2,height:.5},xybutton:{}},mappings:{width:"xyrect.width",height:"xyrect.height",label:"xybutton.label"}}),AFRAME.registerPrimitive("a-xyselect",{defaultComponents:{xyrect:{width:2,height:.5},xyselect:{}},mappings:{width:"xyrect.width",height:"xyrect.height",values:"xyselect.values",label:"xyselect.label",toggle:"xyselect.toggle",select:"xyselect.select"}}),AFRAME.registerPrimitive("a-xywindow",{defaultComponents:{xycontainer:{alignItems:"stretch"},xywindow:{}},mappings:{width:"xyrect.width",height:"xyrect.height",direction:"xycontainer.direction",title:"xywindow.title"}}),AFRAME.registerPrimitive("a-xyscroll",{defaultComponents:{xyrect:{pivotX:0,pivotY:1},xyscroll:{}},mappings:{width:"xyrect.width",height:"xyrect.height",scrollbar:"xyscroll.scrollbar"}}),AFRAME.registerPrimitive("a-xyrange",{defaultComponents:{xyrect:{},xyrange:{}},mappings:{min:"xyrange.min",max:"xyrange.max",step:"xyrange.step",value:"xyrange.value",width:"xyrect.width",height:"xyrect.height"}});