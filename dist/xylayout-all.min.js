"use strict";if("undefined"==typeof AFRAME)throw"AFRAME is not loaded.";AFRAME.registerComponent("xycontainer",{dependencies:["xyrect"],schema:{spacing:{default:.05},padding:{default:0},reverse:{default:!1},wrap:{default:"nowrap",oneOf:["wrap","nowrap"]},direction:{default:"column",oneOf:["none","row","column","vertical","horizontal"]},alignItems:{default:"none",oneOf:["none","center","start","end","baseline","stretch"]},justifyItems:{default:"start",oneOf:["center","start","end","space-between","space-around","stretch"]},alignContent:{default:"",oneOf:["","none","start","end","center","stretch"]}},init(){this.el.addEventListener("xyresize",t=>this.requestLayout()),this.requestLayout()},t(t,i){let e=this.data;if("none"===e.direction)return;let s="vertical"===e.direction||"column"===e.direction,h=e.reverse^s?-1:1,l=s?[0,1,h,0]:[h,0,0,-1],n=s?(t,i)=>[i,t]:(t,i)=>[t,i],a=n(t.width-2*e.padding,t.height-2*e.padding),o=n("width","height"),r=[],d=0,c=0,u=0,y=0,x=0,g=0,f=[];for(let t=0;t<i.length;t++){let s=i[t],h=s.getAttribute("xyitem");if(h&&h.fixed)continue;let l=s.components.xyrect||s.getAttribute("geometry")||{width:1*(s.getAttribute("width")||void 0),height:1*(s.getAttribute("height")||void 0)},o=s.getAttribute("scale")||{x:1,y:1},w={el:s,size:n(l.width,l.height),pivot:n(l.data?l.data.pivotX:.5,l.data?l.data.pivotY:.5),scale:n(o.x,o.y)};null==w.size[0]||isNaN(w.size[0])||("wrap"==e.wrap&&d>0&&d+w.size[0]*w.scale[0]+e.spacing*r.length>a[0]&&(f.push({targets:r,sizeSum:d,growSum:c,shrinkSum:u,crossSize:y}),x+=y,g=Math.max(g,d+e.spacing*(f.length-1)),r=[],d=0,c=0,u=0,y=0),r.push(w),d+=w.size[0]*w.scale[0],c+=h?h.grow:1,u+=h?h.shrink:1,y=w.size[1]>y?w.size[1]:y)}r.length>0&&(f.push({targets:r,sizeSum:d,growSum:c,shrinkSum:u,crossSize:y}),g=Math.max(g,d+e.spacing*(f.length-1)),x+=y),x+=e.spacing*(f.length-1),-1==t.data[o[0]]&&(a[0]=g,t[o[0]]=g+2*e.padding),-1==t.data[o[1]]&&(a[1]=x,t[o[1]]=x+2*e.padding);let w=n(t.data.pivotX,t.data.pivotY),p=-w[1]*a[1],m=-(s?1-w[0]:w[0])*a[0],E=0,v=e.alignContent||e.alignItems;"end"==v?p+=a[1]-x:"center"==v?p+=(a[1]-x)/2:"stretch"!=v&&"none"!=v||(E=(a[1]-x)/f.length),f.forEach(t=>{a[1]=t.crossSize+E,this.i(t.targets,t.sizeSum,t.growSum,t.shrinkSum,a,m,p,l,o),p+=a[1]+e.spacing})},i(t,i,e,s,h,l,n,a,o){let r=this.data.spacing,d=0,c=this.data.justifyItems;"center"===c?l+=(h[0]-i-r*t.length)/2:"end"===c?l+=h[0]-i-r*t.length:"stretch"===c?d=(d=h[0]-i-r*(t.length-1))>0?e>0?d/e:0:s>0?d/s:0:"space-between"===c?r=(h[0]-i)/(t.length-1):"space-around"===c&&(l+=.5*(r=(h[0]-i)/t.length));for(let i=0;i<t.length;i++){let e=t[i],s=e.el,c=s.getAttribute("xyitem"),u=c&&c.align||this.data.alignItems,y=(c?d>0?c.grow:c.shrink:1)*d,x=e.size[0]*e.scale[0]+y,g=e.size[1],f=s.getAttribute("position")||{x:0,y:0,z:0},w=l+e.pivot[0]*x,p=n+.5*h[1];e.scale[0]>0&&0!=y&&s.setAttribute(o[0],e.size[0]+y/e.scale[0]),e.scale[1]>0&&"stretch"===u&&s.setAttribute(o[1],(g=h[1])/e.scale[1]),"start"===u||"stretch"===u?p=n+e.pivot[1]*g:"end"===u?p=n+h[1]-(1-e.pivot[1])*g:"center"===u?p+=(e.pivot[1]-.5)*g:"none"===u&&(p+=a[1]*f.x+a[3]*f.y),f.x=a[0]*w+a[1]*p,f.y=a[2]*w+a[3]*p,s.setAttribute("position",f),l+=x+r}},requestLayout(){this.data&&this.t(this.el.components.xyrect,this.el.children)}}),AFRAME.registerComponent("xyitem",{schema:{align:{default:"none",oneOf:["none","center","start","end","baseline","stretch"]},grow:{default:1},shrink:{default:1},fixed:{default:!1}},update(t){void 0!==t.align&&this.el.parent.components.xycontainer&&this.el.parent.components.xycontainer.requestLayout()}}),AFRAME.registerComponent("xyrect",{schema:{width:{default:-1},height:{default:-1},pivotX:{default:.5},pivotY:{default:.5}},update(t){let i=this.data,e=this.el.getAttribute("geometry")||{},s=i.width,h=i.height;s<0&&(s=this.el.hasAttribute("width")?1*this.el.getAttribute("width"):e.width||0),h<0&&(h=this.el.hasAttribute("height")?1*this.el.getAttribute("height"):e.height||0),this.width=s,this.height=h,(this.el.components.rounded||"A-INPUT"==this.el.tagName)&&(i.pivotX=0,i.pivotY=1),void 0!==t.width&&this.el.emit("xyresize",{xyrect:this},!1)}}),AFRAME.registerComponent("xyclipping",{dependencies:["xyrect"],schema:{exclude:{type:"selector",default:null},clipTop:{default:!0},clipBottom:{default:!0},clipLeft:{default:!1},clipRight:{default:!1}},init(){this.el.sceneEl.renderer.localClippingEnabled=!0,this.clippingPlanesLocal=[],this.clippingPlanes=[],this.currentMatrix=null,this.s=this.s.bind(this),this.filterTargets=["click","mousedown","mouseenter","mouseleave","mousemove"],this.filterTargets.forEach(t=>this.el.addEventListener(t,this.s,!0))},update(){let t=this.el.components.xyrect,i=[];this.data.clipBottom&&i.push(new THREE.Plane(new THREE.Vector3(0,1,0),0)),this.data.clipTop&&i.push(new THREE.Plane(new THREE.Vector3(0,-1,0),t.height)),this.data.clipLeft&&i.push(new THREE.Plane(new THREE.Vector3(1,0,0),0)),this.data.clipRight&&i.push(new THREE.Plane(new THREE.Vector3(-1,0,0),t.width)),this.clippingPlanesLocal=i,this.clippingPlanes=[],this.updateMatrix()},remove(){this.filterTargets.forEach(t=>this.el.removeEventListener(t,this.s,!0)),this.clippingPlanes=[],this.applyClippings()},tick(){this.el.object3D.matrixWorld.equals(this.currentMatrix)||this.updateMatrix()},s(t){if(!(t.path||t.composedPath()).includes(this.data.exclude)&&t.detail.intersection&&this.isClipped(t.detail.intersection.point)&&(t.stopPropagation(),t.detail.cursorEl&&t.detail.cursorEl.components.raycaster)){let i=t.detail.cursorEl.components.raycaster.intersectedEls,e=i.lastIndexOf(t.target);e>=0&&e+1<i.length&&i[e+1].dispatchEvent(new CustomEvent(t.type,t))}},updateMatrix(){this.currentMatrix=this.el.object3D.matrixWorld.clone();for(let t=0;t<this.clippingPlanesLocal.length;t++)this.clippingPlanes[t]=this.clippingPlanesLocal[t].clone().applyMatrix4(this.currentMatrix);this.applyClippings()},applyClippings(){let t=this.data.exclude&&this.data.exclude.object3D,i=e=>{if(e!==t){e.material&&void 0!==e.material.clippingPlanes&&(e.material.clippingPlanes=this.clippingPlanes);for(let t=0;t<e.children.length;t++)i(e.children[t])}};i(this.el.object3D)},isClipped(t){return this.clippingPlanes.some(i=>i.distanceToPoint(t)<0)}}),function(){let t={defaultComponents:{xyrect:{},xycontainer:{}},mappings:{width:"xyrect.width",height:"xyrect.height",direction:"xycontainer.direction",spacing:"xycontainer.spacing",padding:"xycontainer.padding",reverse:"xycontainer.reverse",wrap:"xycontainer.wrap","align-items":"xycontainer.alignItems","justify-items":"xycontainer.justifyItems"}};AFRAME.registerPrimitive("a-xycontainer",t),AFRAME.registerPrimitive("a-xylayout",t)}(),AFRAME.registerGeometry("xy-rounded-rect",{schema:{height:{default:1,min:0},width:{default:1,min:0},radius:{default:.05,min:0}},init(t){let i=new THREE.Shape,e=t.radius,s=(t.width||.01)/2,h=(t.height||.01)/2;i.moveTo(-s,-h+e),i.lineTo(-s,h-e),i.quadraticCurveTo(-s,h,-s+e,h),i.lineTo(s-e,h),i.quadraticCurveTo(s,h,s,h-e),i.lineTo(s,-h+e),i.quadraticCurveTo(s,-h,s-e,-h),i.lineTo(-s+e,-h),i.quadraticCurveTo(-s,-h,-s,-h+e),this.geometry=new THREE.ShapeGeometry(i)}}),AFRAME.registerComponent("xylabel",{dependencies:["xyrect"],schema:{value:{default:""},color:{default:"white"},align:{default:"left"},wrapCount:{default:0},xOffset:{default:0},zOffset:{default:.01},resolution:{default:32},renderingMode:{default:"auto",oneOf:["auto","canvas"]}},init(){this.el.addEventListener("xyresize",t=>this.update())},update(){let t=this.data,i=t.wrapCount,e=this.el.components.xyrect,s=e.height,h=e.width;if(""==t.value)return void this.remove();if(0==i&&s>0&&(i=Math.max(h/s/.65,t.value.length)+1),"auto"==t.renderingMode&&!/[\u0100-\uDFFF]/.test(t.value)){let e=Object.assign({},t);delete e.resolution,delete e.renderingMode,e.wrapCount=i,e.width=h,e.height=s,this.el.setAttribute("text",e);let l=this.el.getObject3D("text");return l&&(l.raycast=function(){}),void this.h()}this.l();let l=Math.floor(t.resolution*(.65*i)),n=t.resolution,a=t.resolution;for(;a<l;)a<<=1;let o=this.canvas;if(!o||this.textWidth!==l||o.height!==n){this.h(),this.canvas=o=o||document.createElement("canvas"),o.height=n,o.width=a,this.textWidth=l;let s=e.data.height>0?e.height:h/(.65*i),r=new THREE.CanvasTexture(o);r.anisotropy=4,r.alphaTest=.2,r.repeat.x=l/a;let d=new THREE.Mesh(new THREE.PlaneGeometry(h,s),new THREE.MeshBasicMaterial({map:r,transparent:!0}));d.position.copy(new THREE.Vector3(t.xOffset,0,t.zOffset)),this.el.setObject3D("xylabel",d)}let r=o.getContext("2d");r.clearRect(0,0,a,n),r.font=.9*n+"px bold sans-serif",r.textBaseline="top",r.textAlign=t.align,r.fillStyle=t.color,r.fillText(t.value,"center"===t.align?l/2:0,.1*n),this.el.object3DMap.xylabel.material.map.needsUpdate=!0},remove(){this.h(),this.l()},l(){this.el.hasAttribute("text")&&this.el.removeAttribute("text")},h(){let t=this.el.getObject3D("xylabel");t&&(t.material.map.dispose(),t.material.dispose(),t.geometry.dispose(),this.el.removeObject3D("xylabel"),this.canvas=null)}}),AFRAME.registerComponent("xybutton",{dependencies:["xyrect"],schema:{color:{default:""},hoverColor:{default:""}},init(){let t=this.el.components.xyrect;this.el.sceneEl.systems.xywindow.createSimpleButton({width:t.width,height:t.height,color:this.data.color,hoverColor:this.data.hoverColor},null,this.el),this.el.addEventListener("xyresize",t=>{this.el.setAttribute("geometry",{width:t.detail.xyrect.width,height:t.detail.xyrect.height})})}}),AFRAME.registerComponent("xytoggle",{dependencies:["xyrect"],schema:{value:{default:!1}},init(){this.buttonParams={width:1,height:1},this.el.sceneEl.systems.xywindow.createSimpleButton(this.buttonParams,null,this.el),this.thumb=document.createElement("a-circle"),this.el.appendChild(this.thumb),this.el.addEventListener("click",t=>{this.el.setAttribute("xytoggle","value",!this.data.value),this.el.emit("change",{value:!this.data.value},!1)}),this.el.addEventListener("xyresize",t=>this.update())},update(){let t=this.el.components.xyrect,i=this.buttonParams,e=this.data.value;i.color=e?"#0066ff":this.el.sceneEl.systems.xywindow.theme.buttonColor,i.hoverColor=e?"#4499ff":"",this.el.setAttribute("material","color",i.color);let s=t.height/2;this.thumb.setAttribute("geometry","radius",.8*s),this.thumb.setAttribute("position",{x:(t.width/2-s)*(e?1:-1),y:0,z:.05}),this.el.setAttribute("geometry",{primitive:"xy-rounded-rect",width:t.width,height:2*s,radius:s})}}),AFRAME.registerComponent("xyselect",{dependencies:["xyrect","xybutton"],schema:{values:{default:[]},label:{default:""},toggle:{default:!1},select:{default:0}},init(){if(this.el.addEventListener("click",t=>{this.data.toggle?this.select((this.data.select+1)%this.data.values.length):this.listEl?this.hide():this.show()}),this.data.toggle)this.el.setAttribute("xylabel","align","center");else{let t=this.marker=document.createElement("a-triangle");t.setAttribute("geometry",{vertexA:{x:.1,y:.03,z:0},vertexB:{x:-.1,y:.03,z:0},vertexC:{x:0,y:-.12,z:0}}),this.el.appendChild(t),this.el.addEventListener("xyresize",t=>this.update())}},update(){let t=this.data;this.el.setAttribute("xylabel",{value:t.label||t.values[t.select]}),this.marker&&this.marker.setAttribute("position",{x:this.el.components.xyrect.width/2-.2,y:0,z:.05})},show(){if(this.listEl)return;let t=(this.el.components.xyrect.height+.5*this.data.values.length)/2+.1;this.listEl=document.createElement("a-entity"),this.listEl.setAttribute("xycontainer",{spacing:0}),this.listEl.setAttribute("position",{x:0,y:t,z:.05}),this.el.appendChild(this.listEl),this.data.values.forEach((t,i)=>{let e=document.createElement("a-xybutton");e.setAttribute("label",t),e.addEventListener("click",t=>{t.stopPropagation(),this.select(i),this.hide()}),this.listEl.appendChild(e)}),setTimeout(()=>this.listEl&&this.listEl.setAttribute("xyrect",{width:2,height:.5*this.data.values.length}),0)},select(t){this.el.setAttribute("xyselect","select",t),this.el.emit("change",{value:this.data.values[t],index:t},!1)},hide(){this.listEl&&(this.el.removeChild(this.listEl),this.listEl.destroy(),this.listEl=null)}}),AFRAME.registerComponent("xy-draggable",{schema:{dragThreshold:{default:.02},preventClick:{default:!0},base:{type:"selector",default:null}},init(){this.el.classList.add(this.el.sceneEl.systems.xywindow.theme.collidableClass),this.o=this.o.bind(this),this.el.addEventListener("mousedown",this.o),this.dragFun=null},remove(){this.el.removeEventListener("mousedown",this.o)},tick(){null!==this.dragFun?this.dragFun("xy-drag"):this.pause()},o(t){if(!t.detail.cursorEl||!t.detail.cursorEl.components.raycaster)return;let i=this.data.base||this.el,e=t.detail.cursorEl,s=e.components.raycaster.raycaster,h=new THREE.Plane(new THREE.Vector3(0,0,-1),0).applyMatrix4(i.object3D.matrixWorld),l=s.ray.direction.clone(),n=new THREE.Vector3;null===s.ray.intersectPlane(h,n)&&i.object3D.worldToLocal(n);let a=s.ray.clone(),o=this,r=!1,d=t=>{if(!r){if(l.manhattanDistanceTo(s.ray.direction)<o.data.dragThreshold)return;t="xy-dragstart",o.dragging=r=!0}let d=n.clone();null!==s.ray.intersectPlane(h,n)&&i.object3D.worldToLocal(n),o.el.emit(t,{raycaster:s,point:n,prevPoint:d,prevRay:a,cursorEl:e}),a.copy(s.ray)};o.dragFun=d,o.play();let c=i=>i.target!=t.target&&i.stopPropagation();window.addEventListener("mouseenter",c,!0),window.addEventListener("mouseleave",c,!0),window.addEventListener("mouseup",function t(i){if(i.detail.cursorEl==e&&(window.removeEventListener("mouseup",t),window.removeEventListener("mouseenter",c,!0),window.removeEventListener("mouseleave",c,!0),o.dragFun=null,r)){if(o.dragging=!1,o.data.preventClick){let t=t=>t.stopPropagation();window.addEventListener("click",t,!0),setTimeout(()=>window.removeEventListener("click",t,!0),0)}setTimeout(()=>d("xy-dragend"),15)}})}}),AFRAME.registerComponent("xy-drag-control",{schema:{target:{type:"selector",default:null},draggable:{default:""},autoRotate:{default:!1},mode:{default:"grab"}},init(){this.u=this.u.bind(this),this.draggable=[]},update(t){let i=this.data.draggable;i!==t.draggable&&(this.remove(),this.draggable=Array.isArray(i)?i:""!=i?this.el.querySelectorAll(i):[this.el],this.draggable.forEach(t=>{t.setAttribute("xy-draggable",{}),t.addEventListener("xy-dragstart",this.u),t.addEventListener("xy-drag",this.u)}))},remove(){this.draggable.forEach(t=>{t.removeAttribute("xy-draggable"),t.removeEventListener("xy-dragstart",this.u),t.removeEventListener("xy-drag",this.u)})},u(t){let i,e=t.detail.raycaster.ray.direction,s=t.detail.prevRay.direction,h=this.data.target||this.el;t.detail.cursorEl.components["tracked-controls"]?(i="xy-dragstart"==t.type?new THREE.Quaternion:this.prevQ.inverse().premultiply(t.detail.cursorEl.object3D.quaternion),this.prevQ=t.detail.cursorEl.object3D.quaternion.clone()):i=(new THREE.Quaternion).setFromUnitVectors(s,e);let l=(new THREE.Matrix4).makeRotationFromQuaternion(i),n=t.detail.prevRay.origin,a=t.detail.raycaster.ray.origin,o=new THREE.Matrix4;if(l.multiply(o.makeTranslation(-n.x,-n.y,-n.z)),l.premultiply(o.makeTranslation(a.x,a.y,a.z)),h.object3D.applyMatrix(l),"pull"==this.data.mode){let i=h.object3D.getWorldPosition(new THREE.Vector3),l=e.clone().sub(s),n=2*i.distanceTo(t.detail.raycaster.ray.origin);h.object3D.position.add(e.clone().multiplyScalar(-l.y*n))}if(this.data.autoRotate){let i=this.el.sceneEl.camera.getWorldPosition(new THREE.Vector3),e=h.object3D.getWorldPosition(new THREE.Vector3),s=i.clone().sub(e).normalize(),l=.8-s.y*s.y;if(l>0){let s=(new THREE.Matrix4).lookAt(i,e,new THREE.Vector3(0,1,0)),n=(new THREE.Quaternion).setFromRotationMatrix(s),a=t.detail.cursorEl.components.raycaster.getIntersection(t.target),o=h.object3D.parent.worldToLocal(a?a.point:e),r=h.object3D.quaternion.clone();THREE.Quaternion.slerp(h.object3D.quaternion,n,h.object3D.quaternion,.1*l),h.object3D.position.sub(o).applyQuaternion(r.inverse().premultiply(h.object3D.quaternion)).add(o)}}}}),AFRAME.registerComponent("xywindow",{dependencies:["xycontainer"],schema:{title:{default:""},closable:{default:!0}},init(){this.theme=this.system.theme;let t=this.controls=document.createElement("a-entity");t.setAttribute("position",{x:0,y:0,z:.05}),t.setAttribute("xyitem",{fixed:!0}),this.el.appendChild(t);let i=this.system.createSimpleButton({width:1,height:.5,color:this.theme.windowTitleBarColor},t);if(i.setAttribute("xy-drag-control",{target:this.el,autoRotate:!0}),this.dragButton=i,this.data.closable){let i=this.system.createSimpleButton({width:.5,height:.5,color:this.theme.windowTitleBarColor,hoverColor:this.theme.windowCloseButtonColor},t);i.setAttribute("xylabel",{value:"X",align:"center",color:this.theme.buttonLabelColor}),i.addEventListener("click",t=>this.el.parentNode.removeChild(this.el)),this.closeButton=i}this.titleText=document.createElement("a-entity"),this.dragButton.appendChild(this.titleText),this.el.addEventListener("xyresize",t=>{this.update({})}),this.system.registerWindow(this)},remove(){this.system.unregisterWindow(this)},update(t){let i=this.el.components.xyrect,e=0;if(this.closeButton&&(this.closeButton.setAttribute("position",{x:i.width/2-.25,y:.3,z:0}),e+=.52),this.data.title!=t.title){let t=i.width-e-.2;this.titleText.setAttribute("xyrect",{width:t,height:.45}),this.titleText.setAttribute("xylabel",{value:this.data.title,wrapCount:Math.max(10,t/.2),color:this.theme.windowTitleColor,xOffset:.1})}this.controls.setAttribute("position","y",.5*i.height),this.dragButton.setAttribute("geometry","width",i.width-e),this.dragButton.setAttribute("position",{x:-e/2,y:.3,z:0})},setTitle(t){this.el.setAttribute("xywindow","title",t)}}),AFRAME.registerSystem("xywindow",{theme:{buttonColor:"#222",buttonHoverColor:"#333",buttonLabelColor:"#fff",buttonHoverHaptic:.3,buttonHoverHapticMs:10,buttonGeometry:"xy-rounded-rect",windowCloseButtonColor:"#f00",windowTitleBarColor:"#111",windowTitleColor:"#fff",collidableClass:"collidable"},windows:[],createSimpleButton(t,i,e){let s=e||document.createElement("a-entity");return s.hasAttribute("geometry")||s.setAttribute("geometry",{primitive:this.theme.buttonGeometry,width:t.width,height:t.height}),s.classList.add(this.theme.collidableClass),s.addEventListener("mouseenter",i=>{let e=this.theme;if(s.setAttribute("material",{color:t.hoverColor||this.theme.buttonHoverColor}),e.buttonHoverHaptic&&i.detail.cursorEl.components["tracked-controls"]){let t=i.detail.cursorEl.components["tracked-controls"].controller;t&&t.hapticActuators&&t.hapticActuators.length>0&&t.hapticActuators[0].pulse(e.buttonHoverHaptic,e.buttonHoverHapticMs)}}),s.addEventListener("mouseleave",i=>{s.setAttribute("material",{color:t.color||this.theme.buttonColor})}),s.setAttribute("material",{color:t.color||this.theme.buttonColor}),i&&i.appendChild(s),s},registerWindow(t){this.windows.push(t)},unregisterWindow(t){let i=this.windows.indexOf(t);i>=0&&this.windows.splice(i,1)}}),AFRAME.registerComponent("xyrange",{dependencies:["xyrect"],schema:{min:{default:0},max:{default:100},step:{default:0},value:{default:0},color0:{default:"white"},color1:{default:"#06f"},thumbSize:{default:.4}},init(){let t=this.data,i=new THREE.PlaneGeometry(1,.08),e=this.bar=new THREE.Mesh(i,new THREE.MeshBasicMaterial({color:t.color0})),s=this.prog=new THREE.Mesh(i,new THREE.MeshBasicMaterial({color:t.color1}));this.prog.position.z=.02,this.el.setObject3D("xyrange-bar",e),this.el.setObject3D("xyrange-prog",s),this.thumb=this.el.sceneEl.systems.xywindow.createSimpleButton({width:t.thumbSize,height:t.thumbSize},this.el),this.thumb.setAttribute("xy-draggable",{base:this.el}),this.thumb.addEventListener("xy-drag",i=>{let e=this.el.components.xyrect.width-t.thumbSize,s=(i.detail.point.x+e/2)/e*(t.max-t.min);t.step>0&&(s=Math.round(s/t.step)*t.step),this.setValue(s+t.min,!0)})},update(){let t=this.data;if(this.value=t.value,t.max<=t.min)return;let i=this.el.components.xyrect.width-t.thumbSize,e=i*(t.value-t.min)/(t.max-t.min);this.thumb.setAttribute("geometry","radius",t.thumbSize/2),this.thumb.setAttribute("position",{x:e-i/2,y:0,z:.04}),this.bar.scale.x=i,this.prog.scale.x=e||.01,this.prog.position.x=(e-i)/2},setValue(t,i){if(!this.thumb.components["xy-draggable"].dragging||i){let e=Math.max(Math.min(t,this.data.max),this.data.min);e!=this.value&&i&&this.el.emit("change",{value:e},!1),this.el.setAttribute("xyrange","value",e)}}}),AFRAME.registerComponent("xyscroll",{dependencies:["xyrect"],schema:{scrollbar:{default:!0}},init(){this.scrollX=0,this.scrollY=0,this.speedY=0,this.contentHeight=0,this.thumbLen=.2,this.control=this.g(this.el,.3),this.el.setAttribute("xyclipping",{exclude:this.control}),this.el.setAttribute("xy-draggable",{}),this.el.addEventListener("xy-drag",t=>{this.speedY=0,this.setScroll(this.scrollX,this.scrollY+t.detail.point.y-t.detail.prevPoint.y)}),this.el.addEventListener("xy-dragend",t=>{this.speedY=t.detail.point.y-t.detail.prevPoint.y,this.play()}),this.el.addEventListener("xyresize",t=>this.update());let t=this.el.children;for(let i=0;i<t.length;i++)t[i]!=this.control&&t[i].addEventListener("xyresize",t=>this.update())},g(t,i){let e=document.createElement("a-entity");t.appendChild(e),this.scrollBar=e;let s=this.el.sceneEl.systems.xywindow;return this.upButton=s.createSimpleButton({width:i,height:.3},e),this.upButton.addEventListener("click",t=>{this.speedY=.3*-this.scrollDelta,this.play()}),this.downButton=s.createSimpleButton({width:i,height:.3},e),this.downButton.addEventListener("click",t=>{this.speedY=.3*this.scrollDelta,this.play()}),this.scrollThumb=s.createSimpleButton({width:.7*i,height:this.thumbLen},e),this.scrollThumb.setAttribute("xy-draggable",{base:e}),this.scrollThumb.addEventListener("xy-drag",t=>{let i=this.thumbLen,e=(this.scrollStart-i/2-t.detail.point.y)*Math.max(.01,this.contentHeight-this.el.components.xyrect.height)/(this.scrollLength-i);this.setScroll(this.scrollX,e)}),e},update(){let t=this.el.components.xyrect,i=t.height;this.scrollBar.setAttribute("visible",this.data.scrollbar),this.scrollBar.setAttribute("position",{x:t.width+.1,y:0,z:.05}),this.upButton.setAttribute("position",{x:0,y:i-.15,z:0}),this.downButton.setAttribute("position",{x:0,y:.15,z:0}),this.scrollDelta=Math.max(i/2,.5),this.scrollStart=i-.3,this.scrollLength=i-.6,this.setScroll(0,0)},tick(){Math.abs(this.speedY)>.001?(this.setScroll(this.scrollX,this.scrollY+this.speedY),this.speedY*=.8):this.pause()},setScroll(t,i){let e=this.el.children,s=0;for(let t=0;t<e.length;t++){let i=e[t];i!==this.control&&(i.components.xyrect||i.setAttribute("xyrect",{}),s=Math.max(s,i.components.xyrect.height))}this.contentHeight=s;let h=this.el.components.xyrect;this.scrollX=Math.max(0,t),this.scrollY=Math.max(0,Math.min(i,s-h.height));let l=Math.max(.2,Math.min(this.scrollLength*h.height/s,this.scrollLength)),n=this.scrollStart-l/2-(this.scrollLength-l)*this.scrollY/Math.max(.01,s-h.height);this.thumbLen=l,this.scrollThumb.hasAttribute("geometry")&&this.scrollThumb.setAttribute("geometry","height",l),this.scrollThumb.setAttribute("position","y",n);for(let t=0;t<e.length;t++){let i=e[t];if(i===this.control)continue;if(i.components.xyitem&&i.components.xyitem.data.fixed)continue;let s=i.getAttribute("position"),l=i.components.xyrect;s.x=l.data.pivotX*l.width-this.scrollX,s.y=this.scrollY-(1-l.data.pivotY)*l.height+h.height,i.setAttribute("position",s);let n=l.height-this.scrollY;i.emit("xyviewport",[n,n-h.height,this.scrollX,this.scrollX+h.width],!1)}this.el.components.xyclipping&&this.el.components.xyclipping.applyClippings()}}),AFRAME.registerComponent("xylist",{dependencies:["xyrect"],schema:{itemWidth:{default:-1},itemHeight:{default:-1},vertical:{default:!0}},init(){this.elementFactory=null,this.elementUpdator=null,this.elements=[],this.userData=null,this.itemCount=0,this.el.setAttribute("xyrect",{pivotX:0,pivotY:0}),this.setViewPort([0,0]),this.el.addEventListener("xyviewport",t=>this.setViewPort(t.detail)),this.el.classList.add(this.el.sceneEl.systems.xywindow.theme.collidableClass),this.el.addEventListener("click",t=>{let i=t.path||t.composedPath();for(let e=0;e<i.length;e++){let s=i[e].dataset.listPosition;if(null!=s&&-1!=s){this.el.emit("clickitem",{index:s,ev:t},!1);break}}})},setCallback(t,i){if(this.elementFactory=t,this.elementUpdator=i,this.data.itemHeight<=0){let t=this.elementFactory(this.el,this.userData);this.data.itemHeight=1*t.getAttribute("height"),this.data.itemWidth=1*t.getAttribute("width")}},setContents(t,i){this.userData=t,this.itemCount=void 0!==i?i:t.length,this.el.setAttribute("xyrect",{width:this.data.itemWidth,height:this.data.itemHeight*this.itemCount});for(let t of this.elements)t.setAttribute("visible",!1),t.dataset.listPosition=-1;this.refresh()},setViewPort(t){this.top=t[0],this.bottom=t[1],this.refresh()},refresh(){if(!this.elementFactory)return;let t=this.data.itemHeight,i=t*this.itemCount,e=Math.max(Math.floor((i-this.top)/t),0),s=Math.min(Math.ceil((i-this.bottom)/t),this.itemCount),h=s-e+1;for(;h>this.elements.length;){let t=this.elementFactory(this.el,this.userData);t.classList.add(this.el.sceneEl.systems.xywindow.theme.collidableClass),this.el.appendChild(t),this.elements.push(t)}let l=!1;for(let i=e;i<s;i++){let e=this.elements[i%this.elements.length];if(e.hasLoaded){if(e.dataset.listPosition!=i){e.dataset.listPosition=i;let s=0,h=(this.itemCount-i-1)*t,l=e.components.xyrect;l&&(s+=l.data.pivotX*l.width,h+=l.data.pivotY*l.height),e.setAttribute("position",{x:s,y:h,z:0}),this.elementUpdator&&this.elementUpdator(i,e,this.userData)}}else l=!0}l&&setTimeout(()=>this.refresh(),100);for(let t of this.elements){let i=t.dataset.listPosition;t.setAttribute("visible",i>=e&&i<s)}}}),AFRAME.registerComponent("xycanvas",{schema:{width:{default:100},height:{default:100}},init(){this.canvas=document.createElement("canvas"),this.canvas.id="_CANVAS"+Math.random();let t=new THREE.CanvasTexture(this.canvas);this.updateTexture=function(){t.needsUpdate=!0},this.el.setAttribute("material",{shader:"flat",npot:!0,src:t,transparent:!0})},update(){this.canvas.width=this.data.width,this.canvas.height=this.data.height}}),AFRAME.registerPrimitive("a-xylabel",{defaultComponents:{xyrect:{},xylabel:{}},mappings:{width:"xyrect.width",height:"xyrect.height",value:"xylabel.value",color:"xylabel.color",align:"xylabel.align","wrap-count":"xylabel.wrapCount"}}),AFRAME.registerPrimitive("a-xybutton",{defaultComponents:{xyrect:{width:2,height:.5},xylabel:{align:"center"},xybutton:{}},mappings:{width:"xyrect.width",height:"xyrect.height",label:"xylabel.value",align:"xylabel.align"}}),AFRAME.registerPrimitive("a-xytoggle",{defaultComponents:{xyrect:{width:.8,height:.4},xytoggle:{}},mappings:{width:"xyrect.width",height:"xyrect.height",value:"xytoggle.value"}}),AFRAME.registerPrimitive("a-xyselect",{defaultComponents:{xyrect:{width:2,height:.5},xyselect:{}},mappings:{width:"xyrect.width",height:"xyrect.height",values:"xyselect.values",label:"xyselect.label",toggle:"xyselect.toggle",select:"xyselect.select"}}),AFRAME.registerPrimitive("a-xywindow",{defaultComponents:{xycontainer:{alignItems:"stretch"},xywindow:{}},mappings:{width:"xyrect.width",height:"xyrect.height",direction:"xycontainer.direction",title:"xywindow.title"}}),AFRAME.registerPrimitive("a-xyscroll",{defaultComponents:{xyrect:{pivotX:0,pivotY:1},xyscroll:{}},mappings:{width:"xyrect.width",height:"xyrect.height",scrollbar:"xyscroll.scrollbar"}}),AFRAME.registerPrimitive("a-xyrange",{defaultComponents:{xyrect:{},xyrange:{}},mappings:{width:"xyrect.width",height:"xyrect.height",min:"xyrange.min",max:"xyrange.max",step:"xyrange.step",value:"xyrange.value"}});