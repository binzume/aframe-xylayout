"use strict";AFRAME.registerGeometry("xy-rounded-rect",{schema:{height:{default:1,min:0},width:{default:1,min:0},radius:{default:.05,min:0}},init(t){let e=new THREE.Shape,i=t.radius,s=(t.width||.01)/2,h=(t.height||.01)/2;e.moveTo(-s,-h+i),e.lineTo(-s,h-i),e.quadraticCurveTo(-s,h,-s+i,h),e.lineTo(s-i,h),e.quadraticCurveTo(s,h,s,h-i),e.lineTo(s,-h+i),e.quadraticCurveTo(s,-h,s-i,-h),e.lineTo(-s+i,-h),e.quadraticCurveTo(-s,-h,-s,-h+i),this.geometry=new THREE.ShapeGeometry(e)}}),AFRAME.registerComponent("xylabel",{dependencies:["xyrect"],schema:{value:{default:""},color:{default:"white"},align:{default:"left"},wrapCount:{default:0},xOffset:{default:0},zOffset:{default:.01},resolution:{default:32},renderingMode:{default:"auto",oneOf:["auto","canvas"]}},init(){this.el.addEventListener("xyresize",t=>this.update())},update(){let t=this.data,e=this.el,i=t.wrapCount,s=e.components.xyrect,h=s.height,l=s.width;if(""==t.value)return void this.remove();if(0==i&&h>0&&(i=Math.max(l/h/.65,t.value.length)+1),"auto"==t.renderingMode&&!/[\u0100-\uDFFF]/.test(t.value)){let s=Object.assign({},t);delete s.resolution,delete s.renderingMode,s.wrapCount=i,s.width=l,s.height=h,e.setAttribute("text",s);let a=e.getObject3D("text");return a&&(a.raycast=(()=>{})),void this.t()}let a=t.resolution,o=Math.floor(a*i*.65),n=this.canvas;if(!n||this.textWidth!==o||n.height!==a){let h=8;for(;h<o;)h<<=1;this.remove(),this.canvas=n=n||document.createElement("canvas"),n.height=a,n.width=h,this.textWidth=o;let r=new THREE.CanvasTexture(n);r.anisotropy=4,r.alphaTest=.2,r.repeat.x=o/h;let d=new THREE.Mesh(new THREE.PlaneGeometry(l,s.data.height>0?s.height:l/(.65*i)),new THREE.MeshBasicMaterial({map:r,transparent:!0}));d.position.set(t.xOffset,0,t.zOffset),d.raycast=(()=>{}),e.setObject3D("xylabel",d)}let r=n.getContext("2d");r.clearRect(0,0,o,a),r.font=.9*a+"px bold sans-serif",r.textBaseline="top",r.textAlign=t.align,r.fillStyle=t.color,r.fillText(t.value,"center"===t.align?o/2:0,.1*a),e.object3DMap.xylabel.material.map.needsUpdate=!0},remove(){this.t(),this.el.hasAttribute("text")&&this.el.removeAttribute("text")},t(){let t=this.el.getObject3D("xylabel");t&&(t.material.map.dispose(),t.material.dispose(),t.geometry.dispose(),this.el.removeObject3D("xylabel"),this.canvas=null)}}),AFRAME.registerComponent("xybutton",{dependencies:["xyrect"],schema:{color:{default:""},hoverColor:{default:""}},init(){let t=this.el,e=t.components.xyrect;t.sceneEl.systems.xywindow.createSimpleButton(e.width,e.height,this.data,null,t)}}),AFRAME.registerComponent("xytoggle",{dependencies:["xyrect"],schema:{value:{default:!1}},init(){let t=this.el;Object.defineProperty(t,"value",{get:()=>this.data.value,set:e=>t.setAttribute("xytoggle","value",e)}),this.s=t.appendChild(document.createElement("a-circle")),t.addEventListener("click",e=>{t.value=!t.value,t.emit("change",{value:t.value},!1)}),t.addEventListener("xyresize",t=>this.update())},update(){let t=this.el,e=t.components.xyrect,i=e.height/2,s=t.value,h={color:s?"#0066ff":t.sceneEl.systems.xywindow.theme.buttonColor,hoverColor:s?"#4499ff":""};t.setAttribute("xybutton",h),t.setAttribute("material","color",h.color),this.s.setAttribute("geometry","radius",.8*i),this.s.setAttribute("position",{x:(e.width/2-i)*(s?1:-1),y:0,z:.05}),t.setAttribute("geometry",{primitive:"xy-rounded-rect",width:e.width,height:2*i,radius:i})}}),AFRAME.registerComponent("xyselect",{dependencies:["xyrect","xybutton"],schema:{values:{default:[]},label:{default:""},toggle:{default:!1},select:{default:0}},init(){if(this.el.addEventListener("click",t=>{let e=this.data;e.toggle?this.select((e.select+1)%e.values.length):this.h?this.hide():this.show()}),this.data.toggle)this.el.setAttribute("xylabel","align","center");else{let t=this.l=document.createElement("a-triangle");t.setAttribute("geometry",{vertexA:{x:.1,y:.03,z:0},vertexB:{x:-.1,y:.03,z:0},vertexC:{x:0,y:-.12,z:0}}),this.el.appendChild(t),this.el.addEventListener("xyresize",t=>this.update())}},update(){let t=this.data;this.el.setAttribute("xylabel",{value:t.label||t.values[t.select]}),this.l&&this.l.setAttribute("position",{x:this.el.components.xyrect.width/2-.2,y:0,z:.05})},show(){if(this.h)return;let t=this.data.values,e=(this.el.components.xyrect.height+.5*t.length)/2+.05,i=this.h=this.el.appendChild(document.createElement("a-xycontainer"));i.setAttribute("position",{x:0,y:e,z:.1}),t.forEach((t,e)=>{let s=document.createElement("a-xybutton");s.setAttribute("label",t),s.addEventListener("click",t=>{t.stopPropagation(),this.select(e),this.hide()}),i.appendChild(s)}),setTimeout(()=>i.setAttribute("xyrect",{width:2,height:.5*t.length}),0)},select(t){this.el.setAttribute("xyselect","select",t),this.el.emit("change",{value:this.data.values[t],index:t},!1)},hide(){this.h&&(this.el.removeChild(this.h),this.h.destroy(),this.h=null)}}),AFRAME.registerComponent("xy-draggable",{schema:{dragThreshold:{default:.02},preventClick:{default:!0},base:{type:"selector",default:null}},init(){this.el.classList.add(this.el.sceneEl.systems.xywindow.theme.collidableClass),this.p=this.p.bind(this),this.el.addEventListener("mousedown",this.p),this.g=null},remove(){this.el.removeEventListener("mousedown",this.p)},tick(){null!==this.g?this.g("xy-drag"):this.pause()},p(t){if(!t.detail.cursorEl||!t.detail.cursorEl.components.raycaster)return;let e=this.data.base||this.el,i=t.detail.cursorEl,s=i.components.raycaster.raycaster,h=new THREE.Plane(new THREE.Vector3(0,0,-1),0).applyMatrix4(e.object3D.matrixWorld),l=s.ray.direction.clone(),a=new THREE.Vector3;null===s.ray.intersectPlane(h,a)&&e.object3D.worldToLocal(a);let o=s.ray.clone(),n=this,r=!1,d=n.g=(t=>{if(!r){if(l.manhattanDistanceTo(s.ray.direction)<n.data.dragThreshold)return;t="xy-dragstart",n.dragging=r=!0}let d=a.clone();null!==s.ray.intersectPlane(h,a)&&e.object3D.worldToLocal(a),n.el.emit(t,{raycaster:s,point:a,prevPoint:d,prevRay:o,cursorEl:i}),o.copy(s.ray)});n.play();let c=e=>e.target!=t.target&&e.stopPropagation();window.addEventListener("mouseenter",c,!0),window.addEventListener("mouseleave",c,!0);let u=t=>{if(t.detail.cursorEl==i&&(window.removeEventListener("mouseup",u),window.removeEventListener("mouseenter",c,!0),window.removeEventListener("mouseleave",c,!0),n.g=null,r)){if(n.dragging=!1,n.data.preventClick){let t=t=>t.stopPropagation();window.addEventListener("click",t,!0),setTimeout(()=>window.removeEventListener("click",t,!0),0)}setTimeout(()=>d("xy-dragend"),15)}};window.addEventListener("mouseup",u)}}),AFRAME.registerComponent("xy-drag-control",{schema:{target:{type:"selector",default:null},draggable:{default:""},autoRotate:{default:!1},mode:{default:"grab"}},init(){this.m=this.m.bind(this),this.v=[],this.k=new THREE.Quaternion},update(t){let e=this.data.draggable;e!==t.draggable&&(this.remove(),this.v=Array.isArray(e)?e:""!=e?this.el.querySelectorAll(e):[this.el],this.v.forEach(t=>{t.setAttribute("xy-draggable",{}),t.addEventListener("xy-dragstart",this.m),t.addEventListener("xy-drag",this.m)}))},remove(){this.v.forEach(t=>{t.removeAttribute("xy-draggable"),t.removeEventListener("xy-dragstart",this.m),t.removeEventListener("xy-drag",this.m)})},m(t){let{origin:e,direction:i}=t.detail.raycaster.ray,{origin:s,direction:h}=t.detail.prevRay,l=t.detail.cursorEl,a=(this.data.target||this.el).object3D,o=new THREE.Quaternion;l.components["tracked-controls"]?"xy-dragstart"!=t.type?o.copy(this.k).inverse().premultiply(l.object3D.getWorldQuaternion(this.k)):l.object3D.getWorldQuaternion(this.k):o.setFromUnitVectors(h,i);let n=a.parent.worldToLocal(s.clone()),r=a.parent.worldToLocal(e.clone()),d=new THREE.Matrix4,c=(new THREE.Matrix4).makeRotationFromQuaternion(o).multiply(d.makeTranslation(-n.x,-n.y,-n.z)).premultiply(d.makeTranslation(r.x,r.y,r.z));if(a.applyMatrix(c),"pull"==this.data.mode){let t=a.getWorldPosition(new THREE.Vector3),s=i.clone().sub(h),l=2*t.distanceTo(e);a.position.add(i.clone().multiplyScalar(-s.y*l))}if(this.data.autoRotate){let e=this.el.sceneEl.camera.getWorldPosition(new THREE.Vector3),i=a.getWorldPosition(new THREE.Vector3),s=e.clone().sub(i).normalize(),h=.8-s.y*s.y;if(h>0){c.lookAt(e,i,new THREE.Vector3(0,1,0));let s=l.components.raycaster.getIntersection(t.target),n=a.parent.worldToLocal(s?s.point:i),r=a.quaternion.clone();a.quaternion.slerp(o.setFromRotationMatrix(c),.1*h),a.position.sub(n).applyQuaternion(r.inverse().premultiply(a.quaternion)).add(n)}}}}),AFRAME.registerComponent("xywindow",{dependencies:["xycontainer"],schema:{title:{default:""},closable:{default:!0}},init(){let t=this.system.theme,e=this.controls=this.el.appendChild(document.createElement("a-entity"));if(e.setAttribute("position",{x:0,y:0,z:.05}),e.setAttribute("xyitem",{fixed:!0}),(this.R=this.system.createSimpleButton(1,.5,t.windowTitleBar,e)).setAttribute("xy-drag-control",{target:this.el,autoRotate:!0}),this.A=this.R.appendChild(document.createElement("a-entity")),this.data.closable){let i=this.system.createSimpleButton(.5,.5,t.windowCloseButton,e);i.setAttribute("xylabel",{value:"X",align:"center",color:t.buttonLabelColor}),i.addEventListener("click",t=>this.el.parentNode.removeChild(this.el)),this.M=i}this.el.addEventListener("xyresize",t=>{this.update({})}),this.system.registerWindow(this)},remove(){this.system.unregisterWindow(this)},update(t){let e=this.data,i=this.el.components.xyrect,s=0;if(this.M&&(this.M.setAttribute("position",{x:i.width/2-.25,y:.3,z:0}),s+=.52),e.title!=t.title){let t=i.width-s-.2;this.A.setAttribute("xyrect",{width:t,height:.45}),this.A.setAttribute("xylabel",{value:e.title,wrapCount:Math.max(10,t/.2),color:this.system.theme.windowTitleColor,xOffset:.1})}this.controls.setAttribute("position","y",.5*i.height),this.R.setAttribute("geometry","width",i.width-s),this.R.setAttribute("position",{x:-s/2,y:.3,z:0})},setTitle(t){this.el.setAttribute("xywindow","title",t)}}),AFRAME.registerSystem("xywindow",{theme:{buttonColor:"#222",buttonHoverColor:"#333",buttonLabelColor:"#fff",buttonHoverHaptic:.3,buttonHoverHapticMs:10,buttonGeometry:"xy-rounded-rect",windowCloseButton:{color:"#111",hoverColor:"#f00"},windowTitleBar:{color:"#111"},windowTitleColor:"#fff",collidableClass:"collidable"},windows:[],createSimpleButton(t,e,i,s,h){let l=h||document.createElement("a-entity");return l.hasAttribute("geometry")||l.setAttribute("geometry",{primitive:this.theme.buttonGeometry,width:t,height:e}),l.classList.add(this.theme.collidableClass),l.addEventListener("mouseenter",t=>{let e=t.detail.cursorEl.components["tracked-controls"],s=e&&e.controller,h=this.theme;l.setAttribute("material",{color:i.hoverColor||this.theme.buttonHoverColor}),h.buttonHoverHaptic&&s&&s.hapticActuators&&s.hapticActuators.length>0&&s.hapticActuators[0].pulse(h.buttonHoverHaptic,h.buttonHoverHapticMs)}),l.addEventListener("mouseleave",t=>{l.setAttribute("material",{color:i.color||this.theme.buttonColor})}),l.setAttribute("material",{color:i.color||this.theme.buttonColor}),s&&s.appendChild(l),l},registerWindow(t){this.windows.push(t)},unregisterWindow(t){this.windows=this.windows.filter(e=>e!=t)}}),AFRAME.registerComponent("xyrange",{dependencies:["xyrect"],schema:{min:{default:0},max:{default:100},step:{default:0},value:{default:0},color0:{default:"white"},color1:{default:"#06f"},thumbSize:{default:.4}},init(){let t=this.data,e=this.el,i=this.s=this.el.sceneEl.systems.xywindow.createSimpleButton(t.thumbSize,t.thumbSize,{},this.el),s=new THREE.PlaneGeometry(1,.08),h=this.T=new THREE.Mesh(s,new THREE.MeshBasicMaterial({color:t.color0})),l=this.H=new THREE.Mesh(s,new THREE.MeshBasicMaterial({color:t.color1}));l.position.z=.02,e.setObject3D("xyrange",(new THREE.Group).add(h,l)),i.setAttribute("xy-draggable",{base:e}),i.addEventListener("xy-drag",i=>{let s=e.components.xyrect.width-t.thumbSize,h=(i.detail.point.x+s/2)/s*(t.max-t.min);t.step>0&&(h=Math.round(h/t.step)*t.step),this.setValue(h+t.min,!0)}),Object.defineProperty(e,"value",{get:()=>t.value,set:t=>this.setValue(t,!1)})},update(){let t=this.data;if(t.max==t.min)return;let e=this.el.components.xyrect.width-t.thumbSize,i=e*(t.value-t.min)/(t.max-t.min);this.s.setAttribute("geometry","radius",t.thumbSize/2),this.s.setAttribute("position",{x:i-e/2,y:0,z:.04}),this.T.scale.x=e,this.H.scale.x=i||.01,this.H.position.x=(i-e)/2},setValue(t,e){if(!this.s.components["xy-draggable"].dragging||e){let i=this.data,s=Math.max(Math.min(t,i.max),i.min);s!=i.value&&e&&this.el.emit("change",{value:s},!1),this.el.setAttribute("xyrange","value",s)}}}),AFRAME.registerComponent("xyclipping",{dependencies:["xyrect"],schema:{exclude:{type:"selector",default:null},clipTop:{default:!0},clipBottom:{default:!0},clipLeft:{default:!1},clipRight:{default:!1}},init(){this.el.sceneEl.renderer.localClippingEnabled=!0,this.C=[],this.F=[],this._=null,this.S=this.S.bind(this),this.j=["click","mousedown","mouseenter","mouseleave","mousemove"],this.j.forEach(t=>this.el.addEventListener(t,this.S,!0))},update(){let t=this.el.components.xyrect,e=[];this.data.clipBottom&&e.push(new THREE.Plane(new THREE.Vector3(0,1,0),0)),this.data.clipTop&&e.push(new THREE.Plane(new THREE.Vector3(0,-1,0),t.height)),this.data.clipLeft&&e.push(new THREE.Plane(new THREE.Vector3(1,0,0),0)),this.data.clipRight&&e.push(new THREE.Plane(new THREE.Vector3(-1,0,0),t.width)),this.C=e,this.F=[],this.O()},remove(){this.j.forEach(t=>this.el.removeEventListener(t,this.S,!0)),this.F=[],this.applyClippings()},tick(){this.el.object3D.matrixWorld.equals(this._)||this.O()},S(t){if(!(t.path||t.composedPath()).includes(this.data.exclude)&&t.detail.intersection&&this.isClipped(t.detail.intersection.point)&&(t.stopPropagation(),t.detail.cursorEl&&t.detail.cursorEl.components.raycaster)){let e=t.detail.cursorEl.components.raycaster.intersectedEls,i=e.lastIndexOf(t.target);i>=0&&i+1<e.length&&e[i+1].dispatchEvent(new CustomEvent(t.type,t))}},O(){this._=this.el.object3D.matrixWorld.clone(),this.C.forEach((t,e)=>{this.F[e]=t.clone().applyMatrix4(this._)}),this.applyClippings()},applyClippings(){let t=this.data.exclude&&this.data.exclude.object3D,e=i=>{if(i!==t){i.material&&void 0!==i.material.clippingPlanes&&(i.material.clippingPlanes=this.F);for(let t of i.children)e(t)}};e(this.el.object3D)},isClipped(t){return this.F.some(e=>e.distanceToPoint(t)<0)}}),AFRAME.registerComponent("xyscroll",{dependencies:["xyrect"],schema:{scrollbar:{default:!0}},init(){this.$=0,this.B=0,this.K=0,this.I=0,this.L=.2,this.G=this.X(this.el,.3),this.el.setAttribute("xyclipping",{exclude:this.G}),this.el.setAttribute("xy-draggable",{}),this.el.addEventListener("xy-drag",t=>{let e=t.detail.prevPoint.sub(t.detail.point);this.K=0,this.setScroll(this.$+e.x,this.B-e.y)}),this.el.addEventListener("xy-dragend",t=>{this.K=t.detail.point.y-t.detail.prevPoint.y,this.play()}),this.el.addEventListener("xyresize",t=>this.update());for(let t of this.el.children)t!=this.G&&t.addEventListener("xyresize",t=>this.update())},X(t,e){let i=this.el.sceneEl.systems.xywindow,s=t.appendChild(document.createElement("a-entity"));return this.N=s,this.P=i.createSimpleButton(e,.3,{},s),this.P.addEventListener("click",t=>{this.K=.3*-this.V,this.play()}),this.W=i.createSimpleButton(e,.3,{},s),this.W.addEventListener("click",t=>{this.K=.3*this.V,this.play()}),this.Y=i.createSimpleButton(.7*e,this.L,{},s),this.Y.setAttribute("xy-draggable",{base:s}),this.Y.addEventListener("xy-drag",t=>{let e=this.L,i=(this.D-e/2-t.detail.point.y)*Math.max(.01,this.I-this.el.components.xyrect.height)/(this.q-e);this.setScroll(this.$,i)}),s},update(){let t=this.el.components.xyrect,e=t.height;this.N.setAttribute("visible",this.data.scrollbar),this.N.setAttribute("position",{x:t.width+.1,y:0,z:.05}),this.P.setAttribute("position",{x:0,y:e-.15,z:0}),this.W.setAttribute("position",{x:0,y:.15,z:0}),this.V=Math.max(e/2,.5),this.D=e-.3,this.q=e-.6,this.setScroll(0,0)},tick(){Math.abs(this.K)>.001?(this.setScroll(this.$,this.B+this.K),this.K*=.8):this.pause()},setScroll(t,e){let i=this.el.components.xyrect,s=this.el.children,h=0,l=0;for(let t of s)t!==this.G&&(t.components.xyrect||t.setAttribute("xyrect",{}),l=Math.max(l,t.components.xyrect.width),h=Math.max(h,t.components.xyrect.height));this.I=h,this.$=Math.max(0,Math.min(t,l-i.width)),this.B=Math.max(0,Math.min(e,h-i.height));let a=Math.max(.2,Math.min(this.q*i.height/h,this.q)),o=this.D-a/2-(this.q-a)*this.B/Math.max(.01,h-i.height);this.L=a,this.Y.hasAttribute("geometry")&&this.Y.setAttribute("geometry","height",a),this.Y.setAttribute("position","y",o);for(let t of s){if(t===this.G||t.components.xyitem&&t.components.xyitem.data.fixed)continue;let e=t.getAttribute("position"),s=t.components.xyrect;e.x=s.data.pivotX*s.width-this.$,e.y=this.B-(1-s.data.pivotY)*s.height+i.height,t.setAttribute("position",e);let h=s.height-this.B;t.emit("xyviewport",[h,h-i.height,this.$,this.$+i.width],!1)}this.el.components.xyclipping&&this.el.components.xyclipping.applyClippings()}}),AFRAME.registerComponent("xylist",{dependencies:["xyrect"],schema:{itemWidth:{default:-1},itemHeight:{default:-1},vertical:{default:!0}},init(){this.J=null,this.U=null,this.Z=[],this.tt=null,this.itemCount=0,this.el.setAttribute("xyrect",{pivotX:0,pivotY:0}),this.setViewPort([0,0]),this.el.addEventListener("xyviewport",t=>this.setViewPort(t.detail)),this.el.classList.add(this.el.sceneEl.systems.xywindow.theme.collidableClass),this.el.addEventListener("click",t=>{for(let e of t.path||t.composedPath()){let i=e.dataset.listPosition;if(null!=i&&-1!=i){this.el.emit("clickitem",{index:i,ev:t},!1);break}}})},setCallback(t,e){if(this.J=t,this.U=e,this.data.itemHeight<=0){let t=this.J(this.el,this.tt);this.data.itemHeight=1*t.getAttribute("height"),this.data.itemWidth=1*t.getAttribute("width")}},setContents(t,e){this.tt=t,this.itemCount=void 0!==e?e:t.length,this.el.setAttribute("xyrect",{width:this.data.itemWidth,height:this.data.itemHeight*this.itemCount});for(let t of this.Z)t.dataset.listPosition=-1;this.refresh()},setViewPort(t){this.top=t[0],this.bottom=t[1],this.refresh()},refresh(){if(!this.J)return;let t=this.data.itemHeight,e=t*this.itemCount,i=Math.max(Math.floor((e-this.top)/t),0),s=Math.min(Math.ceil((e-this.bottom)/t),this.itemCount),h=s-i+1;for(;h>this.Z.length;){let t=this.J(this.el,this.tt);t.classList.add(this.el.sceneEl.systems.xywindow.theme.collidableClass),this.el.appendChild(t),this.Z.push(t)}let l=!1;for(let e=i;e<s;e++){let i=this.Z[e%this.Z.length];if(i.hasLoaded){if(i.dataset.listPosition!=e){i.dataset.listPosition=e;let s=0,h=(this.itemCount-e-1)*t,l=i.components.xyrect;l&&(s+=l.data.pivotX*l.width,h+=l.data.pivotY*l.height),i.setAttribute("position",{x:s,y:h,z:0}),this.U&&this.U(e,i,this.tt)}}else l=!0}l&&setTimeout(()=>this.refresh(),100);for(let t of this.Z){let e=t.dataset.listPosition;t.setAttribute("visible",e>=i&&e<s)}}}),AFRAME.registerComponent("xycanvas",{schema:{width:{default:100},height:{default:100}},init(){this.canvas=document.createElement("canvas"),this.canvas.id="_CANVAS"+Math.random();let t=new THREE.CanvasTexture(this.canvas);this.updateTexture=(()=>{t.needsUpdate=!0}),this.el.setAttribute("material",{shader:"flat",npot:!0,src:t,transparent:!0})},update(){this.canvas.width=this.data.width,this.canvas.height=this.data.height}}),AFRAME.registerPrimitive("a-xylabel",{defaultComponents:{xyrect:{},xylabel:{}},mappings:{width:"xyrect.width",height:"xyrect.height",value:"xylabel.value",color:"xylabel.color",align:"xylabel.align","wrap-count":"xylabel.wrapCount"}}),AFRAME.registerPrimitive("a-xybutton",{defaultComponents:{xyrect:{width:2,height:.5,updateGeometry:!0},xylabel:{align:"center"},xybutton:{}},mappings:{width:"xyrect.width",height:"xyrect.height",label:"xylabel.value",align:"xylabel.align"}}),AFRAME.registerPrimitive("a-xytoggle",{defaultComponents:{xyrect:{width:.8,height:.4},xytoggle:{}},mappings:{width:"xyrect.width",height:"xyrect.height",value:"xytoggle.value"}}),AFRAME.registerPrimitive("a-xyselect",{defaultComponents:{xyrect:{width:2,height:.5,updateGeometry:!0},xyselect:{}},mappings:{width:"xyrect.width",height:"xyrect.height",values:"xyselect.values",label:"xyselect.label",toggle:"xyselect.toggle",select:"xyselect.select"}}),AFRAME.registerPrimitive("a-xywindow",{defaultComponents:{xycontainer:{alignItems:"stretch"},xywindow:{}},mappings:{width:"xyrect.width",height:"xyrect.height",title:"xywindow.title"}}),AFRAME.registerPrimitive("a-xyscroll",{defaultComponents:{xyrect:{pivotX:0,pivotY:1},xyscroll:{}},mappings:{width:"xyrect.width",height:"xyrect.height",scrollbar:"xyscroll.scrollbar"}}),AFRAME.registerPrimitive("a-xyrange",{defaultComponents:{xyrect:{},xyrange:{}},mappings:{width:"xyrect.width",height:"xyrect.height",min:"xyrange.min",max:"xyrange.max",step:"xyrange.step",value:"xyrange.value"}}),AFRAME.registerComponent("xyinput",{dependencies:["xylabel"],schema:{value:{default:""},type:{default:""},placeholder:{default:""},caretColor:{default:"#0088ff"},bgColor:{default:"white"},virtualKeyboard:{default:"[xykeyboard]"}},init(){let t=this.data,e=this.el,i=e.components.xyrect,s=t=>{let i=this.cursor,s=e.value;this.cursor+=t.length,e.value=s.slice(0,i)+t+s.slice(i)};Object.defineProperty(e,"value",{get:()=>t.value,set:t=>e.setAttribute("xyinput","value",""+t)}),this.et=new THREE.Mesh(new THREE.PlaneGeometry(.04,.9*i.height),new THREE.MeshBasicMaterial({color:t.caretColor})),this.el.object3D.add(this.et),this.et.position.z=.02,e.classList.add("collidable");let h=()=>{e.setAttribute("geometry",{primitive:"xy-rounded-rect",width:i.width,height:i.height})};h(),e.setAttribute("material",{color:t.bgColor}),e.setAttribute("tabindex",0),e.addEventListener("xyresize",h),e.addEventListener("click",i=>{e.focus();let s=document.querySelector(t.virtualKeyboard);s&&s.components.xykeyboard.show(t.type);let h=i.detail.intersection;if(h){let t=h.uv.x,e=0,i=this.el.value.length,s=0;for(;i>e;)this.it(s=e+((i-e+1)/2|0))<t?e=s:i=s-1;this.st(e)}});let l=t=>{t.clipboardData.setData("text/plain",e.value),t.preventDefault()},a=t=>{s(t.clipboardData.getData("text/plain")),t.preventDefault()};e.addEventListener("focus",t=>{this.st(this.cursor),window.addEventListener("copy",l),window.addEventListener("paste",a)}),e.addEventListener("blur",t=>{this.st(this.cursor),window.removeEventListener("copy",l),window.removeEventListener("paste",a)}),e.addEventListener("keypress",t=>{"Enter"!=t.code&&s(t.key)}),e.addEventListener("keydown",t=>{let i=this.cursor,s=e.value;"ArrowLeft"==t.code?i>0&&this.st(i-1):"ArrowRight"==t.code?i<s.length&&this.st(i+1):"Backspace"==t.code&&i>0&&(this.cursor--,e.value=s.slice(0,i-1)+s.slice(i))})},update(t){let e=this.el.value,i=this.cursor;(i>e.length||null==t.value)&&(i=e.length),"password"==this.data.type&&(e=e.replace(/./g,"*")),this.el.setAttribute("xylabel",{color:e?"black":"#aaa",value:e||this.data.placeholder}),this.st(i)},st(t){let e=this.et;this.cursor=t,e.visible=!1,document.activeElement==this.el&&setTimeout(()=>{e.position.x=this.it(t),e.visible=!0},0)},it(t){let{xylabel:e,xyrect:i,text:s}=this.el.components,h=this.el.value,l=0;if(0==t);else if(e.canvas){l=e.canvas.getContext("2d").measureText(h.slice(0,t)).width/e.textWidth}else if(s){let e=s.geometry.layout,i=e.glyphs,a=Math.max(0,t-(h.length-i.length)),o=i[Math.min(a,i.length-1)];l=o?(o.position[0]+o.data.width*(a>=i.length?1:.1))/e.width:0}return(l-.5)*i.width+.04}}),AFRAME.registerComponent("xyime",{schema:{label:{default:null,type:"selector"}},table:{a:"あ",i:"い",u:"う",e:"え",o:"お",ka:"か",ki:"き",ku:"く",ke:"け",ko:"こ",ga:"が",gi:"ぎ",gu:"ぐ",ge:"げ",go:"ご",sa:"さ",si:"し",su:"す",se:"せ",so:"そ",za:"ざ",zi:"じ",zu:"ず",ze:"ぜ",zo:"ぞ",ta:"た",ti:"ち",tu:"つ",te:"て",to:"と",da:"だ",di:"ぢ",du:"づ",de:"で",do:"ど",na:"な",ni:"に",nu:"ぬ",ne:"ね",no:"の",ha:"は",hi:"ひ",hu:"ふ",he:"へ",ho:"ほ",pa:"ぱ",pi:"ぴ",pu:"ぷ",pe:"ぺ",po:"ぽ",ba:"ば",bi:"び",bu:"ぶ",be:"べ",bo:"ぼ",ma:"ま",mi:"み",mu:"む",me:"め",mo:"も",ya:"や",yi:"い",yu:"ゆ",ye:"いぇ",yo:"よ",ra:"ら",ri:"り",ru:"る",re:"れ",ro:"ろ",wa:"わ",wi:"うぃ",wu:"う",we:"うぇ",wo:"を",xa:"ぁ",xi:"ぃ",xu:"ぅ",xe:"ぇ",xo:"ぉ",xya:"ゃ",xyi:"ぃ",xyu:"ゅ",xye:"ぇ",xyo:"ょ",xtu:"っ",nn:"ん",wyi:"ゐ",wye:"ゑ",fu:"ふ",vu:"ヴ",tsu:"つ",chi:"ち",ji:"じ",shi:"し","-":"ー"},init(){this.enable=!1,this.ht="",this.lt=[],this.at=0,this.ot=this.ot.bind(this),document.body.addEventListener("keydown",this.ot,!0),document.body.addEventListener("keypress",this.ot,!0)},remove(){document.body.removeEventListener("keydown",this.ot,!0),document.body.removeEventListener("keypress",this.ot,!0)},async convert(t,e){let i=await fetch(`https://www.google.com/transliterate?langpair=ja-Hira|ja&text=${t},`);e((await i.json())[0][1])},ot(t){if("CapsLock"==t.code&&t.shiftKey||"HiraganaKatakana"==t.key)return this.enable=!this.enable,void this.nt(t.target);if(this.enable&&t.code){if("keypress"==t.type){if(this.lt.length>0){if("Space"==t.code)return this.at=(this.at+1)%this.lt.length,this.rt(this.lt[this.at]),void t.stopPropagation();this.nt(t.target)}if(t.key.match(/^[a-z-]$/)){let e=(this.ht+t.key).replace(/l([aiueo])/g,"x$1").replace(/n([ksthmrwgzbpdjfv])/g,"nn$1").replace(/([ksthmyrwgzbpdjfv])\1/g,"xtu$1").replace(/([kstnhmrgzbpdjf])y([aiueo])/g,"$1ixy$2").replace(/(j|ch|sh)([aueo])/g,"$1ixy$2").replace(/(f|v|ts)([aieo])/g,"$1ux$2");for(let t=0;t<e.length;t++)for(let i=3;i>=0;i--){let s=this.table[e.slice(t,t+i)];if(s){e=e.slice(0,t)+s+e.slice(t+i);break}}this.rt(e)}else if("Space"==t.code&&this.ht)this.convert(this.ht,t=>{this.lt=t,this.at=0,this.rt(t[0])}),this.rt("");else{if(!this.ht)return;this.rt(this.ht+t.key)}}else{if(!this.ht)return;"Enter"==t.code?this.nt(t.target):"Backspace"==t.code&&this.rt(this.ht.slice(0,-1))}t.stopPropagation()}},rt(t){this.ht=t,(this.data.label||this.el).setAttribute("value",t)},nt(t){this.ht&&(t.dispatchEvent(new KeyboardEvent("keypress",{key:this.ht})),this.rt("")),this.lt=[]}}),AFRAME.registerComponent("xykeyboard",{schema:{keySize:{default:.2},ime:{default:!1}},blocks:{main:{size:[11,4],rows:[{offset:[0,3],keys:["qQ!","wW@","eE#","rR$","tT%","yY^","uU&","iI*","oO(","pP)","-_="]},{offset:[0,2],keys:["aA1","sS2","dD3","fF4","gG5","hH`","jJ~","kK+","lL[",":;]"]},{offset:[0,1],keys:[{code:"Shift",symbols:"⇧⬆"},"zZ6","xX7","cC8","vV9","bB0","nN{","mM}",",'<",'.">',"/?\\"]},{offset:[0,0],keys:[{code:"Space",key:" ",label:"_",size:4}]},{offset:[-4.5,0],keys:[{code:"_Fn",label:"#!"},{code:"HiraganaKatakana",label:"あ"}]}]},num:{size:[4,4],rows:[{offset:[0,3],keys:["7","8","9","/"]},{offset:[0,2],keys:["4","5","6","*"]},{offset:[0,1],keys:["1","2","3","-"]},{offset:[0,0],keys:["0",":",".","+"]}]},ctrl:{size:[2,4],rows:[{offset:[0,3],keys:[{code:"Backspace",label:"⌫",size:2}]},{offset:[0,2],keys:[{code:"Space",key:" ",label:"SP",size:2}]},{offset:[0,1],keys:[{code:"Enter",label:"⏎",size:2}]},{offset:[1.3,3.5],keys:[{code:"_Close",label:"x",size:.8}]},{offset:[0,0],keys:[{code:"ArrowLeft",label:"⇦"},{code:"ArrowRight",label:"⇨"}]}]}},show(t){this.hide();let e=this.data.keySize,i=this.data.ime?[]:["HiraganaKatakana"],s=this.blocks;if("number"==t){let t=s.num.size[0]+s.ctrl.size[0];this.dt(s.num,e),this.dt(s.ctrl,e).setAttribute("position","x",(t/2+.4)*e)}else if("full"==t){let t=s.main.size[0]+s.ctrl.size[0];this.dt(s.main,e,i),this.dt(s.ctrl,e,["Space"]).setAttribute("position","x",(t/2+.4)*e),t+=s.ctrl.size[0]+s.num.size[0],this.dt(s.num,e).setAttribute("position","x",(t/2+.8)*e)}else{let t=s.main.size[0]+s.ctrl.size[0];this.dt(s.main,e,i),this.dt(s.ctrl,e,["Space"]).setAttribute("position","x",(t/2+.4)*e)}if(this.data.ime){let t=this.el.appendChild(document.createElement("a-xylabel"));t.setAttribute("xylabel",{color:"yellow",mode:"canvas"}),t.setAttribute("position",{x:0,y:2*e*.95,z:.03}),t.setAttribute("xyrect",{width:8*e,height:.6*e}),t.setAttribute("xyime","")}this.el.setAttribute("xy-drag-control","draggable",".xyinput-close"),this.ct(0)},hide(){for(this.ut=null,this.el.removeAttribute("xy-drag-control");this.el.firstChild;)this.el.removeChild(this.el.firstChild)},dt(t,e,i=[]){let s=document.createElement("a-entity"),h=.3*e;s.setAttribute("geometry",{primitive:"xy-rounded-rect",width:t.size[0]*e+h,height:t.size[1]*e+h}),s.setAttribute("material",{color:"#222233"});for(let h of t.rows){let l=s.appendChild(document.createElement("a-xycontainer"));l.setAttribute("xycontainer",{direction:"row"}),l.setAttribute("position",{x:h.offset[0]*e,y:h.offset[1]*e-(t.size[1]-1)*e/2,z:.02});for(let t of h.keys){if(i.includes(t.code))continue;let s=l.appendChild(document.createElement("a-xybutton"));s.setAttribute("material","visible",!1),s.setAttribute("xylabel",{value:t.label||"",align:"center"}),s.setAttribute("xyrect",{width:(t.size||1)*e,height:e}),s.addEventListener("mouseenter",t=>s.setAttribute("material","visible",!0)),s.addEventListener("mouseleave",t=>s.setAttribute("material","visible",!1)),(t.symbols||"string"==typeof t)&&(s.classList.add("xyinput-key"),s.dataset.keySymbols=t.symbols||t),"_Close"==t.code&&(s.classList.add("xyinput-close"),s.addEventListener("click",t=>this.hide())),s.addEventListener("mousedown",e=>{if(document.activeElement==document.body&&this.ut&&this.ut.focus(),this.ut=document.activeElement,setTimeout(()=>this.ut.focus(),0),e.preventDefault(),"_Fn"!=t.code){if("Shift"==t.code&&this.ct((this.yt+1)%2),document.activeElement!=document.body){let e=t.code?t.key:t,i={key:e?e[this.yt]||e[0]:t.code,code:t.code||t[0].toUpperCase()};document.activeElement.dispatchEvent(new KeyboardEvent("keydown",i)),e&&document.activeElement.dispatchEvent(new KeyboardEvent("keypress",i))}}else this.ct(2==this.yt?0:2)})}}return this.el.appendChild(s)},ct(t){this.yt=t;for(let e of this.el.querySelectorAll(".xyinput-key")){let i=e.dataset.keySymbols;e.setAttribute("xylabel","value",i[t]||i[0])}}}),AFRAME.registerPrimitive("a-xykeyboard",{defaultComponents:{xykeyboard:{},rotation:{x:-20,y:0,z:0}},mappings:{ime:"xykeyboard.ime","key-size":"xykeyboard.keySize"}}),AFRAME.registerPrimitive("a-xyinput",{defaultComponents:{xyrect:{width:2,height:.5},xyinput:{}},mappings:{width:"xyrect.width",height:"xyrect.height",value:"xyinput.value",type:"xyinput.type",placeholder:"xyinput.placeholder","caret-color":"xyinput.caretColor","background-color":"xyinput.bgColor"}}),AFRAME.registerComponent("xycontainer",{dependencies:["xyrect"],schema:{spacing:{default:0},padding:{default:0},reverse:{default:!1},wrap:{default:"nowrap",oneOf:["wrap","nowrap"]},direction:{default:"column",oneOf:["none","row","column","vertical","horizontal"]},alignItems:{default:"none",oneOf:["none","center","start","end","baseline","stretch"]},justifyItems:{default:"start",oneOf:["center","start","end","space-between","space-around","stretch"]},alignContent:{default:"",oneOf:["","none","start","end","center","stretch"]}},init(){this.el.addEventListener("xyresize",t=>this.layout()),this.layout()},layout(){let t=this.data,e=t&&t.direction;if(!e||"none"==e)return;let i=this.el.components.xyrect,s=this.el.children,h="vertical"==e||"column"==e,l=t.padding,a=t.spacing,o=t.reverse^h?-1:1,n=h?[0,1,o,0]:[o,0,0,-1],r=h?(t,e)=>[e,t]:(t,e)=>[t,e],d=r(i.width-2*l,i.height-2*l),c=r("width","height"),u=0,y=0,x=[],f=[],p=0,g=0,m=0,w=0,b=()=>{u=Math.max(u,p+a*(f.length-1)),y+=w,x.push([f,p,g,m,w]),f=[],p=0,g=0,m=0,w=0};for(let e of s){let i=e.getAttribute("xyitem");if(i&&i.fixed)continue;let s=e.components.xyrect||e.getAttribute("geometry")||{width:1*(e.getAttribute("width")||void 0),height:1*(e.getAttribute("height")||void 0)},h=e.getAttribute("scale")||{x:1,y:1},l={el:e,xyitem:i,size:r(s.width,s.height),pivot:r(s.data?s.data.pivotX:.5,s.data?s.data.pivotY:.5),scale:r(h.x,h.y)};if(null==l.size[0]||isNaN(l.size[0]))continue;let o=l.size[0]*l.scale[0];"wrap"==t.wrap&&p>0&&p+o+a*f.length>d[0]&&b(),f.push(l),p+=o,g+=i?i.grow:1,m+=i?i.shrink:1,w=l.size[1]>w?l.size[1]:w}f.length>0&&b(),y+=a*(x.length-1),-1==i.data[c[0]]&&(d[0]=u,i[c[0]]=u+2*l),-1==i.data[c[1]]&&(d[1]=y,i[c[1]]=y+2*l);let E=r(i.data.pivotX,i.data.pivotY),v=-E[1]*d[1],k=-(h?1-E[0]:E[0])*d[0],R=0,A=t.alignContent||t.alignItems;"end"==A?v+=d[1]-y:"center"==A?v+=(d[1]-y)/2:"stretch"!=A&&"none"!=A||(R=(d[1]-y)/x.length);for(let[t,e,i,s,h]of x)this.xt(t,e,i,s,k,v,d[0],h+R,n,c),v+=h+R+a},xt(t,e,i,s,h,l,a,o,n,r){let{justifyItems:d,alignItems:c,spacing:u}=this.data,y=0,x=t.length;"center"===d?h+=(a-e-u*x)/2:"end"===d?h+=a-e-u*x:"stretch"===d?y=(y=a-e-u*(x-1))>0?i>0?y/i:0:s>0?y/s:0:"space-between"===d?u=(a-e)/(x-1):"space-around"===d&&(h+=.5*(u=(a-e)/x));for(let e of t){let t=e.el,i=e.xyitem,[s,a]=e.pivot,[d,x]=e.scale,[f,p]=e.size,g=i&&i.align||c,m=(i?y>0?i.grow:i.shrink:1)*y,w=f*d+m,b=h+s*w,E=l+.5*o,v=t.getAttribute("position")||{x:0,y:0,z:0};d>0&&0!=m&&t.setAttribute(r[0],f+m/d),x>0&&"stretch"===g&&t.setAttribute(r[1],(p=o)/x),"start"===g||"stretch"===g?E=l+a*p:"end"===g?E=l+o-(1-a)*p:"center"===g?E+=(a-.5)*p:"none"===g&&(E+=n[1]*v.x+n[3]*v.y),v.x=n[0]*b+n[1]*E,v.y=n[2]*b+n[3]*E,t.setAttribute("position",v),h+=w+u}}}),AFRAME.registerComponent("xyitem",{schema:{align:{default:"none",oneOf:["none","center","start","end","baseline","stretch"]},grow:{default:1},shrink:{default:1},fixed:{default:!1}},update(t){if(void 0!==t.align){let t=this.el.parent.components.xycontainer;t&&t.layout()}}}),AFRAME.registerComponent("xyrect",{schema:{width:{default:-1},height:{default:-1},pivotX:{default:.5},pivotY:{default:.5},updateGeometry:{default:!1}},update(t){let e=this.el,{width:i,height:s,updateGeometry:h}=this.data,l=e.getAttribute("geometry")||{};this.width=i<0?1*(e.getAttribute("width")||l.width||0):i,this.height=s<0?1*(e.getAttribute("height")||l.height||0):s,void 0!==t.width&&(e.emit("xyresize",{xyrect:this},!1),h&&e.setAttribute("geometry",{width:i,height:s}))}}),AFRAME.registerPrimitive("a-xycontainer",{defaultComponents:{xyrect:{},xycontainer:{}},mappings:{width:"xyrect.width",height:"xyrect.height",direction:"xycontainer.direction",spacing:"xycontainer.spacing",padding:"xycontainer.padding",reverse:"xycontainer.reverse",wrap:"xycontainer.wrap","align-items":"xycontainer.alignItems","justify-items":"xycontainer.justifyItems"}});